/*! Copyright 2026 Adobe
All Rights Reserved. */
import{jsx as v,jsxs as D}from"@dropins/tools/preact-jsx-runtime.js";import{AlertBanner as rr}from"@dropins/tools/components.js";import{Q as er,a as tr}from"../chunks/QuickOrderDisabledOverlay.js";import{classes as j}from"@dropins/tools/lib.js";import{useState as R,useRef as J,useCallback as A,useEffect as q}from"@dropins/tools/preact-hooks.js";import{events as S}from"@dropins/tools/event-bus.js";import{useText as z}from"@dropins/tools/i18n.js";import{c as nr}from"../chunks/initialize.js";import"@dropins/tools/preact-compat.js";import"@dropins/tools/fetch-graphql.js";const ir=["sku","parentSku","quantity","optionsUIDs","valid","productType"],sr=t=>{const r=[],e=[];return t.forEach((n,a)=>{if(ir.includes(a))return;const i=n;i&&i.match(/^[A-Za-z0-9+/=]+$/)?r.push(i):e.push({uid:a,value:i})}),{optionUIDs:r,enteredOptions:e}},or=t=>{const r=Number(t.get("quantity")),e=!r||r<1?1:r,n={sku:t.get("sku"),quantity:e},a=t.get("parentSku");a&&(n.parentSku=a);const{optionUIDs:i,enteredOptions:o}=sr(t);return i.length>0&&(n.optionsUIDs=i),o.length>0&&(n.enteredOptions=o),n},M={sku:"",quantity:1,name:"",images:[],inStock:!1,addToCartAllowed:!1,isBundle:!1,prices:{},attributes:[],options:[],url:"",urlKey:"",externalId:"",productType:"simple",shortDescription:"",metaDescription:"",metaKeyword:"",metaTitle:"",description:""},L=(t,r)=>!r||!Array.isArray(r)?t.map(e=>({...M,sku:e.sku,quantity:e.quantity??1})):t.map(e=>{const n=r.find(a=>(a==null?void 0:a.sku)===(e==null?void 0:e.sku));return n?{...n,...e.variantSku&&{variantSku:e.variantSku},quantity:e.quantity??1}:{...M,sku:e.sku,...e.variantSku&&{variantSku:e.variantSku},quantity:e.quantity??1}}),P=t=>t.length===0?!1:t.every(r=>!((r.urlKey||r.url)&&r.name)||r.inStock===!1?!1:r.options&&r.options.length>0?r.options.some(i=>i.required)?r.options.every(i=>{var o;return i.required?(o=i.items)==null?void 0:o.some(d=>d.selected):!0}):r.options.some(i=>i.items&&i.items.length>0&&i.items.some(o=>o.selected===!0)):!0),_=t=>{const r=[];return t.forEach(e=>{if(!((e.urlKey||e.url)&&e.name)){r.push({sku:e.sku,name:e.name||"Unknown",reason:"incomplete_data"});return}if(e.inStock===!1){r.push({sku:e.sku,name:e.name,reason:"out_of_stock"});return}if(e.options&&e.options.length>0){if(e.options.some(o=>o.required)){e.options.every(d=>{var I;return d.required?(I=d.items)==null?void 0:I.some(Q=>Q.selected):!0})||r.push({sku:e.sku,name:e.name,reason:"missing_required_options"});return}e.options.some(o=>o.items&&o.items.length>0&&o.items.some(d=>d.selected===!0))||r.push({sku:e.sku,name:e.name,reason:"missing_options"})}}),r},C=t=>`quick-order-item-${t.id||t.variantSku||t.sku}`,K=t=>`${t}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,W=(t,r)=>t.findIndex(e=>r.variantSku&&e.variantSku?e.variantSku===r.variantSku:e.variantSku&&!r.variantSku&&r.sku?e.variantSku===r.sku:r.variantSku&&!e.variantSku&&e.sku?e.sku===r.variantSku:!r.variantSku&&!e.variantSku?e.sku===r.sku:!1),ar=(t,r,e)=>t.findIndex(n=>n.id===e?!1:r.variantSku&&n.variantSku?n.variantSku===r.variantSku:r.variantSku&&!n.variantSku&&n.sku?n.sku===r.variantSku:!1),ur=(t,r,e,n=1)=>t.map((a,i)=>i===e?{...a,quantity:a.quantity+n}:i===r?null:a).filter(Boolean),cr=(t,r,e)=>{const n=[...t],a=[],i=[],o=[];return r.forEach((d,I)=>{const Q=e[I];if(Q!=null&&Q.replaceItemSku){const f=n.findIndex(h=>h.sku===Q.replaceItemSku||h.id===Q.replaceItemSku);if(f!==-1){const h=W(n,d);if(h!==-1&&h!==f){n.splice(f,1);const O=h>f?h-1:h;n[O]={...n[O],quantity:n[O].quantity+d.quantity},o.push(n[O])}else{const O={...d,id:K(d.sku)};n[f]=O,i.push(O)}return}}const g=W(n,d);if(g!==-1)n[g]={...n[g],quantity:n[g].quantity+d.quantity},o.push(n[g]);else{const f={...d,id:K(d.sku)};n.push(f),a.push(f)}}),{updatedItems:n,addedItems:a,replacedItems:i,mergedItems:o}},dr=(t,r,e,n=1)=>{const a=r?ar(t,e,r):-1;if(a!==-1){const o=t.findIndex(d=>d.id===r);return{updatedItems:ur(t,o,a,n),wasMerged:!0,mergedIntoIndex:a}}return{updatedItems:t.map(o=>r&&o.id===r?{...o,...e,id:r}:!r&&o.sku===e.sku?{...o,...e}:o),wasMerged:!1}},lr=t=>t.map(r=>{const e=r.id||r.sku,n=document.forms[`form-${e}`];if(!n)return null;const a=new FormData(n);return a.get("valid")==="true"?or(a):null}),kr=t=>{let r=[];return t&&typeof t=="object"?t.optionsUIDs&&Array.isArray(t.optionsUIDs)?r=t.optionsUIDs:Array.isArray(t)&&(r=t):typeof t=="string"&&(r=[t]),r},G=t=>{try{const r=localStorage.getItem(t);if(r)return JSON.parse(r)}catch(r){console.error("Error reading from localStorage:",r)}return{}},fr=(t,r,e)=>{if(e.length!==0)try{const n=G(t);n[r]=e,localStorage.setItem(t,JSON.stringify(n))}catch(n){console.error("Error saving to localStorage:",n)}},pr=(t,r,e)=>t.map(n=>{const a=r.find(i=>n.sku===i.sku||n.sku===i.variantSku);if(a){const i=a.id||a.sku,o=e[i];if(o&&o.length>0)return{...n,optionsUIDs:o}}return n}),mr=t=>{const r=!t.inStock||!t.addToCartAllowed;if(t.options&&t.options.length>0){if(t.options.some(i=>!i.items||i.items.length===0))return!0;if(t.options.some(i=>i.required)){const i=t.options.every(o=>{var d;return o.required?(d=o.items)==null?void 0:d.some(I=>I.selected):!0});return r||!i}const a=t.options.some(i=>i.items&&i.items.length>0&&i.items.some(o=>o.selected===!0));return r||!a}return r},gr=({getProductsData:t,handleAddToCart:r}={})=>{const[e,n]=R([]),[a,i]=R(!1),[o,d]=R(new Set),[I,Q]=R(!1),[g,f]=R(null),[h,O]=R([]),T=J([]),y=z({validationError:"QuickOrder.QuickOrderItem.notification.validationError",backendError:"QuickOrder.QuickOrderItem.notification.backendError",success:"QuickOrder.QuickOrderItem.notification.success",partialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",unexpectedError:"QuickOrder.QuickOrderItem.notification.unexpectedError"}),B="quick-order-selected-options",$=A(()=>{f(null)},[]),b=A(u=>{Q(u)},[]);q(()=>{const u=S.on("quick-order/loading",s=>{i(s)},{eager:!0});return()=>{u==null||u.off()}},[]),q(()=>{const u=S.on("quick-order/add-items",async s=>{if(s&&s.length>0){if(!t)return;i(!0),S.emit("quick-order/loading",!0);const k=s.map(c=>c.sku).filter(Boolean);d(c=>new Set([...Array.from(c),...k]));try{let c=[];try{const p=await t(s);b(s.length!==p.length),c=L(s,p)}catch(p){console.error("Error fetching products data:",p),c=L(s,[])}const l=_(c);if(l.length>0){const p=l.map(m=>m.sku);f(m=>{if((m==null?void 0:m.type)==="validation"&&m.clickableSkus){const U=[...new Set([...m.clickableSkus,...p])];return{...m,clickableSkus:U}}return{type:"validation",variant:"warning",message:y.validationError,clickableSkus:p}})}n(p=>{const{updatedItems:m,addedItems:U,mergedItems:H,replacedItems:X}=cr(p,c,s);return X.forEach(E=>{const N=C(E);S.emit(`${N}/pdp/data`,E)}),H.forEach(E=>{const N=C(E);S.emit(`${N}/pdp/data`,E)}),U.forEach(E=>{const N=C(E);S.emit(`${N}/pdp/data`,E)}),m})}finally{i(!1),S.emit("quick-order/loading",!1),d(c=>new Set(Array.from(c).filter(l=>!k.includes(l))))}}},{eager:!0});return()=>{u==null||u.off()}},[t,b]),q(()=>{const u=e.map(s=>{const k=C(s),c=s.id;return S.on(`${k}/pdp/data`,l=>{n(p=>dr(p,c||"",l,s.quantity||1).updatedItems)})});return()=>{u==null||u.forEach(s=>{s==null||s.off()})}},[e]),q(()=>{const u=P(e);b(!u)},[e,b]),q(()=>{if(g&&g.clickableSkus&&g.clickableSkus.length>0){const u=g.clickableSkus.filter(s=>{const k=e.find(c=>c.sku===s||c.variantSku===s);return k?mr(k):!1});u.length===0?f(null):u.length!==g.clickableSkus.length&&f({...g,clickableSkus:u})}},[e,g]),q(()=>{const u=e.map(s=>{const k=C(s),c=s.id||s.sku;return S.on(`${k}/pdp/values`,l=>{const p=kr(l);fr(B,c,p)})});return()=>{u.forEach(s=>{s==null||s.off()})}},[e,B]),q(()=>{T.current=h},[h]),q(()=>{const u=S.on("cart/product/added",k=>{const c=Array.isArray(k)?k.length:0,l=Array.isArray(k)?k.map(p=>p.sku).filter(Boolean):[];if(h.length>0){const p=h.filter(m=>!l.includes(m));p.length>0&&c>0&&(f({type:"partial-success",variant:"warning",message:y.partialSuccess,count:c,clickableSkus:p}),O([]))}else return}),s=S.on("quick-order/add-to-cart-error",k=>{f({type:"backend-error",variant:"warning",message:y.backendError,details:k.message}),O([])});return()=>{u==null||u.off(),s==null||s.off()}},[h]),q(()=>{const u=S.on("cart/data",s=>{if(T.current.length===0||!(s!=null&&s.items)||s.items.length===0)return;const k=s.items.map(l=>l.sku).filter(Boolean),c=T.current.filter(l=>k.includes(l));c.length!==0&&(f({type:"success",variant:"success",message:y.success,count:c.length}),O([]),S.emit("quick-order/loading",!1))},{eager:!0});return()=>{u==null||u.off()}},[]);const x=A(u=>{n(s=>s.filter(k=>k.id!==u&&k.sku!==u))},[]),F=A(()=>{n([]),f(null)},[]),V=A((u,s)=>{n(k=>k.map(c=>c.sku===u?{...c,quantity:s}:c))},[]),w=A(u=>o.has(u),[o]),Z=A(()=>{const u=lr(e).filter(l=>l!==null);if(e.length>0&&!P(e)){const m=_(e).map(U=>U.sku);f({type:"validation",variant:"warning",message:y.validationError,clickableSkus:m});return}if(u.length===0){if(e.length>0){const p=_(e).map(m=>m.sku);f({type:"validation",variant:"warning",message:y.validationError,clickableSkus:p})}return}f(null);const s=u.map(l=>l.sku).filter(l=>!!l);O(s);const k=G(B),c=pr(u,e,k);r?(S.emit("quick-order/loading",!0),Promise.resolve(r(c)).then(l=>{l&&typeof l=="string"&&(f({type:"backend-error",variant:"warning",message:y.backendError,details:l}),O([]))}).catch(l=>{f({type:"backend-error",variant:"warning",message:y.backendError,details:l.message||y.unexpectedError}),O([])}).finally(()=>{S.emit("quick-order/loading",!1)})):S.emit("quick-order/add-to-cart",c)},[e,r,B]);return{items:e,loading:a,removeItem:x,clearItems:F,updateItemQuantity:V,addToCart:Z,isItemUpdating:w,isDisabledButton:I,setDisabledCartButton:b,notification:g,dismissNotification:$}},hr=({notification:t,onDismiss:r,onSkuClick:e,validationErrorText:n,backendErrorText:a,successText:i,partialSuccessText:o})=>{if(!t)return null;const d=()=>{switch(t.type){case"validation":return Or(n,t.clickableSkus,t.details,e);case"partial-success":return Sr(o,t.message,t.count,t.clickableSkus,e);case"backend-error":return Ir(a,t.details);case"success":return Qr(i,t.count);default:return v("span",{children:t.message})}};return v("div",{className:j(["b2b-quick-order-notification-banner",[`b2b-quick-order-notification-banner--${t.variant}`,t.variant]]),children:v(rr,{variant:t.variant,message:d(),onDismiss:r})})};function Y(t,r){return t.map((e,n)=>D("span",{children:[v("a",{href:"#",onClick:a=>{a.preventDefault(),r(e)},style:{cursor:"pointer",textDecoration:"underline",color:"white"},children:e}),n<t.length-1?", ":""]},e))}function Or(t,r,e,n){return r!=null&&r.length&&n?D("span",{children:[t," - ",Y(r,n)]}):D("span",{children:[t," - ",e]})}function Sr(t,r,e,n,a){if(!t)return v("span",{children:r});const i=t.replace("{count}",String(e||0)).replace("{total}",String((e||0)+((n==null?void 0:n.length)||0)));return n!=null&&n.length&&a?D("span",{children:[i,": ",Y(n,a)]}):D("span",{children:[i,": ",(n==null?void 0:n.join(", "))||"Unknown"]})}function Ir(t,r){return D("span",{children:[t,r?` - ${r}`:""]})}function Qr(t,r){return r!==void 0?v("span",{children:t.replace("{count}",String(r))}):v("span",{children:t})}const Ur=({className:t,slots:r,getProductsData:e,handleAddToCart:n,productsSearch:a,searchFilter:i})=>{const o=nr.getConfig().quickOrderActive,d=J(null),I=z({title:"QuickOrder.QuickOrderItem.title",quantity:"QuickOrder.QuickOrderItem.quantity",price:"QuickOrder.QuickOrderItem.price",remove:"QuickOrder.QuickOrderItem.remove",removeItem:"QuickOrder.QuickOrderItem.removeItem",showOptions:"QuickOrder.QuickOrderItem.showOptions",hideOptions:"QuickOrder.QuickOrderItem.hideOptions",additionalOptions:"QuickOrder.QuickOrderItem.additionalOptions",noAdditionalOptions:"QuickOrder.QuickOrderItem.noAdditionalOptions",emptyList:"QuickOrder.QuickOrderItem.emptyList",sku:"QuickOrder.QuickOrderItem.sku",loading:"QuickOrder.QuickOrderItem.loading",productNotFound:"QuickOrder.QuickOrderItem.productNotFound",productNotFoundDescription:"QuickOrder.QuickOrderItem.productNotFoundDescription",productOptions:"QuickOrder.QuickOrderItem.productOptions",configurableProductError:"QuickOrder.QuickOrderItem.configurableProductError",configurableProductErrorDescription:"QuickOrder.QuickOrderItem.configurableProductErrorDescription",addAllToCart:"QuickOrder.QuickOrderItem.addAllToCart",configurableOptionsWarning:"QuickOrder.QuickOrderItem.configurableOptionsWarning",configurableOptionsWarningDescription:"QuickOrder.QuickOrderItem.configurableOptionsWarningDescription",outOfStock:"QuickOrder.QuickOrderItem.outOfStock",searchPlaceholder:"QuickOrder.Search.placeholder",searchAriaLabel:"QuickOrder.Search.ariaLabel",searchEmptyState:"QuickOrder.Search.emptyState",resultsAvailable:"QuickOrder.Search.resultsAvailable",resultAvailable:"QuickOrder.Search.resultAvailable",srInstructions:"QuickOrder.Search.srInstructions",notificationValidationError:"QuickOrder.QuickOrderItem.notification.validationError",notificationBackendError:"QuickOrder.QuickOrderItem.notification.backendError",notificationSuccess:"QuickOrder.QuickOrderItem.notification.success",notificationPartialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",disabledMessage:"QuickOrder.QuickOrderItem.disabledMessage"}),{items:Q,loading:g,removeItem:f,clearItems:h,updateItemQuantity:O,addToCart:T,isItemUpdating:y,setDisabledCartButton:B,isDisabledButton:$,notification:b,dismissNotification:x}=gr({getProductsData:e,handleAddToCart:n});q(()=>{b&&b.variant==="warning"&&d.current&&d.current.scrollIntoView({behavior:"smooth",block:"start"})},[b]);const F=V=>{const w=document.querySelector(`form[data-sku="${V}"]`);w&&w.scrollIntoView({behavior:"smooth",block:"center"})};return D("div",{className:j(["b2b-quick-order-quick-order-items",!o&&"b2b-quick-order-disabled",t]),"data-testid":"quick-order-items",style:{position:"relative"},children:[v("div",{ref:d,children:v(hr,{notification:b,onDismiss:x,onSkuClick:F,validationErrorText:I.notificationValidationError,backendErrorText:I.notificationBackendError,successText:I.notificationSuccess,partialSuccessText:I.notificationPartialSuccess})}),v(er,{isDisabled:!o,message:I.disabledMessage,children:v(tr,{t:I,items:Q,onRemove:f,clearItems:h,onUpdateQuantity:O,handleAddToCart:T,isItemUpdating:y,slots:r,loading:g,setDisabledCartButton:B,isDisabledButton:$,productsSearch:a,searchFilter:i})})]})};export{Ur as QuickOrderItems,Ur as default};
//# sourceMappingURL=QuickOrderItems.js.map
