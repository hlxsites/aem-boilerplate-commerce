/*! Copyright 2026 Adobe
All Rights Reserved. */
import{jsx as b,jsxs as D}from"@dropins/tools/preact-jsx-runtime.js";import{AlertBanner as rr}from"@dropins/tools/components.js";import{Q as er,a as tr}from"../chunks/QuickOrderDisabledOverlay.js";import{classes as j}from"@dropins/tools/lib.js";import{useState as R,useRef as J,useCallback as A,useEffect as Q}from"@dropins/tools/preact-hooks.js";import{events as I}from"@dropins/tools/event-bus.js";import{useText as z}from"@dropins/tools/i18n.js";import"@dropins/tools/preact-compat.js";import{c as nr}from"../chunks/initialize.js";import"@dropins/tools/fetch-graphql.js";const sr=["sku","parentSku","quantity","optionsUIDs","valid","productType"],ir=t=>{const e=[],r=[];return t.forEach((n,u)=>{if(sr.includes(u))return;const s=n;s&&s.match(/^[A-Za-z0-9+/=]+$/)?e.push(s):r.push({uid:u,value:s})}),{optionUIDs:e,enteredOptions:r}},or=t=>{const e=Number(t.get("quantity")),r=!e||e<1?1:e,n={sku:t.get("sku"),quantity:r},u=t.get("parentSku");u&&(n.parentSku=u);const{optionUIDs:s,enteredOptions:o}=ir(t);return s.length>0&&(n.optionsUIDs=s),o.length>0&&(n.enteredOptions=o),n},_={sku:"",quantity:1,name:"",images:[],inStock:!1,addToCartAllowed:!1,isBundle:!1,prices:{},attributes:[],options:[],url:"",urlKey:"",externalId:"",productType:"simple",shortDescription:"",metaDescription:"",metaKeyword:"",metaTitle:"",description:""},L=(t,e)=>!e||!Array.isArray(e)?t.map(r=>({..._,sku:r.sku,quantity:r.quantity??1})):t.map(r=>{const n=e.find(u=>(u==null?void 0:u.sku)===(r==null?void 0:r.sku));return n?{...n,...r.variantSku&&{variantSku:r.variantSku},quantity:r.quantity??1}:{..._,sku:r.sku,...r.variantSku&&{variantSku:r.variantSku},quantity:r.quantity??1}}),P=t=>t.length===0?!1:t.every(e=>!((e.urlKey||e.url)&&e.name)||e.inStock===!1?!1:e.options&&e.options.length>0?e.options.some(s=>s.required)?e.options.every(s=>{var o;return s.required?(o=s.items)==null?void 0:o.some(l=>l.selected):!0}):e.options.some(s=>s.items&&s.items.length>0&&s.items.some(o=>o.selected===!0)):!0),$=t=>{const e=[];return t.forEach(r=>{if(!((r.urlKey||r.url)&&r.name)){e.push({sku:r.sku,name:r.name||"Unknown",reason:"incomplete_data"});return}if(r.inStock===!1){e.push({sku:r.sku,name:r.name,reason:"out_of_stock"});return}if(r.options&&r.options.length>0){if(r.options.some(o=>o.required)){r.options.every(l=>{var g;return l.required?(g=l.items)==null?void 0:g.some(y=>y.selected):!0})||e.push({sku:r.sku,name:r.name,reason:"missing_required_options"});return}r.options.some(o=>o.items&&o.items.length>0&&o.items.some(l=>l.selected===!0))||e.push({sku:r.sku,name:r.name,reason:"missing_options"})}}),e},w=t=>`quick-order-item-${t.id||t.variantSku||t.sku}`,K=t=>`${t}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,W=(t,e)=>t.findIndex(r=>e.variantSku&&r.variantSku?r.variantSku===e.variantSku:r.variantSku&&!e.variantSku&&e.sku?r.variantSku===e.sku:e.variantSku&&!r.variantSku&&r.sku?r.sku===e.variantSku:!e.variantSku&&!r.variantSku?r.sku===e.sku:!1),ar=(t,e,r)=>t.findIndex(n=>n.id===r?!1:e.variantSku&&n.variantSku?n.variantSku===e.variantSku:e.variantSku&&!n.variantSku&&n.sku?n.sku===e.variantSku:!1),ur=(t,e,r,n=1)=>t.map((u,s)=>s===r?{...u,quantity:u.quantity+n}:s===e?null:u).filter(Boolean),cr=(t,e,r)=>{const n=[...t],u=[],s=[],o=[];return e.forEach((l,g)=>{const y=r[g];if(y!=null&&y.replaceItemSku){const f=n.findIndex(O=>O.sku===y.replaceItemSku||O.id===y.replaceItemSku);if(f!==-1){const O=W(n,l);if(O!==-1&&O!==f){n.splice(f,1);const S=O>f?O-1:O;n[S]={...n[S],quantity:n[S].quantity+l.quantity},o.push(n[S])}else{const S={...l,id:K(l.sku)};n[f]=S,s.push(S)}return}}const m=W(n,l);if(m!==-1)n[m]={...n[m],quantity:n[m].quantity+l.quantity},o.push(n[m]);else{const f={...l,id:K(l.sku)};n.push(f),u.push(f)}}),{updatedItems:n,addedItems:u,replacedItems:s,mergedItems:o}},dr=(t,e,r,n=1)=>{const u=e?ar(t,r,e):-1;if(u!==-1){const o=t.findIndex(l=>l.id===e);return{updatedItems:ur(t,o,u,n),wasMerged:!0,mergedIntoIndex:u}}return{updatedItems:t.map(o=>e&&o.id===e?{...o,...r,id:e}:!e&&o.sku===r.sku?{...o,...r}:o),wasMerged:!1}},lr=t=>t.map(e=>{const r=e.id||e.sku,n=document.forms[`form-${r}`];if(!n)return null;const u=new FormData(n);return u.get("valid")==="true"?or(u):null}),kr=t=>{let e=[];return t&&typeof t=="object"?t.optionsUIDs&&Array.isArray(t.optionsUIDs)?e=t.optionsUIDs:Array.isArray(t)&&(e=t):typeof t=="string"&&(e=[t]),e},G=t=>{try{const e=localStorage.getItem(t);if(e)return JSON.parse(e)}catch(e){console.error("Error reading from localStorage:",e)}return{}},fr=(t,e,r)=>{if(r.length!==0)try{const n=G(t);n[e]=r,localStorage.setItem(t,JSON.stringify(n))}catch(n){console.error("Error saving to localStorage:",n)}},pr=(t,e,r)=>t.map(n=>{const u=e.find(s=>n.sku===s.sku||n.sku===s.variantSku);if(u){const s=u.id||u.sku,o=r[s];if(o&&o.length>0)return{...n,optionsUIDs:o}}return n}),mr=t=>{const e=!t.inStock||!t.addToCartAllowed;if(t.options&&t.options.length>0){if(t.options.some(s=>!s.items||s.items.length===0))return!0;if(t.options.some(s=>s.required)){const s=t.options.every(o=>{var l;return o.required?(l=o.items)==null?void 0:l.some(g=>g.selected):!0});return e||!s}const u=t.options.some(s=>s.items&&s.items.length>0&&s.items.some(o=>o.selected===!0));return e||!u}return e},hr=({getProductsData:t,handleAddToCart:e}={})=>{const[r,n]=R([]),[u,s]=R(!1),[o,l]=R(new Set),[g,y]=R(!1),[m,f]=R(null),[O,S]=R([]),C=J([]),v=z({validationError:"QuickOrder.QuickOrderItem.notification.validationError",backendError:"QuickOrder.QuickOrderItem.notification.backendError",success:"QuickOrder.QuickOrderItem.notification.success",partialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",unexpectedError:"QuickOrder.QuickOrderItem.notification.unexpectedError"}),B="quick-order-selected-options",x=A(()=>{f(null)},[]),q=A(a=>{y(a)},[]);Q(()=>{const a=I.on("quick-order/loading",i=>{s(i)},{eager:!0});return()=>{a==null||a.off()}},[]),Q(()=>{const a=I.on("quick-order/add-items",async i=>{if(i&&i.length>0){if(!t)return;s(!0),I.emit("quick-order/loading",!0);const k=i.map(d=>d.sku).filter(Boolean);l(d=>new Set([...Array.from(d),...k]));try{let d=[];try{const p=await t(i);q(i.length!==p.length),d=L(i,p)}catch(p){console.error("Error fetching products data:",p),d=L(i,[])}const c=$(d);if(c.length>0){const p=c.map(h=>h.sku);f(h=>{if((h==null?void 0:h.type)==="validation"&&h.clickableSkus){const T=[...new Set([...h.clickableSkus,...p])];return{...h,clickableSkus:T}}return{type:"validation",variant:"warning",message:v.validationError,clickableSkus:p}})}n(p=>{const{updatedItems:h,addedItems:T,mergedItems:H,replacedItems:X}=cr(p,d,i);return X.forEach(E=>{const U=w(E);I.emit(`${U}/pdp/data`,E)}),H.forEach(E=>{const U=w(E);I.emit(`${U}/pdp/data`,E)}),T.forEach(E=>{const U=w(E);I.emit(`${U}/pdp/data`,E)}),h})}finally{s(!1),I.emit("quick-order/loading",!1),l(d=>new Set(Array.from(d).filter(c=>!k.includes(c))))}}},{eager:!0});return()=>{a==null||a.off()}},[t,q]),Q(()=>{const a=r.map(i=>{const k=w(i),d=i.id;return I.on(`${k}/pdp/data`,c=>{n(p=>dr(p,d||"",c,i.quantity||1).updatedItems)})});return()=>{a==null||a.forEach(i=>{i==null||i.off()})}},[r]),Q(()=>{const a=P(r);q(!a)},[r,q]),Q(()=>{if(m&&m.clickableSkus&&m.clickableSkus.length>0){const a=m.clickableSkus.filter(i=>{const k=r.filter(d=>d.sku===i||d.variantSku===i);return k.length===0?!1:k.some(d=>mr(d))});a.length===0?f(null):a.length!==m.clickableSkus.length&&f({...m,clickableSkus:a})}},[r,m]),Q(()=>{if(g&&r.length>0&&(!m||m.type!=="validation"&&m.type!=="partial-success")){const a=$(r);if(a.length>0){const i=[...new Set(a.map(c=>c.sku))],k=(m==null?void 0:m.clickableSkus)||[];(i.length!==k.length||!i.every(c=>k.includes(c)))&&f({type:"validation",variant:"warning",message:v.validationError,clickableSkus:i})}}},[g,r,v.validationError]),Q(()=>{const a=r.map(i=>{const k=w(i),d=i.id||i.sku;return I.on(`${k}/pdp/values`,c=>{const p=kr(c);fr(B,d,p)})});return()=>{a.forEach(i=>{i==null||i.off()})}},[r,B]),Q(()=>{C.current=O},[O]),Q(()=>{const a=I.on("cart/product/added",k=>{const d=Array.isArray(k)?k.length:0,c=Array.isArray(k)?k.map(p=>p.sku).filter(Boolean):[];if(O.length>0){const p=O.filter(h=>!c.includes(h));p.length>0&&d>0&&(f({type:"partial-success",variant:"warning",message:v.partialSuccess,count:d,clickableSkus:p}),S([]))}else return}),i=I.on("quick-order/add-to-cart-error",k=>{f({type:"backend-error",variant:"warning",message:v.backendError,details:k.message}),S([])});return()=>{a==null||a.off(),i==null||i.off()}},[O]),Q(()=>{const a=I.on("cart/data",i=>{if(C.current.length===0||!(i!=null&&i.items)||i.items.length===0)return;const k=i.items.flatMap(c=>{var h;const p=[];return c.sku&&p.push(c.sku),(h=c.product)!=null&&h.sku&&p.push(c.product.sku),p}),d=C.current.filter(c=>k.includes(c));d.length!==0&&(f({type:"success",variant:"success",message:v.success,count:d.length}),S([]),I.emit("quick-order/loading",!1))},{eager:!0});return()=>{a==null||a.off()}},[]);const F=A(a=>{n(i=>i.filter(k=>k.id!==a&&k.sku!==a))},[]),M=A(()=>{n([]),f(null)},[]),V=A((a,i)=>{n(k=>k.map(d=>d.sku===a?{...d,quantity:i}:d))},[]),N=A(a=>o.has(a),[o]),Z=A(()=>{const a=lr(r).filter(c=>c!==null);if(r.length>0&&!P(r)){const h=$(r).map(T=>T.sku);f({type:"validation",variant:"warning",message:v.validationError,clickableSkus:h});return}if(a.length===0){if(r.length>0){const p=$(r).map(h=>h.sku);f({type:"validation",variant:"warning",message:v.validationError,clickableSkus:p})}return}f(null);const i=a.map(c=>c.sku).filter(c=>!!c);S(i);const k=G(B),d=pr(a,r,k);e?(I.emit("quick-order/loading",!0),Promise.resolve(e(d)).then(c=>{c&&typeof c=="string"&&(f({type:"backend-error",variant:"warning",message:v.backendError,details:c}),S([]))}).catch(c=>{f({type:"backend-error",variant:"warning",message:v.backendError,details:c.message||v.unexpectedError}),S([])}).finally(()=>{I.emit("quick-order/loading",!1)})):I.emit("quick-order/add-to-cart",d)},[r,e,B]);return{items:r,loading:u,removeItem:F,clearItems:M,updateItemQuantity:V,addToCart:Z,isItemUpdating:N,isDisabledButton:g,setDisabledCartButton:q,notification:m,dismissNotification:x}},gr=({notification:t,onDismiss:e,onSkuClick:r,validationErrorText:n,backendErrorText:u,successText:s,partialSuccessText:o})=>{if(!t)return null;const l=()=>{switch(t.type){case"validation":return Or(n,t.clickableSkus,t.details,r);case"partial-success":return Sr(o,t.message,t.count,t.clickableSkus,r);case"backend-error":return Ir(u,t.details);case"success":return vr(s,t.count);default:return b("span",{children:t.message})}};return b("div",{className:j(["b2b-quick-order-notification-banner",[`b2b-quick-order-notification-banner--${t.variant}`,t.variant]]),children:b(rr,{variant:t.variant,message:l(),onDismiss:e})})};function Y(t,e){return t.map((r,n)=>D("span",{children:[b("a",{href:"#",onClick:u=>{u.preventDefault(),e(r)},style:{cursor:"pointer",textDecoration:"underline",color:"white"},children:r}),n<t.length-1?", ":""]},r))}function Or(t,e,r,n){return e!=null&&e.length&&n?D("span",{children:[t," - ",Y(e,n)]}):D("span",{children:[t," - ",r]})}function Sr(t,e,r,n,u){if(!t)return b("span",{children:e});const s=t.replace("{count}",String(r||0)).replace("{total}",String((r||0)+((n==null?void 0:n.length)||0)));return n!=null&&n.length&&u?D("span",{children:[s,": ",Y(n,u)]}):D("span",{children:[s,": ",(n==null?void 0:n.join(", "))||"Unknown"]})}function Ir(t,e){return D("span",{children:[t,e?` - ${e}`:""]})}function vr(t,e){return e!==void 0?b("span",{children:t.replace("{count}",String(e))}):b("span",{children:t})}const Tr=({className:t,slots:e,getProductsData:r,handleAddToCart:n,productsSearch:u,searchFilter:s})=>{const o=nr.getConfig().quickOrderActive,l=J(null),g=z({title:"QuickOrder.QuickOrderItem.title",quantity:"QuickOrder.QuickOrderItem.quantity",price:"QuickOrder.QuickOrderItem.price",remove:"QuickOrder.QuickOrderItem.remove",removeItem:"QuickOrder.QuickOrderItem.removeItem",showOptions:"QuickOrder.QuickOrderItem.showOptions",hideOptions:"QuickOrder.QuickOrderItem.hideOptions",additionalOptions:"QuickOrder.QuickOrderItem.additionalOptions",noAdditionalOptions:"QuickOrder.QuickOrderItem.noAdditionalOptions",emptyList:"QuickOrder.QuickOrderItem.emptyList",sku:"QuickOrder.QuickOrderItem.sku",loading:"QuickOrder.QuickOrderItem.loading",productNotFound:"QuickOrder.QuickOrderItem.productNotFound",productNotFoundDescription:"QuickOrder.QuickOrderItem.productNotFoundDescription",productOptions:"QuickOrder.QuickOrderItem.productOptions",configurableProductError:"QuickOrder.QuickOrderItem.configurableProductError",configurableProductErrorDescription:"QuickOrder.QuickOrderItem.configurableProductErrorDescription",addAllToCart:"QuickOrder.QuickOrderItem.addAllToCart",configurableOptionsWarning:"QuickOrder.QuickOrderItem.configurableOptionsWarning",configurableOptionsWarningDescription:"QuickOrder.QuickOrderItem.configurableOptionsWarningDescription",outOfStock:"QuickOrder.QuickOrderItem.outOfStock",searchPlaceholder:"QuickOrder.Search.placeholder",searchAriaLabel:"QuickOrder.Search.ariaLabel",searchEmptyState:"QuickOrder.Search.emptyState",resultsAvailable:"QuickOrder.Search.resultsAvailable",resultAvailable:"QuickOrder.Search.resultAvailable",srInstructions:"QuickOrder.Search.srInstructions",notificationValidationError:"QuickOrder.QuickOrderItem.notification.validationError",notificationBackendError:"QuickOrder.QuickOrderItem.notification.backendError",notificationSuccess:"QuickOrder.QuickOrderItem.notification.success",notificationPartialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",disabledMessage:"QuickOrder.QuickOrderItem.disabledMessage"}),{items:y,loading:m,removeItem:f,clearItems:O,updateItemQuantity:S,addToCart:C,isItemUpdating:v,setDisabledCartButton:B,isDisabledButton:x,notification:q,dismissNotification:F}=hr({getProductsData:r,handleAddToCart:n});Q(()=>{q&&q.variant==="warning"&&l.current&&l.current.scrollIntoView({behavior:"smooth",block:"start"})},[q]);const M=V=>{const N=document.querySelector(`form[data-sku="${V}"]`);N&&N.scrollIntoView({behavior:"smooth",block:"center"})};return D("div",{className:j(["b2b-quick-order-quick-order-items",!o&&"b2b-quick-order-disabled",t]),"data-testid":"quick-order-items",style:{position:"relative"},children:[b("div",{ref:l,children:b(gr,{notification:q,onDismiss:F,onSkuClick:M,validationErrorText:g.notificationValidationError,backendErrorText:g.notificationBackendError,successText:g.notificationSuccess,partialSuccessText:g.notificationPartialSuccess})}),b(er,{isDisabled:!o,message:g.disabledMessage,children:b(tr,{t:g,items:y,onRemove:f,clearItems:O,onUpdateQuantity:S,handleAddToCart:C,isItemUpdating:v,slots:e,loading:m,setDisabledCartButton:B,isDisabledButton:x,productsSearch:u,searchFilter:s})})]})};export{Tr as QuickOrderItems,Tr as default};
//# sourceMappingURL=QuickOrderItems.js.map
