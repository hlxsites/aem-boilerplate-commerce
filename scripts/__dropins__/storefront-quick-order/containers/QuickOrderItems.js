/*! Copyright 2026 Adobe
All Rights Reserved. */
import{jsx as Q,jsxs as D}from"@dropins/tools/preact-jsx-runtime.js";import{AlertBanner as rr}from"@dropins/tools/components.js";import{Q as er,a as tr}from"../chunks/QuickOrderDisabledOverlay.js";import{classes as j}from"@dropins/tools/lib.js";import{useState as R,useRef as J,useCallback as A,useEffect as q}from"@dropins/tools/preact-hooks.js";import{events as g}from"@dropins/tools/event-bus.js";import{useText as z}from"@dropins/tools/i18n.js";import{c as nr}from"../chunks/initialize.js";import"@dropins/tools/preact-compat.js";import"@dropins/tools/fetch-graphql.js";const ir=["sku","parentSku","quantity","optionsUIDs","valid","productType"],sr=t=>{const r=[],e=[];return t.forEach((n,o)=>{if(ir.includes(o))return;const i=n;i&&i.match(/^[A-Za-z0-9+/=]+$/)?r.push(i):e.push({uid:o,value:i})}),{optionUIDs:r,enteredOptions:e}},or=t=>{const r=Number(t.get("quantity")),e=!r||r<1?1:r,n={sku:t.get("sku"),quantity:e},o=t.get("parentSku");o&&(n.parentSku=o);const{optionUIDs:i,enteredOptions:s}=sr(t);return i.length>0&&(n.optionsUIDs=i),s.length>0&&(n.enteredOptions=s),n},M={sku:"",quantity:1,name:"",images:[],inStock:!1,addToCartAllowed:!1,isBundle:!1,prices:{},attributes:[],options:[],url:"",urlKey:"",externalId:"",productType:"simple",shortDescription:"",metaDescription:"",metaKeyword:"",metaTitle:"",description:""},L=(t,r)=>!r||!Array.isArray(r)?t.map(e=>({...M,sku:e.sku,quantity:e.quantity??1})):t.map(e=>{const n=r.find(o=>(o==null?void 0:o.sku)===(e==null?void 0:e.sku));return n?{...n,...e.variantSku&&{variantSku:e.variantSku},quantity:e.quantity??1}:{...M,sku:e.sku,...e.variantSku&&{variantSku:e.variantSku},quantity:e.quantity??1}}),P=t=>t.length===0?!1:t.every(r=>!((r.urlKey||r.url)&&r.name)||r.inStock===!1?!1:r.options&&r.options.length>0?r.options.some(i=>i.required)?r.options.every(i=>{var s;return i.required?(s=i.items)==null?void 0:s.some(u=>u.selected):!0}):r.options.some(i=>i.items&&i.items.length>0&&i.items.some(s=>s.selected===!0)):!0),_=t=>{const r=[];return t.forEach(e=>{if(!((e.urlKey||e.url)&&e.name)){r.push({sku:e.sku,name:e.name||"Unknown",reason:"incomplete_data"});return}if(e.inStock===!1){r.push({sku:e.sku,name:e.name,reason:"out_of_stock"});return}if(e.options&&e.options.length>0){if(e.options.some(s=>s.required)){e.options.every(u=>{var O;return u.required?(O=u.items)==null?void 0:O.some(I=>I.selected):!0})||r.push({sku:e.sku,name:e.name,reason:"missing_required_options"});return}e.options.some(s=>s.items&&s.items.length>0&&s.items.some(u=>u.selected===!0))||r.push({sku:e.sku,name:e.name,reason:"missing_options"})}}),r},N=t=>`quick-order-item-${t.id||t.variantSku||t.sku}`,K=t=>`${t}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,W=(t,r)=>t.findIndex(e=>r.variantSku&&e.variantSku?e.variantSku===r.variantSku:e.variantSku&&!r.variantSku&&r.sku?e.variantSku===r.sku:r.variantSku&&!e.variantSku&&e.sku?e.sku===r.variantSku:!r.variantSku&&!e.variantSku?e.sku===r.sku:!1),ar=(t,r,e)=>t.findIndex(n=>n.id===e?!1:r.variantSku&&n.variantSku?n.variantSku===r.variantSku:r.variantSku&&!n.variantSku&&n.sku?n.sku===r.variantSku:!1),cr=(t,r,e,n=1)=>t.map((o,i)=>i===e?{...o,quantity:o.quantity+n}:i===r?null:o).filter(Boolean),ur=(t,r,e)=>{const n=[...t],o=[],i=[],s=[];return r.forEach((u,O)=>{const I=e[O];if(I!=null&&I.replaceItemSku){const l=n.findIndex(S=>S.sku===I.replaceItemSku||S.id===I.replaceItemSku);if(l!==-1){const S=W(n,u);if(S!==-1&&S!==l){n.splice(l,1);const h=S>l?S-1:S;n[h]={...n[h],quantity:n[h].quantity+u.quantity},s.push(n[h])}else{const h={...u,id:K(u.sku)};n[l]=h,i.push(h)}return}}const m=W(n,u);if(m!==-1)n[m]={...n[m],quantity:n[m].quantity+u.quantity},s.push(n[m]);else{const l={...u,id:K(u.sku)};n.push(l),o.push(l)}}),{updatedItems:n,addedItems:o,replacedItems:i,mergedItems:s}},dr=(t,r,e,n=1)=>{const o=r?ar(t,e,r):-1;if(o!==-1){const s=t.findIndex(u=>u.id===r);return{updatedItems:cr(t,s,o,n),wasMerged:!0,mergedIntoIndex:o}}return{updatedItems:t.map(s=>r&&s.id===r?{...s,...e,id:r}:!r&&s.sku===e.sku?{...s,...e}:s),wasMerged:!1}},lr=t=>t.map(r=>{const e=r.id||r.sku,n=document.forms[`form-${e}`];if(!n)return null;const o=new FormData(n);return o.get("valid")==="true"?or(o):null}),fr=t=>{let r=[];return t&&typeof t=="object"?t.optionsUIDs&&Array.isArray(t.optionsUIDs)?r=t.optionsUIDs:Array.isArray(t)&&(r=t):typeof t=="string"&&(r=[t]),r},G=t=>{try{const r=localStorage.getItem(t);if(r)return JSON.parse(r)}catch(r){console.error("Error reading from localStorage:",r)}return{}},pr=(t,r,e)=>{if(e.length!==0)try{const n=G(t);n[r]=e,localStorage.setItem(t,JSON.stringify(n))}catch(n){console.error("Error saving to localStorage:",n)}},kr=(t,r,e)=>t.map(n=>{const o=r.find(i=>n.sku===i.sku||n.sku===i.variantSku);if(o){const i=o.id||o.sku,s=e[i];if(s&&s.length>0)return{...n,optionsUIDs:s}}return n}),mr=t=>{const r=!t.inStock||!t.addToCartAllowed;if(t.options&&t.options.length>0){if(t.options.some(i=>!i.items||i.items.length===0))return!0;if(t.options.some(i=>i.required)){const i=t.options.every(s=>{var u;return s.required?(u=s.items)==null?void 0:u.some(O=>O.selected):!0});return r||!i}const o=t.options.some(i=>i.items&&i.items.length>0&&i.items.some(s=>s.selected===!0));return r||!o}return r},Or=({getProductsData:t,handleAddToCart:r}={})=>{const[e,n]=R([]),[o,i]=R(!1),[s,u]=R(new Set),[O,I]=R(!1),[m,l]=R(null),[S,h]=R([]),T=J([]),v=z({validationError:"QuickOrder.QuickOrderItem.notification.validationError",backendError:"QuickOrder.QuickOrderItem.notification.backendError",success:"QuickOrder.QuickOrderItem.notification.success",partialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",unexpectedError:"QuickOrder.QuickOrderItem.notification.unexpectedError"}),B="quick-order-selected-options",w=A(()=>{l(null)},[]),y=A(c=>{I(c)},[]);q(()=>{const c=g.on("quick-order/loading",a=>{i(a)},{eager:!0});return()=>{c==null||c.off()}},[]),q(()=>{const c=g.on("quick-order/add-items",async a=>{if(a&&a.length>0){if(!t)return;i(!0),g.emit("quick-order/loading",!0);const p=a.map(d=>d.sku).filter(Boolean);u(d=>new Set([...Array.from(d),...p]));try{let d=[];try{const k=await t(a);y(a.length!==k.length),d=L(a,k)}catch(k){console.error("Error fetching products data:",k),d=L(a,[])}const f=_(d);if(f.length>0){const k=f.map(b=>b.sku);l({type:"validation",variant:"warning",message:v.validationError,clickableSkus:k})}n(k=>{const{updatedItems:b,addedItems:V,mergedItems:H,replacedItems:X}=ur(k,d,a);return X.forEach(E=>{const U=N(E);g.emit(`${U}/pdp/data`,E)}),H.forEach(E=>{const U=N(E);g.emit(`${U}/pdp/data`,E)}),V.forEach(E=>{const U=N(E);g.emit(`${U}/pdp/data`,E)}),b})}finally{i(!1),g.emit("quick-order/loading",!1),u(d=>new Set(Array.from(d).filter(f=>!p.includes(f))))}}},{eager:!0});return()=>{c==null||c.off()}},[t,y]),q(()=>{const c=e.map(a=>{const p=N(a),d=a.id;return g.on(`${p}/pdp/data`,f=>{n(k=>dr(k,d||"",f,a.quantity||1).updatedItems)})});return()=>{c==null||c.forEach(a=>{a==null||a.off()})}},[e]),q(()=>{const c=P(e);y(!c)},[e,y]),q(()=>{if(m&&m.clickableSkus&&m.clickableSkus.length>0){const c=m.clickableSkus.filter(a=>{const p=e.find(d=>d.sku===a||d.variantSku===a);return p?mr(p):!1});c.length===0?l(null):c.length!==m.clickableSkus.length&&l({...m,clickableSkus:c})}},[e,m]),q(()=>{const c=e.map(a=>{const p=N(a),d=a.id||a.sku;return g.on(`${p}/pdp/values`,f=>{const k=fr(f);pr(B,d,k)})});return()=>{c.forEach(a=>{a==null||a.off()})}},[e,B]),q(()=>{T.current=S},[S]),q(()=>{const c=g.on("cart/product/added",p=>{const d=Array.isArray(p)?p.length:0,f=Array.isArray(p)?p.map(k=>k.sku).filter(Boolean):[];if(T.current.length>0){const k=T.current.filter(b=>!f.includes(b));k.length>0&&d>0?l({type:"partial-success",variant:"warning",message:v.partialSuccess,count:d,clickableSkus:k}):d>0&&l({type:"success",variant:"success",message:v.success,count:d}),h([])}else return}),a=g.on("quick-order/add-to-cart-error",p=>{l({type:"backend-error",variant:"warning",message:v.backendError,details:p.message}),h([])});return()=>{c==null||c.off(),a==null||a.off()}},[]);const $=A(c=>{n(a=>a.filter(p=>p.id!==c&&p.sku!==c))},[]),x=A(()=>{n([]),l(null)},[]),F=A((c,a)=>{n(p=>p.map(d=>d.sku===c?{...d,quantity:a}:d))},[]),C=A(c=>s.has(c),[s]),Z=A(()=>{const c=lr(e).filter(f=>f!==null);if(e.length>0&&!P(e)){const b=_(e).map(V=>V.sku);l({type:"validation",variant:"warning",message:v.validationError,clickableSkus:b});return}if(c.length===0){if(e.length>0){const k=_(e).map(b=>b.sku);l({type:"validation",variant:"warning",message:v.validationError,clickableSkus:k})}return}l(null);const a=c.map(f=>f.sku).filter(f=>!!f);h(a);const p=G(B),d=kr(c,e,p);r?(g.emit("quick-order/loading",!0),Promise.resolve(r(d)).then(f=>{f&&typeof f=="string"&&(l({type:"backend-error",variant:"warning",message:v.backendError,details:f}),h([]))}).catch(f=>{l({type:"backend-error",variant:"warning",message:v.backendError,details:f.message||v.unexpectedError}),h([])}).finally(()=>{g.emit("quick-order/loading",!1)})):g.emit("quick-order/add-to-cart",d)},[e,r,B]);return{items:e,loading:o,removeItem:$,clearItems:x,updateItemQuantity:F,addToCart:Z,isItemUpdating:C,isDisabledButton:O,setDisabledCartButton:y,notification:m,dismissNotification:w}},hr=({notification:t,onDismiss:r,onSkuClick:e,validationErrorText:n,backendErrorText:o,successText:i,partialSuccessText:s})=>{if(!t)return null;const u=()=>{switch(t.type){case"validation":return gr(n,t.clickableSkus,t.details,e);case"partial-success":return Sr(s,t.message,t.count,t.clickableSkus,e);case"backend-error":return Ir(o,t.details);case"success":return vr(i,t.count);default:return Q("span",{children:t.message})}};return Q("div",{className:j(["b2b-quick-order-notification-banner",[`b2b-quick-order-notification-banner--${t.variant}`,t.variant]]),children:Q(rr,{variant:t.variant,message:u(),onDismiss:r})})};function Y(t,r){return t.map((e,n)=>D("span",{children:[Q("a",{href:"#",onClick:o=>{o.preventDefault(),r(e)},style:{cursor:"pointer",textDecoration:"underline",color:"white"},children:e}),n<t.length-1?", ":""]},e))}function gr(t,r,e,n){return r!=null&&r.length&&n?D("span",{children:[t," - ",Y(r,n)]}):D("span",{children:[t," - ",e]})}function Sr(t,r,e,n,o){if(!t)return Q("span",{children:r});const i=t.replace("{count}",String(e||0)).replace("{total}",String((e||0)+((n==null?void 0:n.length)||0)));return n!=null&&n.length&&o?D("span",{children:[i,": ",Y(n,o)]}):D("span",{children:[i,": ",(n==null?void 0:n.join(", "))||"Unknown"]})}function Ir(t,r){return D("span",{children:[t,r?` - ${r}`:""]})}function vr(t,r){return r!==void 0?Q("span",{children:t.replace("{count}",String(r))}):Q("span",{children:t})}const Ur=({className:t,slots:r,getProductsData:e,handleAddToCart:n,productsSearch:o,searchFilter:i})=>{const s=nr.getConfig().quickOrderActive,u=J(null),O=z({title:"QuickOrder.QuickOrderItem.title",quantity:"QuickOrder.QuickOrderItem.quantity",price:"QuickOrder.QuickOrderItem.price",remove:"QuickOrder.QuickOrderItem.remove",removeItem:"QuickOrder.QuickOrderItem.removeItem",showOptions:"QuickOrder.QuickOrderItem.showOptions",hideOptions:"QuickOrder.QuickOrderItem.hideOptions",additionalOptions:"QuickOrder.QuickOrderItem.additionalOptions",noAdditionalOptions:"QuickOrder.QuickOrderItem.noAdditionalOptions",emptyList:"QuickOrder.QuickOrderItem.emptyList",sku:"QuickOrder.QuickOrderItem.sku",loading:"QuickOrder.QuickOrderItem.loading",productNotFound:"QuickOrder.QuickOrderItem.productNotFound",productNotFoundDescription:"QuickOrder.QuickOrderItem.productNotFoundDescription",productOptions:"QuickOrder.QuickOrderItem.productOptions",configurableProductError:"QuickOrder.QuickOrderItem.configurableProductError",configurableProductErrorDescription:"QuickOrder.QuickOrderItem.configurableProductErrorDescription",addAllToCart:"QuickOrder.QuickOrderItem.addAllToCart",configurableOptionsWarning:"QuickOrder.QuickOrderItem.configurableOptionsWarning",configurableOptionsWarningDescription:"QuickOrder.QuickOrderItem.configurableOptionsWarningDescription",outOfStock:"QuickOrder.QuickOrderItem.outOfStock",searchPlaceholder:"QuickOrder.Search.placeholder",searchAriaLabel:"QuickOrder.Search.ariaLabel",searchEmptyState:"QuickOrder.Search.emptyState",resultsAvailable:"QuickOrder.Search.resultsAvailable",resultAvailable:"QuickOrder.Search.resultAvailable",srInstructions:"QuickOrder.Search.srInstructions",notificationValidationError:"QuickOrder.QuickOrderItem.notification.validationError",notificationBackendError:"QuickOrder.QuickOrderItem.notification.backendError",notificationSuccess:"QuickOrder.QuickOrderItem.notification.success",notificationPartialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",disabledMessage:"QuickOrder.QuickOrderItem.disabledMessage"}),{items:I,loading:m,removeItem:l,clearItems:S,updateItemQuantity:h,addToCart:T,isItemUpdating:v,setDisabledCartButton:B,isDisabledButton:w,notification:y,dismissNotification:$}=Or({getProductsData:e,handleAddToCart:n});q(()=>{y&&y.variant==="warning"&&u.current&&u.current.scrollIntoView({behavior:"smooth",block:"start"})},[y]);const x=F=>{const C=document.querySelector(`form[data-sku="${F}"]`);C&&C.scrollIntoView({behavior:"smooth",block:"center"})};return D("div",{className:j(["b2b-quick-order-quick-order-items",!s&&"b2b-quick-order-disabled",t]),"data-testid":"quick-order-items",style:{position:"relative"},children:[Q("div",{ref:u,children:Q(hr,{notification:y,onDismiss:$,onSkuClick:x,validationErrorText:O.notificationValidationError,backendErrorText:O.notificationBackendError,successText:O.notificationSuccess,partialSuccessText:O.notificationPartialSuccess})}),Q(er,{isDisabled:!s,message:O.disabledMessage,children:Q(tr,{t:O,items:I,onRemove:l,clearItems:S,onUpdateQuantity:h,handleAddToCart:T,isItemUpdating:v,slots:r,loading:m,setDisabledCartButton:B,isDisabledButton:w,productsSearch:o,searchFilter:i})})]})};export{Ur as QuickOrderItems,Ur as default};
//# sourceMappingURL=QuickOrderItems.js.map
