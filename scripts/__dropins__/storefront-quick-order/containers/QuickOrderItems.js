/*! Copyright 2026 Adobe
All Rights Reserved. */
import{jsx as y,jsxs as A}from"@dropins/tools/preact-jsx-runtime.js";import{AlertBanner as G}from"@dropins/tools/components.js";import{Q as Y,a as Z}from"../chunks/QuickOrderDisabledOverlay.js";import{useState as w,useCallback as C,useEffect as q,useRef as H}from"@dropins/tools/preact-hooks.js";import{events as Q}from"@dropins/tools/event-bus.js";import{useText as J}from"@dropins/tools/i18n.js";import{c as X}from"../chunks/initialize.js";import{classes as rr}from"@dropins/tools/lib.js";import"@dropins/tools/preact-compat.js";import"@dropins/tools/fetch-graphql.js";const er=["sku","parentSku","quantity","optionsUIDs","valid","productType"],tr=e=>{const t=[],r=[];return e.forEach((n,i)=>{if(er.includes(i))return;const a=n;a&&a.match(/^[A-Za-z0-9+/=]+$/)?t.push(a):r.push({uid:i,value:a})}),{optionUIDs:t,enteredOptions:r}},nr=e=>{const t=Number(e.get("quantity")),r=!t||t<1?1:t,n={sku:e.get("sku"),quantity:r},i=e.get("parentSku");i&&(n.parentSku=i);const{optionUIDs:a,enteredOptions:c}=tr(e);return a.length>0&&(n.optionsUIDs=a),c.length>0&&(n.enteredOptions=c),n},P={sku:"",quantity:1,name:"",images:[],inStock:!1,addToCartAllowed:!1,isBundle:!1,prices:{},attributes:[],options:[],url:"",urlKey:"",externalId:"",productType:"simple",shortDescription:"",metaDescription:"",metaKeyword:"",metaTitle:"",description:""},j=(e,t)=>!t||!Array.isArray(t)?e.map(r=>({...P,sku:r.sku,quantity:r.quantity??1})):e.map(r=>{const n=t.find(i=>(i==null?void 0:i.sku)===(r==null?void 0:r.sku));return n?{...n,...r.variantSku&&{variantSku:r.variantSku},quantity:r.quantity??1}:{...P,sku:r.sku,...r.variantSku&&{variantSku:r.variantSku},quantity:r.quantity??1}}),K=e=>e.length===0?!1:e.every(t=>!((t.urlKey||t.url)&&t.name)||t.inStock===!1?!1:t.options&&t.options.length>0?t.options.some(i=>i.items&&i.items.length>0&&i.items.some(a=>a.selected===!0)):!0),_=e=>{const t=[];return e.forEach(r=>{if(!((r.urlKey||r.url)&&r.name)){t.push({sku:r.sku,name:r.name||"Unknown",reason:"incomplete_data"});return}if(r.inStock===!1){t.push({sku:r.sku,name:r.name,reason:"out_of_stock"});return}r.options&&r.options.length>0&&(r.options.some(a=>a.items&&a.items.length>0&&a.items.some(c=>c.selected===!0))||t.push({sku:r.sku,name:r.name,reason:"missing_options"}))}),t},x=e=>`quick-order-item-${e.id||e.variantSku||e.sku}`,M=e=>`${e}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,W=(e,t)=>e.findIndex(r=>t.variantSku&&r.variantSku?r.variantSku===t.variantSku:r.variantSku&&!t.variantSku&&t.sku?r.variantSku===t.sku:t.variantSku&&!r.variantSku&&r.sku?r.sku===t.variantSku:!t.variantSku&&!r.variantSku?r.sku===t.sku:!1),sr=(e,t,r)=>e.findIndex(n=>n.id===r?!1:t.variantSku&&n.variantSku?n.variantSku===t.variantSku:t.variantSku&&!n.variantSku&&n.sku?n.sku===t.variantSku:!1),ir=(e,t,r,n=1)=>e.map((i,a)=>a===r?{...i,quantity:i.quantity+n}:a===t?null:i).filter(Boolean),ar=(e,t,r)=>{const n=[...e],i=[],a=[],c=[];return t.forEach((f,O)=>{const m=r[O];if(m!=null&&m.replaceItemSku){const l=n.findIndex(h=>h.sku===m.replaceItemSku||h.id===m.replaceItemSku);if(l!==-1){const h=W(n,f);if(h!==-1&&h!==l){n.splice(l,1);const S=h>l?h-1:h;n[S]={...n[S],quantity:n[S].quantity+f.quantity},c.push(n[S])}else{const S={...f,id:M(f.sku)};n[l]=S,a.push(S)}return}}const u=W(n,f);if(u!==-1)n[u]={...n[u],quantity:n[u].quantity+f.quantity},c.push(n[u]);else{const l={...f,id:M(f.sku)};n.push(l),i.push(l)}}),{updatedItems:n,addedItems:i,replacedItems:a,mergedItems:c}},or=(e,t,r,n=1)=>{const i=t?sr(e,r,t):-1;if(i!==-1){const c=e.findIndex(f=>f.id===t);return{updatedItems:ir(e,c,i,n),wasMerged:!0,mergedIntoIndex:i}}return{updatedItems:e.map(c=>t&&c.id===t?{...c,...r,id:t}:!t&&c.sku===r.sku?{...c,...r}:c),wasMerged:!1}},cr=e=>e.map(t=>{const r=t.id||t.sku,n=document.forms[`form-${r}`];if(!n)return null;const i=new FormData(n);return i.get("valid")==="true"?nr(i):null}),ur=e=>{let t=[];return e&&typeof e=="object"?e.optionsUIDs&&Array.isArray(e.optionsUIDs)?t=e.optionsUIDs:Array.isArray(e)&&(t=e):typeof e=="string"&&(t=[e]),t},z=e=>{try{const t=localStorage.getItem(e);if(t)return JSON.parse(t)}catch(t){console.error("Error reading from localStorage:",t)}return{}},lr=(e,t,r)=>{if(r.length!==0)try{const n=z(e);n[t]=r,localStorage.setItem(e,JSON.stringify(n))}catch(n){console.error("Error saving to localStorage:",n)}},dr=(e,t,r)=>e.map(n=>{const i=t.find(a=>n.sku===a.sku||n.sku===a.variantSku);if(i){const a=i.id||i.sku,c=r[a];if(c&&c.length>0)return{...n,optionsUIDs:c}}return n}),kr=({getProductsData:e,onAddAllToCart:t}={})=>{const[r,n]=w([]),[i,a]=w(!1),[c,f]=w(new Set),[O,m]=w(!1),[u,l]=w(null),[h,S]=w([]),v=J({validationError:"QuickOrder.QuickOrderItem.notification.validationError",backendError:"QuickOrder.QuickOrderItem.notification.backendError",success:"QuickOrder.QuickOrderItem.notification.success",partialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",unexpectedError:"QuickOrder.QuickOrderItem.notification.unexpectedError"}),T="quick-order-selected-options",F=C(()=>{l(null)},[]),b=C(o=>{m(o)},[]);q(()=>{const o=Q.on("quick-order/loading",s=>{a(s)},{eager:!0});return()=>{o==null||o.off()}},[]),q(()=>{const o=Q.on("quick-order/add-items",async s=>{if(s&&s.length>0){if(!e)return;a(!0),Q.emit("quick-order/loading",!0);const d=s.map(k=>k.sku).filter(Boolean);f(k=>new Set([...Array.from(k),...d]));try{let k=[];try{const p=await e(s);b(s.length!==p.length),k=j(s,p)}catch(p){console.error("Error fetching products data:",p),k=j(s,[])}n(p=>{const{updatedItems:g,addedItems:E,mergedItems:U,replacedItems:D}=ar(p,k,s),N=_(g);if(N.length>0){const I=N.map(B=>B.sku);l({variant:"warning",message:v.validationError,clickableSkus:I})}return D.forEach(I=>{const B=x(I);Q.emit(`${B}/pdp/data`,I)}),U.forEach(I=>{const B=x(I);Q.emit(`${B}/pdp/data`,I)}),E.forEach(I=>{const B=x(I);Q.emit(`${B}/pdp/data`,I)}),g})}finally{a(!1),Q.emit("quick-order/loading",!1),f(k=>new Set(Array.from(k).filter(p=>!d.includes(p))))}}},{eager:!0});return()=>{o==null||o.off()}},[e,b]),q(()=>{if((u==null?void 0:u.variant)==="warning"&&(u!=null&&u.clickableSkus)){const s=_(r).map(d=>d.sku);s.length===0?l(null):s.sort().join(",")!==u.clickableSkus.sort().join(",")&&l({...u,clickableSkus:s})}},[r]),q(()=>{const o=r.map(s=>{const d=x(s),k=s.id;return Q.on(`${d}/pdp/data`,p=>{n(g=>or(g,k||"",p,s.quantity||1).updatedItems)})});return()=>{o==null||o.forEach(s=>{s==null||s.off()})}},[r]),q(()=>{const o=K(r);b(!o)},[r,b]),q(()=>{if(u&&u.clickableSkus&&u.clickableSkus.length>0&&u.message.includes("require attention")){const o=u.clickableSkus.filter(s=>{var E,U;const d=r.find(D=>D.sku===s||D.variantSku===s);if(!d)return!1;const k=!d.inStock||!d.addToCartAllowed,g=((E=d.options)==null?void 0:E.some(D=>D.required))?(U=d.options)==null?void 0:U.every(D=>{var N;return!D.required||((N=D.items)==null?void 0:N.some(I=>I.selected))}):!0;return k||!g});o.length===0?l(null):o.length!==u.clickableSkus.length&&l({...u,clickableSkus:o})}},[r,u]),q(()=>{const o=r.map(s=>{const d=x(s),k=s.id||s.sku;return Q.on(`${d}/pdp/values`,p=>{const g=ur(p);lr(T,k,g)})});return()=>{o.forEach(s=>{s==null||s.off()})}},[r,T]),q(()=>{const o=Q.on("cart/product/added",d=>{const k=Array.isArray(d)?d.length:0,p=Array.isArray(d)?d.map(g=>g.sku).filter(Boolean):[];if(h.length>0){const g=h.filter(E=>!p.includes(E));g.length>0?l({variant:"warning",message:v.partialSuccess,count:k,clickableSkus:g}):l({variant:"success",message:v.success,count:k}),S([])}else l({variant:"success",message:v.success,count:k})}),s=Q.on("quick-order/add-to-cart-error",d=>{l({variant:"warning",message:v.backendError,details:d.message}),S([])});return()=>{o==null||o.off(),s==null||s.off()}},[h]);const R=C(o=>{n(s=>s.filter(d=>d.id!==o&&d.sku!==o))},[]),V=C((o,s)=>{n(d=>d.map(k=>k.sku===o?{...k,quantity:s}:k))},[]),L=C(o=>c.has(o),[c]),$=C(()=>{const o=cr(r).filter(p=>p!==null);if(r.length>0&&!K(r)){const E=_(r).map(U=>U.sku);l({variant:"warning",message:v.validationError,clickableSkus:E});return}l(null);const s=r.map(p=>p.sku);S(s);const d=z(T),k=dr(o,r,d);t?Promise.resolve(t(k)).then(p=>{p&&typeof p=="string"&&(l({variant:"warning",message:v.backendError,details:p}),S([]))}).catch(p=>{l({variant:"warning",message:v.backendError,details:p.message||v.unexpectedError}),S([])}):Q.emit("quick-order/add-to-cart",k)},[r,t,T]);return{items:r,loading:i,removeItem:R,updateItemQuantity:V,handleAddToCart:$,isItemUpdating:L,isDisabledButton:O,setDisabledCartButton:b,notification:u,dismissNotification:F}},pr=({notification:e,onDismiss:t,onSkuClick:r,validationErrorText:n,backendErrorText:i,successText:a,partialSuccessText:c})=>{if(!e)return null;const f=()=>{if(e.variant==="warning"&&e.message.includes("require attention")){const O=n;return e.clickableSkus&&e.clickableSkus.length>0&&r?A("span",{children:[O," -"," ",e.clickableSkus.map((m,u)=>A("span",{children:[y("a",{href:"#",onClick:l=>{l.preventDefault(),r(m)},style:{cursor:"pointer",textDecoration:"underline",color:"white"},children:m}),u<e.clickableSkus.length-1?", ":""]},m))]}):A("span",{children:[O," - ",e.details]})}if(e.variant==="warning"&&c&&e.clickableSkus&&e.clickableSkus.length>0){const O=c.replace("{count}",String(e.count||0)).replace("{total}",String((e.count||0)+e.clickableSkus.length));return r?A("span",{children:[O,":"," ",e.clickableSkus.map((m,u)=>A("span",{children:[y("a",{href:"#",onClick:l=>{l.preventDefault(),r(m)},style:{cursor:"pointer",textDecoration:"underline",color:"white"},children:m}),u<e.clickableSkus.length-1?", ":""]},m))]}):A("span",{children:[O,": ",e.clickableSkus.join(", ")]})}return e.variant==="warning"?A("span",{children:[i," - ",e.details]}):e.count!==void 0?y("span",{children:a.replace("{count}",String(e.count))}):y("span",{children:a})};return y("div",{className:"b2b-quick-order-notification-banner",children:y(G,{variant:e.variant,message:f(),onDismiss:t})})},yr=({className:e,slots:t,getProductsData:r,onAddAllToCart:n,productsSearch:i,searchFilter:a})=>{const c=X.getConfig().quickOrderActive,f=H(null),O=J({title:"QuickOrder.QuickOrderItem.title",quantity:"QuickOrder.QuickOrderItem.quantity",price:"QuickOrder.QuickOrderItem.price",remove:"QuickOrder.QuickOrderItem.remove",removeItem:"QuickOrder.QuickOrderItem.removeItem",showOptions:"QuickOrder.QuickOrderItem.showOptions",hideOptions:"QuickOrder.QuickOrderItem.hideOptions",additionalOptions:"QuickOrder.QuickOrderItem.additionalOptions",noAdditionalOptions:"QuickOrder.QuickOrderItem.noAdditionalOptions",emptyList:"QuickOrder.QuickOrderItem.emptyList",sku:"QuickOrder.QuickOrderItem.sku",loading:"QuickOrder.QuickOrderItem.loading",productNotFound:"QuickOrder.QuickOrderItem.productNotFound",productNotFoundDescription:"QuickOrder.QuickOrderItem.productNotFoundDescription",productOptions:"QuickOrder.QuickOrderItem.productOptions",configurableProductError:"QuickOrder.QuickOrderItem.configurableProductError",configurableProductErrorDescription:"QuickOrder.QuickOrderItem.configurableProductErrorDescription",addAllToCart:"QuickOrder.QuickOrderItem.addAllToCart",configurableOptionsWarning:"QuickOrder.QuickOrderItem.configurableOptionsWarning",configurableOptionsWarningDescription:"QuickOrder.QuickOrderItem.configurableOptionsWarningDescription",outOfStock:"QuickOrder.QuickOrderItem.outOfStock",searchPlaceholder:"QuickOrder.Search.placeholder",searchAriaLabel:"QuickOrder.Search.ariaLabel",searchEmptyState:"QuickOrder.Search.emptyState",resultsAvailable:"QuickOrder.Search.resultsAvailable",resultAvailable:"QuickOrder.Search.resultAvailable",srInstructions:"QuickOrder.Search.srInstructions",notificationValidationError:"QuickOrder.QuickOrderItem.notification.validationError",notificationBackendError:"QuickOrder.QuickOrderItem.notification.backendError",notificationSuccess:"QuickOrder.QuickOrderItem.notification.success",notificationPartialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",disabledMessage:"QuickOrder.QuickOrderItem.disabledMessage"}),{items:m,loading:u,removeItem:l,updateItemQuantity:h,handleAddToCart:S,isItemUpdating:v,setDisabledCartButton:T,isDisabledButton:F,notification:b,dismissNotification:R}=kr({getProductsData:r,onAddAllToCart:n});q(()=>{b&&b.variant==="warning"&&f.current&&f.current.scrollIntoView({behavior:"smooth",block:"start"})},[b]);const V=L=>{const $=document.querySelector(`form[data-sku="${L}"]`);$&&$.scrollIntoView({behavior:"smooth",block:"center"})};return A("div",{className:rr(["b2b-quick-order-quick-order-items",!c&&"b2b-quick-order-disabled",e]),"data-testid":"quick-order-items",style:{position:"relative"},children:[y("div",{ref:f,children:y(pr,{notification:b,onDismiss:R,onSkuClick:V,validationErrorText:O.notificationValidationError,backendErrorText:O.notificationBackendError,successText:O.notificationSuccess,partialSuccessText:O.notificationPartialSuccess})}),y(Y,{isDisabled:!c,message:O.disabledMessage,children:y(Z,{t:O,items:m,onRemove:l,onUpdateQuantity:h,handleAddToCart:S,isItemUpdating:v,slots:t,loading:u,setDisabledCartButton:T,isDisabledButton:F,productsSearch:i,searchFilter:a})})]})};export{yr as QuickOrderItems,yr as default};
//# sourceMappingURL=QuickOrderItems.js.map
