/*! Copyright 2026 Adobe
All Rights Reserved. */
import{jsx as Q,jsxs as D}from"@dropins/tools/preact-jsx-runtime.js";import{AlertBanner as H}from"@dropins/tools/components.js";import{Q as X,a as rr}from"../chunks/QuickOrderDisabledOverlay.js";import{classes as j}from"@dropins/tools/lib.js";import{useState as T,useCallback as A,useEffect as b,useRef as er}from"@dropins/tools/preact-hooks.js";import{events as S}from"@dropins/tools/event-bus.js";import{useText as J}from"@dropins/tools/i18n.js";import{c as tr}from"../chunks/initialize.js";import"@dropins/tools/preact-compat.js";import"@dropins/tools/fetch-graphql.js";const nr=["sku","parentSku","quantity","optionsUIDs","valid","productType"],ir=t=>{const r=[],e=[];return t.forEach((n,a)=>{if(nr.includes(a))return;const i=n;i&&i.match(/^[A-Za-z0-9+/=]+$/)?r.push(i):e.push({uid:a,value:i})}),{optionUIDs:r,enteredOptions:e}},sr=t=>{const r=Number(t.get("quantity")),e=!r||r<1?1:r,n={sku:t.get("sku"),quantity:e},a=t.get("parentSku");a&&(n.parentSku=a);const{optionUIDs:i,enteredOptions:s}=ir(t);return i.length>0&&(n.optionsUIDs=i),s.length>0&&(n.enteredOptions=s),n},M={sku:"",quantity:1,name:"",images:[],inStock:!1,addToCartAllowed:!1,isBundle:!1,prices:{},attributes:[],options:[],url:"",urlKey:"",externalId:"",productType:"simple",shortDescription:"",metaDescription:"",metaKeyword:"",metaTitle:"",description:""},L=(t,r)=>!r||!Array.isArray(r)?t.map(e=>({...M,sku:e.sku,quantity:e.quantity??1})):t.map(e=>{const n=r.find(a=>(a==null?void 0:a.sku)===(e==null?void 0:e.sku));return n?{...n,...e.variantSku&&{variantSku:e.variantSku},quantity:e.quantity??1}:{...M,sku:e.sku,...e.variantSku&&{variantSku:e.variantSku},quantity:e.quantity??1}}),P=t=>t.length===0?!1:t.every(r=>!((r.urlKey||r.url)&&r.name)||r.inStock===!1?!1:r.options&&r.options.length>0?r.options.some(i=>i.required)?r.options.every(i=>{var s;return i.required?(s=i.items)==null?void 0:s.some(d=>d.selected):!0}):r.options.some(i=>i.items&&i.items.length>0&&i.items.some(s=>s.selected===!0)):!0),_=t=>{const r=[];return t.forEach(e=>{if(!((e.urlKey||e.url)&&e.name)){r.push({sku:e.sku,name:e.name||"Unknown",reason:"incomplete_data"});return}if(e.inStock===!1){r.push({sku:e.sku,name:e.name,reason:"out_of_stock"});return}if(e.options&&e.options.length>0){if(e.options.some(s=>s.required)){e.options.every(d=>{var h;return d.required?(h=d.items)==null?void 0:h.some(I=>I.selected):!0})||r.push({sku:e.sku,name:e.name,reason:"missing_required_options"});return}e.options.some(s=>s.items&&s.items.length>0&&s.items.some(d=>d.selected===!0))||r.push({sku:e.sku,name:e.name,reason:"missing_options"})}}),r},N=t=>`quick-order-item-${t.id||t.variantSku||t.sku}`,K=t=>`${t}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,W=(t,r)=>t.findIndex(e=>r.variantSku&&e.variantSku?e.variantSku===r.variantSku:e.variantSku&&!r.variantSku&&r.sku?e.variantSku===r.sku:r.variantSku&&!e.variantSku&&e.sku?e.sku===r.variantSku:!r.variantSku&&!e.variantSku?e.sku===r.sku:!1),or=(t,r,e)=>t.findIndex(n=>n.id===e?!1:r.variantSku&&n.variantSku?n.variantSku===r.variantSku:r.variantSku&&!n.variantSku&&n.sku?n.sku===r.variantSku:!1),ar=(t,r,e,n=1)=>t.map((a,i)=>i===e?{...a,quantity:a.quantity+n}:i===r?null:a).filter(Boolean),ur=(t,r,e)=>{const n=[...t],a=[],i=[],s=[];return r.forEach((d,h)=>{const I=e[h];if(I!=null&&I.replaceItemSku){const f=n.findIndex(g=>g.sku===I.replaceItemSku||g.id===I.replaceItemSku);if(f!==-1){const g=W(n,d);if(g!==-1&&g!==f){n.splice(f,1);const m=g>f?g-1:g;n[m]={...n[m],quantity:n[m].quantity+d.quantity},s.push(n[m])}else{const m={...d,id:K(d.sku)};n[f]=m,i.push(m)}return}}const O=W(n,d);if(O!==-1)n[O]={...n[O],quantity:n[O].quantity+d.quantity},s.push(n[O]);else{const f={...d,id:K(d.sku)};n.push(f),a.push(f)}}),{updatedItems:n,addedItems:a,replacedItems:i,mergedItems:s}},cr=(t,r,e,n=1)=>{const a=r?or(t,e,r):-1;if(a!==-1){const s=t.findIndex(d=>d.id===r);return{updatedItems:ar(t,s,a,n),wasMerged:!0,mergedIntoIndex:a}}return{updatedItems:t.map(s=>r&&s.id===r?{...s,...e,id:r}:!r&&s.sku===e.sku?{...s,...e}:s),wasMerged:!1}},dr=t=>t.map(r=>{const e=r.id||r.sku,n=document.forms[`form-${e}`];if(!n)return null;const a=new FormData(n);return a.get("valid")==="true"?sr(a):null}),lr=t=>{let r=[];return t&&typeof t=="object"?t.optionsUIDs&&Array.isArray(t.optionsUIDs)?r=t.optionsUIDs:Array.isArray(t)&&(r=t):typeof t=="string"&&(r=[t]),r},z=t=>{try{const r=localStorage.getItem(t);if(r)return JSON.parse(r)}catch(r){console.error("Error reading from localStorage:",r)}return{}},fr=(t,r,e)=>{if(e.length!==0)try{const n=z(t);n[r]=e,localStorage.setItem(t,JSON.stringify(n))}catch(n){console.error("Error saving to localStorage:",n)}},pr=(t,r,e)=>t.map(n=>{const a=r.find(i=>n.sku===i.sku||n.sku===i.variantSku);if(a){const i=a.id||a.sku,s=e[i];if(s&&s.length>0)return{...n,optionsUIDs:s}}return n}),kr=t=>{const r=!t.inStock||!t.addToCartAllowed;if(t.options&&t.options.length>0){if(t.options.some(i=>!i.items||i.items.length===0))return!0;if(t.options.some(i=>i.required)){const i=t.options.every(s=>{var d;return s.required?(d=s.items)==null?void 0:d.some(h=>h.selected):!0});return r||!i}const a=t.options.some(i=>i.items&&i.items.length>0&&i.items.some(s=>s.selected===!0));return r||!a}return r},mr=({getProductsData:t,handleAddToCart:r}={})=>{const[e,n]=T([]),[a,i]=T(!1),[s,d]=T(new Set),[h,I]=T(!1),[O,f]=T(null),[g,m]=T([]),v=J({validationError:"QuickOrder.QuickOrderItem.notification.validationError",backendError:"QuickOrder.QuickOrderItem.notification.backendError",success:"QuickOrder.QuickOrderItem.notification.success",partialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",unexpectedError:"QuickOrder.QuickOrderItem.notification.unexpectedError"}),B="quick-order-selected-options",w=A(()=>{f(null)},[]),E=A(u=>{I(u)},[]);b(()=>{const u=S.on("quick-order/loading",o=>{i(o)},{eager:!0});return()=>{u==null||u.off()}},[]),b(()=>{const u=S.on("quick-order/add-items",async o=>{if(o&&o.length>0){if(!t)return;i(!0),S.emit("quick-order/loading",!0);const l=o.map(c=>c.sku).filter(Boolean);d(c=>new Set([...Array.from(c),...l]));try{let c=[];try{const k=await t(o);E(o.length!==k.length),c=L(o,k)}catch(k){console.error("Error fetching products data:",k),c=L(o,[])}const p=_(c);if(p.length>0){const k=p.map(y=>y.sku);f({type:"validation",variant:"warning",message:v.validationError,clickableSkus:k})}n(k=>{const{updatedItems:y,addedItems:V,mergedItems:Y,replacedItems:Z}=ur(k,c,o);return Z.forEach(q=>{const U=N(q);S.emit(`${U}/pdp/data`,q)}),Y.forEach(q=>{const U=N(q);S.emit(`${U}/pdp/data`,q)}),V.forEach(q=>{const U=N(q);S.emit(`${U}/pdp/data`,q)}),y})}finally{i(!1),S.emit("quick-order/loading",!1),d(c=>new Set(Array.from(c).filter(p=>!l.includes(p))))}}},{eager:!0});return()=>{u==null||u.off()}},[t,E]),b(()=>{const u=e.map(o=>{const l=N(o),c=o.id;return S.on(`${l}/pdp/data`,p=>{n(k=>cr(k,c||"",p,o.quantity||1).updatedItems)})});return()=>{u==null||u.forEach(o=>{o==null||o.off()})}},[e]),b(()=>{const u=P(e);E(!u)},[e,E]),b(()=>{if(O&&O.clickableSkus&&O.clickableSkus.length>0){const u=O.clickableSkus.filter(o=>{const l=e.find(c=>c.sku===o||c.variantSku===o);return l?kr(l):!1});u.length===0?f(null):u.length!==O.clickableSkus.length&&f({...O,clickableSkus:u})}},[e,O]),b(()=>{const u=e.map(o=>{const l=N(o),c=o.id||o.sku;return S.on(`${l}/pdp/values`,p=>{const k=lr(p);fr(B,c,k)})});return()=>{u.forEach(o=>{o==null||o.off()})}},[e,B]),b(()=>{const u=S.on("cart/product/added",l=>{const c=Array.isArray(l)?l.length:0,p=Array.isArray(l)?l.map(k=>k.sku).filter(Boolean):[];if(g.length>0){const k=g.filter(y=>!p.includes(y));k.length>0&&c>0&&(f({type:"partial-success",variant:"warning",message:v.partialSuccess,count:c,clickableSkus:k}),m([]))}else return}),o=S.on("quick-order/add-to-cart-error",l=>{f({type:"backend-error",variant:"warning",message:v.backendError,details:l.message}),m([])});return()=>{u==null||u.off(),o==null||o.off()}},[g]),b(()=>{const u=S.on("cart/data",o=>{var c;const l=((c=o==null?void 0:o.items)==null?void 0:c.length)||0;if(l===0){f(null),m([]);return}f({type:"success",variant:"success",message:v.success,count:l}),m([])},{eager:!0});return()=>{u==null||u.off()}},[g]);const R=A(u=>{n(o=>o.filter(l=>l.id!==u&&l.sku!==u))},[]),$=A(()=>{n([]),f(null)},[]),x=A((u,o)=>{n(l=>l.map(c=>c.sku===u?{...c,quantity:o}:c))},[]),F=A(u=>s.has(u),[s]),C=A(()=>{const u=dr(e).filter(p=>p!==null);if(e.length>0&&!P(e)){const y=_(e).map(V=>V.sku);f({type:"validation",variant:"warning",message:v.validationError,clickableSkus:y});return}if(u.length===0){if(e.length>0){const k=_(e).map(y=>y.sku);f({type:"validation",variant:"warning",message:v.validationError,clickableSkus:k})}return}f(null);const o=u.map(p=>p.sku).filter(p=>!!p);m(o);const l=z(B),c=pr(u,e,l);r?(S.emit("quick-order/loading",!0),Promise.resolve(r(c)).then(p=>{p&&typeof p=="string"&&(f({type:"backend-error",variant:"warning",message:v.backendError,details:p}),m([]))}).catch(p=>{f({type:"backend-error",variant:"warning",message:v.backendError,details:p.message||v.unexpectedError}),m([])}).finally(()=>{S.emit("quick-order/loading",!1)})):S.emit("quick-order/add-to-cart",c)},[e,r,B]);return{items:e,loading:a,removeItem:R,clearItems:$,updateItemQuantity:x,addToCart:C,isItemUpdating:F,isDisabledButton:h,setDisabledCartButton:E,notification:O,dismissNotification:w}},Or=({notification:t,onDismiss:r,onSkuClick:e,validationErrorText:n,backendErrorText:a,successText:i,partialSuccessText:s})=>{if(!t)return null;const d=()=>{switch(t.type){case"validation":return hr(n,t.clickableSkus,t.details,e);case"partial-success":return gr(s,t.message,t.count,t.clickableSkus,e);case"backend-error":return Sr(a,t.details);case"success":return Ir(i,t.count);default:return Q("span",{children:t.message})}};return Q("div",{className:j(["b2b-quick-order-notification-banner",[`b2b-quick-order-notification-banner--${t.variant}`,t.variant]]),children:Q(H,{variant:t.variant,message:d(),onDismiss:r})})};function G(t,r){return t.map((e,n)=>D("span",{children:[Q("a",{href:"#",onClick:a=>{a.preventDefault(),r(e)},style:{cursor:"pointer",textDecoration:"underline",color:"white"},children:e}),n<t.length-1?", ":""]},e))}function hr(t,r,e,n){return r!=null&&r.length&&n?D("span",{children:[t," - ",G(r,n)]}):D("span",{children:[t," - ",e]})}function gr(t,r,e,n,a){if(!t)return Q("span",{children:r});const i=t.replace("{count}",String(e||0)).replace("{total}",String((e||0)+((n==null?void 0:n.length)||0)));return n!=null&&n.length&&a?D("span",{children:[i,": ",G(n,a)]}):D("span",{children:[i,": ",(n==null?void 0:n.join(", "))||"Unknown"]})}function Sr(t,r){return D("span",{children:[t,r?` - ${r}`:""]})}function Ir(t,r){return r!==void 0?Q("span",{children:t.replace("{count}",String(r))}):Q("span",{children:t})}const Tr=({className:t,slots:r,getProductsData:e,handleAddToCart:n,productsSearch:a,searchFilter:i})=>{const s=tr.getConfig().quickOrderActive,d=er(null),h=J({title:"QuickOrder.QuickOrderItem.title",quantity:"QuickOrder.QuickOrderItem.quantity",price:"QuickOrder.QuickOrderItem.price",remove:"QuickOrder.QuickOrderItem.remove",removeItem:"QuickOrder.QuickOrderItem.removeItem",showOptions:"QuickOrder.QuickOrderItem.showOptions",hideOptions:"QuickOrder.QuickOrderItem.hideOptions",additionalOptions:"QuickOrder.QuickOrderItem.additionalOptions",noAdditionalOptions:"QuickOrder.QuickOrderItem.noAdditionalOptions",emptyList:"QuickOrder.QuickOrderItem.emptyList",sku:"QuickOrder.QuickOrderItem.sku",loading:"QuickOrder.QuickOrderItem.loading",productNotFound:"QuickOrder.QuickOrderItem.productNotFound",productNotFoundDescription:"QuickOrder.QuickOrderItem.productNotFoundDescription",productOptions:"QuickOrder.QuickOrderItem.productOptions",configurableProductError:"QuickOrder.QuickOrderItem.configurableProductError",configurableProductErrorDescription:"QuickOrder.QuickOrderItem.configurableProductErrorDescription",addAllToCart:"QuickOrder.QuickOrderItem.addAllToCart",configurableOptionsWarning:"QuickOrder.QuickOrderItem.configurableOptionsWarning",configurableOptionsWarningDescription:"QuickOrder.QuickOrderItem.configurableOptionsWarningDescription",outOfStock:"QuickOrder.QuickOrderItem.outOfStock",searchPlaceholder:"QuickOrder.Search.placeholder",searchAriaLabel:"QuickOrder.Search.ariaLabel",searchEmptyState:"QuickOrder.Search.emptyState",resultsAvailable:"QuickOrder.Search.resultsAvailable",resultAvailable:"QuickOrder.Search.resultAvailable",srInstructions:"QuickOrder.Search.srInstructions",notificationValidationError:"QuickOrder.QuickOrderItem.notification.validationError",notificationBackendError:"QuickOrder.QuickOrderItem.notification.backendError",notificationSuccess:"QuickOrder.QuickOrderItem.notification.success",notificationPartialSuccess:"QuickOrder.QuickOrderItem.notification.partialSuccess",disabledMessage:"QuickOrder.QuickOrderItem.disabledMessage"}),{items:I,loading:O,removeItem:f,clearItems:g,updateItemQuantity:m,addToCart:v,isItemUpdating:B,setDisabledCartButton:w,isDisabledButton:E,notification:R,dismissNotification:$}=mr({getProductsData:e,handleAddToCart:n});b(()=>{R&&R.variant==="warning"&&d.current&&d.current.scrollIntoView({behavior:"smooth",block:"start"})},[R]);const x=F=>{const C=document.querySelector(`form[data-sku="${F}"]`);C&&C.scrollIntoView({behavior:"smooth",block:"center"})};return D("div",{className:j(["b2b-quick-order-quick-order-items",!s&&"b2b-quick-order-disabled",t]),"data-testid":"quick-order-items",style:{position:"relative"},children:[Q("div",{ref:d,children:Q(Or,{notification:R,onDismiss:$,onSkuClick:x,validationErrorText:h.notificationValidationError,backendErrorText:h.notificationBackendError,successText:h.notificationSuccess,partialSuccessText:h.notificationPartialSuccess})}),Q(X,{isDisabled:!s,message:h.disabledMessage,children:Q(rr,{t:h,items:I,onRemove:f,clearItems:g,onUpdateQuantity:m,handleAddToCart:v,isItemUpdating:B,slots:r,loading:O,setDisabledCartButton:w,isDisabledButton:E,productsSearch:a,searchFilter:i})})]})};export{Tr as QuickOrderItems,Tr as default};
//# sourceMappingURL=QuickOrderItems.js.map
