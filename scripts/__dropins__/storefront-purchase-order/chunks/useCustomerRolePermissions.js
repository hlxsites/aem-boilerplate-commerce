/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as q,Fragment as ce,jsx as i}from"@dropins/tools/preact-jsx-runtime.js";import{InLineAlert as oe,Table as ie,Pagination as le,Picker as de,Card as ue,Header as pe}from"@dropins/tools/components.js";import{classes as K}from"@dropins/tools/lib.js";import{events as X}from"@dropins/tools/event-bus.js";import{useText as he,Text as j}from"@dropins/tools/i18n.js";import{useState as C,useEffect as G,useCallback as R,useMemo as z}from"@dropins/tools/preact-hooks.js";import{g as ge,r as me,a as Pe}from"./getPurchaseOrders.js";const fe=a=>{try{return new URL(a,window.location.origin).origin===window.location.origin}catch{return a.startsWith("/")||a.startsWith("./")||a.startsWith("../")}},ee=(a,o="en-US")=>{try{const t=new Date(a);return isNaN(t.getTime())?a:t.toLocaleString(o,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0})}catch{return a}},Oe=(a,o,t)=>{if(t<=0)return{from:0,to:0,total:0};const d=Math.max(1,Math.ceil(t/o)),u=Math.min(Math.max(a,1),d),c=(u-1)*o+1,l=Math.min(u*o,t);return{from:c,to:l,total:t}},ke=({pageSizeConfig:a,totalCount:o=0,columns:t=[],rows:d=[],paginationConfig:u,alertMessageConfig:c={heading:"",description:"",type:"success"},loading:l=!1,className:P="",variant:E="secondary",skeletonRowCount:p=10,emptyTitle:g,header:_,footer:m,withWrapper:S})=>{var M,N;const v=he({title:"PurchaseOrders.purchaseOrdersTable.noPurchaseOrders.default"}),{heading:L,description:I,type:y}=c,{currentPage:U,totalPages:w,handlePageChange:A}=u,{pageSizeOptionsList:h,onChange:k}=a,{from:F,to:$,total:B}=Oe(U,+((M=h.find(T=>T.selected))==null?void 0:M.value)||0,o),f=q(ce,{children:[L||I?i(oe,{heading:L,description:I,type:y}):null,_?i("div",{className:"purchase-orders-table__header",children:_}):null,i(ie,{className:"purchase-orders-table__table-wrapper",mobileLayout:"stacked",columns:t,rowData:d,loading:l,skeletonRowCount:+p}),!l&&d.length===0&&i("div",{className:"purchase-orders-table__empty-state",role:"status","aria-live":"polite",children:i("p",{children:g||v.title})}),o>0?q("div",{className:"purchase-orders-table__pagination-wrapper",children:[o?i("div",{className:"purchase-orders-table__pagination-counter",children:i(j,{id:"PurchaseOrders.purchaseOrdersTable.pagination.status",fields:{from:F,to:$,total:B}})}):null,w>1&&i(le,{className:"purchase-orders-table__pagination",currentPage:U,totalPages:w,onChange:A}),o>0&&h.length?q("div",{className:"purchase-orders-table__pagination-page-size",children:[i(j,{id:"PurchaseOrders.purchaseOrdersTable.pagination.pageSizeLabel.start"}),i(de,{disabled:l,handleSelect:k,options:h,value:((N=h.find(T=>T.selected))==null?void 0:N.value)||""}),i(j,{id:"PurchaseOrders.purchaseOrdersTable.pagination.pageSizeLabel.end"})]}):null]}):null,m?i("div",{className:"purchase-orders-table__footer",children:m}):null]});return S?i(ue,{variant:E,"data-testid":"addressCard",className:K(["b2b-purchase-order-purchase-orders-table",P]),children:f}):i("div",{"data-testid":"addressCard",className:K(["b2b-purchase-order-purchase-orders-table",P]),children:f})},Me=({headerText:a})=>i(pe,{title:a,divider:!1,className:"purchase-orders-header","data-testid":"purchase-orders-header"});var Q=(a=>(a.CUSTOMER_PURCHASE_ORDERS="customerPurchaseOrders",a.COMPANY_PURCHASE_ORDERS="companyPurchaseOrders",a.CUSTOMER_APPROVAL_PURCHASE_ORDERS="customerApprovalPurchaseOrders",a))(Q||{});const Ne=[{text:"10",value:"10",selected:!1},{text:"20",value:"20",selected:!0},{text:"30",value:"30",selected:!1},{text:"50",value:"50",selected:!1}],re=[{key:"action",label:"Action"},{key:"poNumber",label:"PO #"},{key:"orderNumber",label:"Order #"},{key:"status",label:"Status"},{key:"createdBy",label:"Created By"},{key:"total",label:"Total"},{key:"createdDate",label:"Created"},{key:"updatedDate",label:"Updated"}],be=[{key:"checkboxView",label:""},...re],_e=20,Te=({view:a,initialPageSize:o,routePurchaseOrderDetails:t,setColumns:d,setRowsData:u,t:c,permissions:l,loadingPermissions:P})=>{const E=a===Q.COMPANY_PURCHASE_ORDERS,p=a===Q.CUSTOMER_APPROVAL_PURCHASE_ORDERS,[g,_]=C([]),[m,S]=C([]),[v,L]=C(o),[I,y]=C(!0),[U,w]=C({currentPage:1,totalPages:1,totalCount:0}),[A,h]=C({heading:"",description:"",type:"success"});G(()=>{if(A.heading||A.description){const r=setTimeout(()=>{h({heading:"",description:"",type:"success"})},7e3);return()=>clearTimeout(r)}},[A.heading,A.description]);const{currentPage:k,totalPages:F,totalCount:$}=U,B=R(r=>{const n=r.target.value;L(e=>e.map(s=>({...s,selected:s.value===n})))},[]),f=(l==null?void 0:l.isAdmin)??!1,M=z(()=>{let r={};return E&&(r={companyPurchaseOrders:!0}),p&&(r={requireMyApproval:!0}),r},[E,p]);G(()=>{var e;if(P)return;y(!0);const r=(e=v==null?void 0:v.find(s=>s.selected))==null?void 0:e.value,n=parseInt(r??_e.toString(),10);ge(M,n,k).then(s=>{var D,x;const O=(s==null?void 0:s.purchaseOrderItems)??[],b=(D=s==null?void 0:s.pageInfo)==null?void 0:D.currentPage,V=(x=s==null?void 0:s.pageInfo)==null?void 0:x.totalPages,H=s==null?void 0:s.totalCount;w({currentPage:b,totalPages:V,totalCount:H}),S(O)}).catch(s=>{console.error("Failed to fetch purchase orders:",s)}).finally(()=>{y(!1)})},[k,v,M,P]);const N=R(r=>{const n=t==null?void 0:t(r);return fe(n??"")?n:"#"},[t]),T=R(r=>{w(n=>({...n,currentPage:r}))},[]),W=R(r=>{const n=r.target.value,e=r.target.checked;_(s=>e?[...s,n]:s.filter(O=>O!==n))},[]),Y=R(r=>{const n=r.target.checked;_(()=>n?m.filter(e=>["PENDING","APPROVAL_REQUIRED"].includes(e.status)).map(e=>e.uid??""):[])},[m]),se=R(()=>{me(g).then(r=>{const n=(r==null?void 0:r.purchaseOrders)??[];S(e=>e.map(s=>n.find(b=>b.uid===s.uid)??s)),h({heading:c.alertHeaderReject,description:c.alertDescriptionReject,type:"success"}),_([])}).catch(r=>{h({heading:c.alertHeaderError,description:c.alertDescriptionError,type:"error"}),console.error(r)}).finally(()=>{y(!1)})},[g,c]),ae=R(()=>{y(!0),Pe(g).then(r=>{const n=(r==null?void 0:r.purchaseOrders)??[];S(e=>e.map(s=>n.find(b=>b.uid===s.uid)??s)),h({heading:c.alertHeaderApprove,description:c.alertDescriptionApprove,type:"success"}),_([])}).catch(r=>{h({heading:c.alertHeaderError,description:c.alertDescriptionError,type:"error"}),console.error(r)}).finally(()=>{y(!1)})},[g,c]),te=z(()=>{const r=E||p?be:re;return(d==null?void 0:d(r))??r.map(n=>n.key==="checkboxView"&&(f||p)?{key:n.key,label:i("input",{type:"checkbox",name:"selectAll",disabled:m.every(e=>!["PENDING","APPROVAL_REQUIRED"].includes(e.status)),onChange:Y}),ariaLabel:c.selectAllAriaLabel}:{...n,label:c[n.key]||n.label})},[c,f,E,p,d,m,Y]),ne=z(()=>{const r=m.map(e=>{var O,b,V,H,D,x,Z,J;const s=e.number??"";return{...f||p?{checkboxView:i("input",{type:"checkbox",name:s,value:e.uid,checked:g.includes(e.uid),onChange:W,disabled:!["PENDING","APPROVAL_REQUIRED"].includes(e.status)})}:{},poNumber:s,orderNumber:e.order.orderNumber,createdDate:ee(e.createdAt),updatedDate:ee(e.updatedAt),createdBy:`${((O=e.createdBy)==null?void 0:O.firstname)??""} ${((b=e.createdBy)==null?void 0:b.lastname)??""}`.trim(),status:i(j,{id:`PurchaseOrders.purchaseOrdersTable.statusOrder.${e.status.toLowerCase()}`}),total:`${(D=(H=(V=e==null?void 0:e.quote)==null?void 0:V.prices)==null?void 0:H.grandTotal)==null?void 0:D.value} ${(J=(Z=(x=e==null?void 0:e.quote)==null?void 0:x.prices)==null?void 0:Z.grandTotal)==null?void 0:J.currency}`,action:i("a",{href:N(s),"aria-label":`View purchase order ${s}`,children:c.actionView})}});let n=r;if(u){const e=u(r);e!==void 0&&Array.isArray(e)&&(n=e)}return n},[m,u,f,p,g,W,N,c.actionView]);return{totalCount:$,loading:I,tableConfig:{columns:te,rows:ne},paginationConfig:{currentPage:k,totalPages:F,handlePageChange:T},pageSizeConfig:{pageSizeOptionsList:v,onChange:B},selectedOrderIds:g,handleRejectSelected:se,handleApproveSelected:ae,isAdmin:f,isRequireApprovalPOsView:p,alertMessageConfig:A}},ve=a=>{if(!a)return{isAdmin:!1,purchaseOrderEnabled:!1,role:{id:"",name:""},permissions:{purchaseOrderAll:!1,viewPurchaseOrders:!1,viewPurchaseOrdersForSubordinates:!1,viewPurchaseOrdersForCompany:!1,autoApprovePurchaseOrder:!1,superApprovePurchaseOrder:!1,viewApprovalRules:!1,manageApprovalRules:!1}};const o=a.admin===!0,t=l=>{const P=a[l];return P===!1?!1:P===!0?!0:o},d={purchaseOrderAll:t("Magento_PurchaseOrder::all"),viewPurchaseOrders:t("Magento_PurchaseOrder::view_purchase_orders"),viewPurchaseOrdersForSubordinates:t("Magento_PurchaseOrder::view_purchase_orders_for_subordinates"),viewPurchaseOrdersForCompany:t("Magento_PurchaseOrder::view_purchase_orders_for_company"),autoApprovePurchaseOrder:t("Magento_PurchaseOrder::autoapprove_purchase_order"),superApprovePurchaseOrder:t("Magento_PurchaseOrderRule::super_approve_purchase_order"),viewApprovalRules:t("Magento_PurchaseOrderRule::view_approval_rules"),manageApprovalRules:t("Magento_PurchaseOrderRule::manage_approval_rules")},c=Object.values(a).some(l=>l===!1)?!1:Object.values(d).some(l=>l===!0);return{isAdmin:o,purchaseOrderEnabled:c,role:{id:"",name:o?"Company Administrator":""},permissions:d}},De=()=>{const a=X.lastPayload("auth/permissions"),[o,t]=C(a);G(()=>{const c=X.on("auth/permissions",l=>{t(l)},{eager:!0});return()=>{c==null||c.off()}},[]);const d=!o;return{permissions:z(()=>ve(o),[o]),loadingPermissions:d}};export{Q as E,Me as P,Te as a,ke as b,Ne as d,De as u};
//# sourceMappingURL=useCustomerRolePermissions.js.map
