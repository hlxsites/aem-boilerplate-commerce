/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as j,Fragment as oe,jsx as o}from"@dropins/tools/preact-jsx-runtime.js";import{InLineAlert as ie,Table as le,Pagination as de,Picker as ue,Card as pe,Header as he,Tag as ge}from"@dropins/tools/components.js";import{classes as X}from"@dropins/tools/lib.js";import{events as Z}from"@dropins/tools/event-bus.js";import{useText as me,Text as z}from"@dropins/tools/i18n.js";import{useState as C,useEffect as q,useCallback as R,useMemo as I}from"@dropins/tools/preact-hooks.js";import{g as Pe,r as fe,a as Oe}from"./getPurchaseOrders.js";const be=s=>{try{return new URL(s,window.location.origin).origin===window.location.origin}catch{return s.startsWith("/")||s.startsWith("./")||s.startsWith("../")}},ee=(s,c="en-US")=>{try{const t=new Date(s);return isNaN(t.getTime())?s:t.toLocaleString(c,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0})}catch{return s}},_e=(s,c,t)=>{if(t<=0)return{from:0,to:0,total:0};const d=Math.max(1,Math.ceil(t/c)),h=Math.min(Math.max(s,1),d),n=(h-1)*c+1,l=Math.min(h*c,t);return{from:n,to:l,total:t}},Se=({pageSizeConfig:s,totalCount:c=0,columns:t=[],rows:d=[],paginationConfig:h,alertMessageConfig:n={heading:"",description:"",type:"success"},loading:l=!1,className:P="",variant:E="secondary",skeletonRowCount:u=10,emptyTitle:m,header:_,footer:p,withWrapper:w})=>{var S,M;const v=me({title:"PurchaseOrders.purchaseOrdersTable.noPurchaseOrders.default"}),{heading:L,description:U,type:y}=n,{currentPage:V,totalPages:k,handlePageChange:A}=h,{pageSizeOptionsList:g,onChange:N}=s,{from:F,to:$,total:B}=_e(V,+((S=g.find(T=>T.selected))==null?void 0:S.value)||0,c),f=j(oe,{children:[L||U?o(ie,{heading:L,description:U,type:y}):null,_?o("div",{className:"purchase-orders-table__header",children:_}):null,o(le,{className:"purchase-orders-table__table-wrapper",mobileLayout:"stacked",columns:t,rowData:d,loading:l,skeletonRowCount:+u}),!l&&d.length===0&&o("div",{className:"purchase-orders-table__empty-state",role:"status","aria-live":"polite",children:o("p",{children:m||v.title})}),c>0?j("div",{className:"purchase-orders-table__pagination-wrapper",children:[c?o("div",{className:"purchase-orders-table__pagination-counter",children:o(z,{id:"PurchaseOrders.purchaseOrdersTable.pagination.status",fields:{from:F,to:$,total:B}})}):null,k>1&&o(de,{className:"purchase-orders-table__pagination",currentPage:V,totalPages:k,onChange:A}),c>0&&g.length?j("div",{className:"purchase-orders-table__pagination-page-size",children:[o(z,{id:"PurchaseOrders.purchaseOrdersTable.pagination.pageSizeLabel.start"}),o(ue,{disabled:l,handleSelect:N,options:g,value:((M=g.find(T=>T.selected))==null?void 0:M.value)||""}),o(z,{id:"PurchaseOrders.purchaseOrdersTable.pagination.pageSizeLabel.end"})]}):null]}):null,p?o("div",{className:"purchase-orders-table__footer",children:p}):null]});return w?o(pe,{variant:E,"data-testid":"addressCard",className:X(["b2b-purchase-order-purchase-orders-table",P]),children:f}):o("div",{"data-testid":"addressCard",className:X(["b2b-purchase-order-purchase-orders-table",P]),children:f})},Me=({headerText:s,tagNumber:c})=>j("div",{className:"purchase-orders-header",children:[o(he,{title:s,divider:!1,className:"purchase-orders-header__header","data-testid":"purchase-orders-header"}),c?o(ge,{label:c}):null]});var G=(s=>(s.CUSTOMER_PURCHASE_ORDERS="customerPurchaseOrders",s.COMPANY_PURCHASE_ORDERS="companyPurchaseOrders",s.CUSTOMER_APPROVAL_PURCHASE_ORDERS="customerApprovalPurchaseOrders",s))(G||{});const Te=[{text:"10",value:"10",selected:!1},{text:"20",value:"20",selected:!0},{text:"30",value:"30",selected:!1},{text:"50",value:"50",selected:!1}],re=[{key:"action",label:"Action"},{key:"poNumber",label:"PO #"},{key:"orderNumber",label:"Order #"},{key:"status",label:"Status"},{key:"createdBy",label:"Created By"},{key:"total",label:"Total"},{key:"createdDate",label:"Created"},{key:"updatedDate",label:"Updated"}],ve=[{key:"checkboxView",label:""},...re],De=({view:s,initialPageSize:c,routePurchaseOrderDetails:t,setColumns:d,setRowsData:h,t:n,permissions:l,loadingPermissions:P})=>{const E=s===G.COMPANY_PURCHASE_ORDERS,u=s===G.CUSTOMER_APPROVAL_PURCHASE_ORDERS,[m,_]=C([]),[p,w]=C([]),[v,L]=C(c),[U,y]=C(!0),[V,k]=C({currentPage:1,totalPages:1,totalCount:0}),[A,g]=C({heading:"",description:"",type:"success"});q(()=>{if(A.heading||A.description){const r=setTimeout(()=>{g({heading:"",description:"",type:"success"})},7e3);return()=>clearTimeout(r)}},[A.heading,A.description]);const{currentPage:N,totalPages:F,totalCount:$}=V,B=R(r=>{const a=r.target.value;L(e=>e.map(i=>({...i,selected:i.value===a})))},[]),f=(l==null?void 0:l.isAdmin)??!1,S=I(()=>{let r={};return E&&(r={companyPurchaseOrders:!0}),u&&(r={requireMyApproval:!0}),r},[E,u]);q(()=>{var a;if(P)return;y(!0);const r=(a=v==null?void 0:v.find(e=>e.selected))==null?void 0:a.value;Pe(S,parseInt(r||"20",10),N).then(e=>{var D,x;const i=(e==null?void 0:e.purchaseOrderItems)??[],O=(D=e==null?void 0:e.pageInfo)==null?void 0:D.currentPage,b=(x=e==null?void 0:e.pageInfo)==null?void 0:x.totalPages,H=e==null?void 0:e.totalCount;k({currentPage:O,totalPages:b,totalCount:H}),w(i)}).catch(e=>{console.error("Failed to fetch purchase orders:",e)}).finally(()=>{y(!1)})},[N,v,S,P]);const M=R(r=>{const a=t==null?void 0:t(r);return be(a??"")?a:"#"},[t]),T=R(r=>{k(a=>({...a,currentPage:r}))},[]),Q=R(r=>{const a=r.target.value,e=r.target.checked;_(i=>e?[...i,a]:i.filter(O=>O!==a))},[]),W=R(r=>{const a=r.target.checked;_(()=>a?p.filter(e=>["PENDING","APPROVAL_REQUIRED"].includes(e.status)).map(e=>e.uid??""):[])},[p]),se=R(()=>{fe(m).then(r=>{const a=(r==null?void 0:r.purchaseOrders)??[];w(e=>e.map(i=>a.find(b=>b.uid===i.uid)??i)),g({heading:n.alertHeaderReject,description:n.alertDescriptionReject,type:"success"}),_([])}).catch(r=>{g({heading:n.alertHeaderError,description:n.alertDescriptionError,type:"error"}),console.error(r)}).finally(()=>{y(!1)})},[m,n]),ae=R(()=>{y(!0),Oe(m).then(r=>{const a=(r==null?void 0:r.purchaseOrders)??[];w(e=>e.map(i=>a.find(b=>b.uid===i.uid)??i)),g({heading:n.alertHeaderApprove,description:n.alertDescriptionApprove,type:"success"}),_([])}).catch(r=>{g({heading:n.alertHeaderError,description:n.alertDescriptionError,type:"error"}),console.error(r)}).finally(()=>{y(!1)})},[m,n]),te=I(()=>{const r=E||u?ve:re;return(d==null?void 0:d(r))??r.map(a=>a.key==="checkboxView"&&(f||u)?{key:a.key,label:o("input",{type:"checkbox",name:"selectAll",disabled:p.every(e=>!["PENDING","APPROVAL_REQUIRED"].includes(e.status)),onChange:W}),ariaLabel:n.selectAllAriaLabel}:{...a,label:n[a.key]||a.label})},[n,f,E,u,d,p,W]),ne=I(()=>{const r=p.map(e=>{var O,b,H,D,x,Y,J,K;const i=e.number??"";return{...f||u?{checkboxView:o("input",{type:"checkbox",name:i,value:e.uid,checked:m.includes(e.uid),onChange:Q,disabled:!["PENDING","APPROVAL_REQUIRED"].includes(e.status)})}:{},poNumber:i,orderNumber:e.order.orderNumber,createdDate:ee(e.createdAt),updatedDate:ee(e.updatedAt),createdBy:`${((O=e.createdBy)==null?void 0:O.firstname)??""} ${((b=e.createdBy)==null?void 0:b.lastname)??""}`.trim(),status:o(z,{id:`PurchaseOrders.purchaseOrdersTable.statusOrder.${e.status.toLowerCase()}`}),total:`${(x=(D=(H=e==null?void 0:e.quote)==null?void 0:H.prices)==null?void 0:D.grandTotal)==null?void 0:x.value} ${(K=(J=(Y=e==null?void 0:e.quote)==null?void 0:Y.prices)==null?void 0:J.grandTotal)==null?void 0:K.currency}`,action:o("a",{href:M(i),"aria-label":`View purchase order ${i}`,children:n.actionView})}});let a=r;if(h){const e=h(r);e!==void 0&&Array.isArray(e)&&(a=e)}return a},[p,h,f,u,m,Q,M,n.actionView]),ce=I(()=>u?p.filter(r=>["PENDING","APPROVAL_REQUIRED"].includes(r.status)).length:0,[u,p]);return{totalCount:$,loading:U,tableConfig:{columns:te,rows:ne},paginationConfig:{currentPage:N,totalPages:F,handlePageChange:T},pageSizeConfig:{pageSizeOptionsList:v,onChange:B},selectedOrderIds:m,handleRejectSelected:se,handleApproveSelected:ae,isAdmin:f,isRequireApprovalPOsView:u,alertMessageConfig:A,pendingApprovalCount:ce}},ye=s=>{if(!s)return{isAdmin:!1,purchaseOrderEnabled:!1,role:{id:"",name:""},permissions:{purchaseOrderAll:!1,viewPurchaseOrders:!1,viewPurchaseOrdersForSubordinates:!1,viewPurchaseOrdersForCompany:!1,autoApprovePurchaseOrder:!1,superApprovePurchaseOrder:!1,viewApprovalRules:!1,manageApprovalRules:!1}};const c=s.admin===!0,t=l=>{const P=s[l];return P===!1?!1:P===!0?!0:c},d={purchaseOrderAll:t("Magento_PurchaseOrder::all"),viewPurchaseOrders:t("Magento_PurchaseOrder::view_purchase_orders"),viewPurchaseOrdersForSubordinates:t("Magento_PurchaseOrder::view_purchase_orders_for_subordinates"),viewPurchaseOrdersForCompany:t("Magento_PurchaseOrder::view_purchase_orders_for_company"),autoApprovePurchaseOrder:t("Magento_PurchaseOrder::autoapprove_purchase_order"),superApprovePurchaseOrder:t("Magento_PurchaseOrderRule::super_approve_purchase_order"),viewApprovalRules:t("Magento_PurchaseOrderRule::view_approval_rules"),manageApprovalRules:t("Magento_PurchaseOrderRule::manage_approval_rules")},n=Object.values(s).some(l=>l===!1)?!1:Object.values(d).some(l=>l===!0);return{isAdmin:c,purchaseOrderEnabled:n,role:{id:"",name:c?"Company Administrator":""},permissions:d}},xe=()=>{const s=Z.lastPayload("auth/permissions"),[c,t]=C(s);q(()=>{const n=Z.on("auth/permissions",l=>{t(l)},{eager:!0});return()=>{n==null||n.off()}},[]);const d=!c;return{permissions:I(()=>ye(c),[c]),loadingPermissions:d}};export{G as E,Me as P,De as a,Se as b,Te as d,xe as u};
//# sourceMappingURL=useCustomerRolePermissions.js.map
