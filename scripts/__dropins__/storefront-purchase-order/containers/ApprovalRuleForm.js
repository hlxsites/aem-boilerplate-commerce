/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as u,jsxs as E,Fragment as w}from"@dropins/tools/preact-jsx-runtime.js";import{classes as F}from"@dropins/tools/lib.js";import{Checkbox as Q,Input as k,TextArea as K,RadioButton as j,MultiSelect as B,Picker as U,Button as x,Card as Y,InLineAlert as X}from"@dropins/tools/components.js";import"@dropins/tools/event-bus.js";import"../chunks/FormLoader.js";import{useReducer as $,useMemo as y,useEffect as z,useCallback as g}from"@dropins/tools/preact-hooks.js";import{u as J}from"../chunks/useCustomerRolePermissions.js";import{c as W,g as Z,u as ee,a as re}from"../chunks/currencyInfo.js";import{t as ae}from"../chunks/case-converter.js";import{g as oe}from"../chunks/getPurchaseOrderApprovalRule.js";import{Text as le,useText as te}from"@dropins/tools/i18n.js";import{P as ie}from"../chunks/PurchaseOrdersHeader.js";import{F as se}from"../chunks/FormLoader2.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/fetch-error.js";import"../chunks/transform-purchase-order-approval-rule.js";const ne=(e,a,l)=>{const r={...e};switch(a){case"status":r.status=l?"ENABLED":"DISABLED";break;case"name":r.name=l;break;case"description":r.description=l;break;case"ruleType":r.condition.attribute=l;break;case"ruleCondition":r.condition.operator=l;break;case"ruleValue":{let t=typeof l=="string"?l.replace(/[^\d]/g,""):String(l);t===""?r.condition.attribute==="NUMBER_OF_SKUS"?r.condition.quantity="":r.condition.amount.value="":r.condition.attribute==="NUMBER_OF_SKUS"?r.condition.quantity=+t:r.condition.amount.value=+t;break}case"ruleConditionCurrency":r.condition.amount.currency=l;break;case"approvers":r.approvers=l;break;case"roleType":r.roleType=l;break;case"appliesTo":r.appliesTo=l;break}return r},L=e=>{const a={};return(!e.name||e.name.trim()==="")&&(a.name="PurchaseOrders.approvalRuleForm.errorsMessages.required"),e.roleType==="specific_roles"&&(!e.appliesTo||e.appliesTo.length===0)&&(a.appliesTo="PurchaseOrders.approvalRuleForm.errorsMessages.approvers"),e.condition.attribute==="NUMBER_OF_SKUS"?e.condition.quantity===""&&(a.ruleValue="PurchaseOrders.approvalRuleForm.errorsMessages.required"):e.condition.amount.value===""&&(a.ruleValue="PurchaseOrders.approvalRuleForm.errorsMessages.required"),(!e.approvers||e.approvers.length===0)&&(a.approvers="PurchaseOrders.approvalRuleForm.errorsMessages.approvers"),a},C=(e,a,l)=>{const r={...a};return Object.keys(e).forEach(t=>{l[t]&&(r[t]=e[t])}),Object.keys(r).forEach(t=>{l[t]&&!e[t]&&delete r[t]}),r},N={GRAND_TOTAL:"ruleTypeGrandTotal",SHIPPING_INCL_TAX:"ruleTypeShippingInclTax",NUMBER_OF_SKUS:"ruleTypeNumberOfSkus"},A={MORE_THAN:"conditionOperatorMoreThan",LESS_THAN:"conditionOperatorLessThan",MORE_THAN_OR_EQUAL_TO:"conditionOperatorMoreThanOrEqualTo",LESS_THAN_OR_EQUAL_TO:"conditionOperatorLessThanOrEqualTo"},q={ALL_USERS:"appliesToAllUsers",SPECIFIC_ROLES:"appliesToSpecificRoles"},pe={status:"ENABLED",name:"",description:"",roleType:"all_users",appliesTo:[],condition:{quantity:"",amount:{currency:"USD",value:""},attribute:"GRAND_TOTAL",operator:"MORE_THAN"},approvers:[]},ue={formValues:pe,isLoading:!1,submitError:null,availableAppliesTo:[],availableRequiresApprovalFrom:[],errors:{},touched:{},currencyCodesList:[{text:"USD",value:"USD"}]},ce={name:!0,appliesTo:!0,ruleValue:!0,approvers:!0},D={REQUIRED:"PurchaseOrders.approvalRuleForm.errorsMessages.required",APPROVERS:"PurchaseOrders.approvalRuleForm.errorsMessages.approvers",FAILED_TO_LOAD:"Failed to load metadata. Please try again.",FAILED_TO_CREATE:"Failed to create approval rule. Please try again."},de=e=>[{text:e[N.GRAND_TOTAL],value:"GRAND_TOTAL"},{text:e[N.SHIPPING_INCL_TAX],value:"SHIPPING_INCL_TAX"},{text:e[N.NUMBER_OF_SKUS],value:"NUMBER_OF_SKUS"}],Te=e=>[{text:e[A.MORE_THAN],value:"MORE_THAN"},{text:e[A.LESS_THAN],value:"LESS_THAN"},{text:e[A.MORE_THAN_OR_EQUAL_TO],value:"MORE_THAN_OR_EQUAL_TO"},{text:e[A.LESS_THAN_OR_EQUAL_TO],value:"LESS_THAN_OR_EQUAL_TO"}],me=e=>[{text:e[q.ALL_USERS],value:"all_users"},{text:e[q.SPECIFIC_ROLES],value:"specific_roles"}],_e="ENABLED",Ee="GRAND_TOTAL",Oe="MORE_THAN",ve="USD",be=0,Re=0,he=e=>Object.keys(N).includes(e),fe=e=>Object.keys(A).includes(e),Ae=e=>{var a,l,r,t,c,s,i,o,O,v;return{status:e.status||_e,name:e.name||"",description:e.description||"",roleType:((a=e.appliesToRoles)==null?void 0:a.length)>0?"specific_roles":"all_users",appliesTo:((l=e.appliesToRoles)==null?void 0:l.map(_=>_.id))||[],condition:{quantity:((r=e.condition)==null?void 0:r.quantity)??be,amount:{currency:((c=(t=e.condition)==null?void 0:t.amount)==null?void 0:c.currency)||ve,value:((i=(s=e.condition)==null?void 0:s.amount)==null?void 0:i.value)??Re},attribute:he((o=e.condition)==null?void 0:o.attribute)?e.condition.attribute:Ee,operator:fe((O=e.condition)==null?void 0:O.operator)?e.condition.operator:Oe},approvers:((v=e.approverRoles)==null?void 0:v.map(_=>_.id))||[]}},V=e=>e!=null&&e!==""&&e!==0;function ye(e){const{roleType:a,appliesTo:l,condition:r,...t}=e,c=a==="all_users"?{appliesTo:[]}:{appliesTo:l};let s={};if(r){const{amount:o,quantity:O,...v}=r,_={...v};V(o==null?void 0:o.value)&&(_.amount=o),V(O)&&(_.quantity=O),s=_}return ae({...t,...c,condition:s})}function Se(e,a){switch(a.type){case"SET_LOADING":return{...e,isLoading:a.payload};case"SET_SUBMIT_ERROR":return{...e,submitError:a.payload};case"SET_FORM_VALUES":return{...e,formValues:a.payload};case"SET_AVAILABLE_APPLIES_TO":return{...e,availableAppliesTo:a.payload};case"SET_AVAILABLE_APPROVERS":return{...e,availableRequiresApprovalFrom:a.payload};case"SET_ERRORS":return{...e,errors:a.payload};case"SET_TOUCHED":return{...e,touched:a.payload};case"SET_CURRENCIES":return{...e,currencyCodesList:a.payload};case"UPDATE_FIELD":{const{key:l,value:r}=a.payload,t=ne(e.formValues,l,r),c={...e.touched,[l]:!0};l==="roleType"&&r==="specific_roles"&&(c.appliesTo=!0);const s=L(t),i=C(s,e.errors,c);return{...e,formValues:t,touched:c,errors:i}}case"TOUCH_FIELD":{const l=a.payload,r={...e.touched,[l]:!0},t=L(e.formValues),c=C(t,e.errors,r);return{...e,touched:r,errors:c}}case"MARK_FIELDS_TOUCHED":{const l={...e.touched,...a.payload},r=L(e.formValues),t=C(r,e.errors,l);return{...e,touched:l,errors:t}}default:return e}}const Le=({t:e,approvalRuleID:a,routeApprovalRulesList:l,onSubmit:r,onChange:t,permissions:c,loadingPermissions:s})=>{const[i,o]=$(Se,ue),O=y(()=>de(e),[e]),v=y(()=>Te(e),[e]),_=y(()=>me(e),[e]);z(()=>{o({type:"SET_LOADING",payload:!0}),W().then(n=>{o({type:"SET_CURRENCIES",payload:n.availableCurrencyCodes})}).catch(n=>{console.error("Failed to fetch currencies:",n)}),Z().then(n=>{const{availableAppliesTo:b,availableRequiresApprovalFrom:R}=n;return o({type:"SET_AVAILABLE_APPLIES_TO",payload:b}),o({type:"SET_AVAILABLE_APPROVERS",payload:R}),a?oe(a):null}).then(n=>{n&&o({type:"SET_FORM_VALUES",payload:Ae(n)}),o({type:"SET_SUBMIT_ERROR",payload:null})}).catch(n=>{console.error("Failed to fetch data:",n),o({type:"SET_SUBMIT_ERROR",payload:D.FAILED_TO_LOAD})}).finally(()=>{o({type:"SET_LOADING",payload:!1})})},[a]);const h=g((n,b)=>{o({type:"UPDATE_FIELD",payload:{key:n,value:b}}),t&&t({...i.formValues,[n]:b})},[t,i.formValues]),m=g(n=>{o({type:"TOUCH_FIELD",payload:n}),t&&t(i.formValues)},[t,i.formValues]),f=g(async()=>{o({type:"SET_LOADING",payload:!0}),o({type:"SET_SUBMIT_ERROR",payload:null}),o({type:"MARK_FIELDS_TOUCHED",payload:ce});const n=L(i.formValues);if(Object.keys(n).length>0){o({type:"SET_ERRORS",payload:n}),o({type:"SET_LOADING",payload:!1});return}const b=ye(i.formValues);try{let R;if(a?R=await ee({uid:a,...b}):R=await re(b),!R.uid){o({type:"SET_SUBMIT_ERROR",payload:D.FAILED_TO_CREATE}),o({type:"SET_LOADING",payload:!1});return}r&&r(i.formValues),l?window.location.href=l():o({type:"SET_LOADING",payload:!1})}catch(R){console.error("Failed to save approval rule:",R),o({type:"SET_SUBMIT_ERROR",payload:D.FAILED_TO_CREATE}),o({type:"SET_LOADING",payload:!1})}},[i.formValues,l,a,r]),T=y(()=>!!(i.isLoading||s||!(c!=null&&c.permissions.viewApprovalRules)&&!(c!=null&&c.permissions.manageApprovalRules)),[i.isLoading,s,c]);return{availableAppliesTo:i.availableAppliesTo,availableRequiresApprovalFrom:i.availableRequiresApprovalFrom,formValues:i.formValues,ruleTypeOptions:O,conditionOperators:v,currencies:i.currencyCodesList,appliesToOptions:_,handleSetFormValues:h,handleSubmit:f,handleFieldTouch:m,errors:i.errors,touched:i.touched,isLoading:i.isLoading,formLoading:T,submitError:i.submitError}},S=({touched:e=!1,error:a,className:l="error-message"})=>!e||!a?null:u("span",{className:l,children:u(le,{id:a})}),Ne=({availableRequiresApprovalFrom:e,conditionOperators:a,availableAppliesTo:l,appliesToOptions:r,ruleTypeOptions:t,currencies:c,formValues:s,errors:i,touched:o,isLoading:O,permissions:v,handleSubmit:_,handleFieldTouch:h,handleSetFormValues:m,routeApprovalRulesList:f,t:T})=>{var b,R;const n=O||!((b=v==null?void 0:v.permissions)!=null&&b.viewApprovalRules);return E("form",{"data-testid":"approval-rule-form",children:[u(Q,{"data-testid":"status-toggle",className:"b2b-purchase-order-approval-rule-form__toggle",disabled:n,name:"status",label:T.formEnabled,checked:s.status==="ENABLED",onChange:p=>{const d=p.target.checked;m("status",d)}}),E("div",{"data-testid":"name-input-container",children:[u(k,{"data-testid":"name-input",className:"b2b-purchase-order-approval-rule-form__name-input",disabled:n,name:"name",floatingLabel:T.inputRuleNameFloatingLabel,placeholder:T.inputRuleNamePlaceholder,value:s.name,error:!!(o.name&&i.name),onChange:p=>{const d=p.target.value;m("name",d)},onBlur:()=>h("name")}),u(S,{touched:o.name,error:i.name})]}),u(K,{"data-testid":"description-textarea",className:"b2b-purchase-order-approval-rule-form__description",disabled:n,name:"description",label:T.textAreaDescriptionLabel,value:s.description,onChange:p=>{const d=p.target.value;m("description",d)}}),E("div",{"data-testid":"applies-to-section",className:"b2b-purchase-order-approval-rule-form__applies-to",children:[u("span",{className:"b2b-purchase-order-approval-rule-form__applies-to-title",children:T.titleAppliesTo}),r.map((p,d)=>u(j,{"data-testid":`applies-to-radio-${d}`,disabled:n,name:"radio-group",value:p.value,label:p.text,checked:s.roleType===p.value,onChange:P=>{const I=P.target.value;m("roleType",I)}},p.value)),s.roleType==="specific_roles"?E("div",{"data-testid":"applies-to-multiselect-container",className:"b2b-purchase-order-approval-rule-form__applies-to-multiselect",children:[u(B,{"data-testid":"applies-to-multiselect",disabled:n,name:"appliesTo",value:[...s.appliesTo],options:l.map(p=>({value:p.id,label:p.name})),error:!!(o.appliesTo&&i.appliesTo),onChange:p=>{m("appliesTo",p),o.appliesTo||h("appliesTo")}}),u(S,{touched:o.appliesTo,error:i.appliesTo})]}):null]}),E("div",{"data-testid":"rule-type-section",className:"b2b-purchase-order-approval-rule-form__rule-type",children:[u("span",{className:"b2b-purchase-order-approval-rule-form__rule-type-title",children:T.titleRuleType}),u(U,{"data-testid":"rule-type-picker",className:"b2b-purchase-order-approval-rule-form__rule-type-picker",disabled:n,name:"ruleType",value:s.condition.attribute,options:t,handleSelect:p=>{const d=p.target.value;m("ruleType",d)}})]}),E("div",{"data-testid":"rule-condition-section",className:"b2b-purchase-order-approval-rule-form__rule-condition",children:[u("span",{className:"b2b-purchase-order-approval-rule-form__rule-condition-title",children:(R=t.find(p=>p.value===s.condition.attribute))==null?void 0:R.text}),E("div",{className:F(["b2b-purchase-order-approval-rule-form__rule-condition-container",["b2b-purchase-order-approval-rule-form__rule-condition-container--error",!!i.ruleValue&&o.ruleValue]]),children:[u(U,{"data-testid":"rule-condition-picker",className:"b2b-purchase-order-approval-rule-form__rule-condition-picker",disabled:n,name:"ruleCondition",value:s.condition.operator,options:a,handleSelect:p=>{const d=p.target.value;m("ruleCondition",d)}}),E("div",{"data-testid":"rule-value-container",children:[u(k,{"data-testid":"rule-value-input",className:"b2b-purchase-order-approval-rule-form__rule-value-input",disabled:n,name:"ruleValue",floatingLabel:s.condition.attribute==="NUMBER_OF_SKUS"?T.inputQuantityFloatingLabel:T.inputAmountFloatingLabel,placeholder:s.condition.attribute==="NUMBER_OF_SKUS"?T.inputQuantityPlaceholder:T.inputAmountPlaceholder,value:s.condition.attribute==="NUMBER_OF_SKUS"?s.condition.quantity:s.condition.amount.value,error:!!(o.ruleValue&&i.ruleValue),onChange:p=>{const d=p.target.value;m("ruleValue",d)},onBlur:()=>h("ruleValue")}),u(S,{touched:o.ruleValue,error:i.ruleValue})]}),s.condition.attribute!=="NUMBER_OF_SKUS"?u(U,{"data-testid":"rule-condition-currency-picker",className:"b2b-purchase-order-approval-rule-form__rule-condition-currency-picker",disabled:n,name:"ruleConditionCurrency",value:s.condition.amount.currency,options:c,handleSelect:p=>{const d=p.target.value;m("ruleConditionCurrency",d)}}):null]})]}),E("div",{"data-testid":"approval-role-section",className:"b2b-purchase-order-approval-rule-form__approval-role",children:[u("span",{className:"b2b-purchase-order-approval-rule-form__approval-role-title",children:T.titleRequiresApprovalRole}),E("div",{className:"b2b-purchase-order-approval-rule-form__approval-role-multiselect",children:[u(B,{"data-testid":"approvers-multiselect",disabled:n,name:"approvers",value:[...s.approvers],options:e.map(p=>({value:p.id,label:p.name})),error:!!(o.approvers&&i.approvers),onChange:p=>{m("approvers",p),o.approvers||h("approvers")}}),u(S,{touched:o.approvers,error:i.approvers})]})]}),E("div",{"data-testid":"form-buttons",className:"b2b-purchase-order-approval-rule-form__buttons",children:[u(x,{"data-testid":"save-button",type:"button",disabled:n,onClick:_,children:T.buttonSave}),u(x,{"data-testid":"cancel-button",disabled:O,variant:"secondary",type:"button",onClick:()=>{window.location.href=(f==null?void 0:f())??""},children:T.buttonCancel})]})]})},Fe=({className:e,approvalRuleID:a,withHeader:l,withWrapper:r,routeApprovalRulesList:t,onSubmit:c,onChange:s})=>{const i=te({headerText:"PurchaseOrders.approvalRuleForm.headerText",titleAppliesTo:"PurchaseOrders.approvalRuleForm.titleAppliesTo",titleRuleType:"PurchaseOrders.approvalRuleForm.titleRuleType",titleRequiresApprovalRole:"PurchaseOrders.approvalRuleForm.titleRequiresApprovalRole",formEnabled:"PurchaseOrders.approvalRuleForm.fields.enabled",formDisabled:"PurchaseOrders.approvalRuleForm.fields.disabled",inputRuleNameFloatingLabel:"PurchaseOrders.approvalRuleForm.fields.inputRuleName.floatingLabel",inputRuleNamePlaceholder:"PurchaseOrders.approvalRuleForm.fields.inputRuleName.placeholder",textAreaDescriptionLabel:"PurchaseOrders.approvalRuleForm.fields.textAreaDescription.label",appliesToAllUsers:"PurchaseOrders.approvalRuleForm.fields.appliesTo.allUsers",appliesToSpecificRoles:"PurchaseOrders.approvalRuleForm.fields.appliesTo.specificRoles",ruleTypeGrandTotal:"PurchaseOrders.approvalRuleForm.fields.ruleTypeOptions.grandTotal",ruleTypeShippingInclTax:"PurchaseOrders.approvalRuleForm.fields.ruleTypeOptions.shippingInclTax",ruleTypeNumberOfSkus:"PurchaseOrders.approvalRuleForm.fields.ruleTypeOptions.numberOfSkus",conditionOperatorMoreThan:"PurchaseOrders.approvalRuleForm.fields.conditionOperators.moreThan",conditionOperatorLessThan:"PurchaseOrders.approvalRuleForm.fields.conditionOperators.lessThan",conditionOperatorMoreThanOrEqualTo:"PurchaseOrders.approvalRuleForm.fields.conditionOperators.moreThanOrEqualTo",conditionOperatorLessThanOrEqualTo:"PurchaseOrders.approvalRuleForm.fields.conditionOperators.lessThanOrEqualTo",inputQuantityFloatingLabel:"PurchaseOrders.approvalRuleForm.fields.inputQuantity.floatingLabel",inputQuantityPlaceholder:"PurchaseOrders.approvalRuleForm.fields.inputQuantity.placeholder",inputAmountFloatingLabel:"PurchaseOrders.approvalRuleForm.fields.inputAmount.floatingLabel",inputAmountPlaceholder:"PurchaseOrders.approvalRuleForm.fields.inputAmount.placeholder",buttonCancel:"PurchaseOrders.approvalRuleForm.fields.buttons.cancel",buttonSave:"PurchaseOrders.approvalRuleForm.fields.buttons.save"}),{permissions:o,loadingPermissions:O}=J(),{availableRequiresApprovalFrom:v,conditionOperators:_,availableAppliesTo:h,appliesToOptions:m,ruleTypeOptions:f,currencies:T,formValues:n,errors:b,touched:R,isLoading:p,submitError:d,formLoading:P,handleSubmit:I,handleFieldTouch:H,handleSetFormValues:G}=Le({t:i,approvalRuleID:a,loadingPermissions:O,permissions:o,routeApprovalRulesList:t,onSubmit:c,onChange:s});if(P)return u(se,{testId:"b2b-purchase-order-approval-rule-form",className:F(["b2b-purchase-order-approval-rule-form",e])});const M=E(w,{children:[!!d&&u(X,{heading:"",description:d}),u(Ne,{availableRequiresApprovalFrom:v,conditionOperators:_,availableAppliesTo:h,appliesToOptions:m,ruleTypeOptions:f,currencies:T,formValues:n,errors:b,touched:R,isLoading:p,handleSubmit:I,handleFieldTouch:H,handleSetFormValues:G,permissions:o,routeApprovalRulesList:t,t:i})]});return E("div",{"data-testid":"b2b-purchase-order-approval-rule-form",className:F(["b2b-purchase-order-approval-rule-form",e]),children:[l?u(ie,{headerText:i.headerText}):null,r?u(Y,{variant:"secondary",children:M}):M]})},je=({withHeader:e=!0,withWrapper:a=!0,className:l,approvalRuleID:r,routeApprovalRulesList:t,onSubmit:c,onChange:s})=>u("div",{"data-testid":"b2b-purchase-order-approval-rule-form-container",className:F(["b2b-purchase-order-approval-rule-form-container",l]),children:u(Fe,{withWrapper:a,withHeader:e,approvalRuleID:r,routeApprovalRulesList:t,onSubmit:c,onChange:s})});export{je as ApprovalRuleForm,je as default};
//# sourceMappingURL=ApprovalRuleForm.js.map
