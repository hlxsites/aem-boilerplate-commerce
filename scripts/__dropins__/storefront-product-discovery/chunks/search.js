/*! Copyright 2026 Adobe
All Rights Reserved. */
var ue=Object.defineProperty;var le=(e,r,t)=>r in e?ue(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t;var P=(e,r,t)=>le(e,typeof r!="symbol"?r+"":r,t);import{merge as se}from"@dropins/tools/lib.js";import{c as oe}from"./initialize.js";import{events as y}from"@dropins/tools/event-bus.js";import{ProductView as ce,Facet as me}from"../fragments.js";import{S as pe,P as ge,u as fe,s as he,a as ye,b as Se}from"./acdlEvents.js";import{FetchGraphQL as we}from"@dropins/tools/fetch-graphql.js";const{setEndpoint:Ae,setFetchGraphQlHeader:De,removeFetchGraphQlHeader:ke,setFetchGraphQlHeaders:Ee,getFetchGraphQlHeader:Te,fetchGraphQl:Pe,getConfig:Be}=new we().getMethods(),h=e=>!e||!Intl.supportedValuesOf("currency").includes(e)?"USD":e,be=e=>{var t,i,n,o,s,u,l,c,p,m,g,f,a,F,R,_,I,v,$,U,N,z,x,O,A,D,k,E,T,B,J,Q,G,H,K,M,W,j,L,Y,q,X,Z,V,d,ee,te,S,re;if(!e)return{id:"",name:"",sku:"",shortDescription:"",url:"",urlKey:"",metaTitle:"",metaKeywords:"",metaDescription:"",lowStock:!1,links:[],images:[],description:"",externalId:"",inputOptions:[],addToCartAllowed:!1,price:void 0,priceRange:void 0,inStock:!1,typename:""};const r={id:(e==null?void 0:e.id)||"",name:(e==null?void 0:e.name)||"",sku:(e==null?void 0:e.sku)||"",shortDescription:(e==null?void 0:e.shortDescription)||"",url:(e==null?void 0:e.url)||"",urlKey:(e==null?void 0:e.urlKey)||"",metaTitle:(e==null?void 0:e.metaTitle)||"",metaKeywords:(e==null?void 0:e.metaKeywords)||"",metaDescription:(e==null?void 0:e.metaDescription)||"",lowStock:(e==null?void 0:e.lowStock)||!1,links:(e==null?void 0:e.links)||[],images:((t=e==null?void 0:e.images)==null?void 0:t.map(w=>{var ie;return{label:w.label||"",roles:w.roles||[],url:((ie=w.url)==null?void 0:ie.replace(/^https?:\/\//,"//"))||""}}))||[],description:(e==null?void 0:e.description)||"",externalId:(e==null?void 0:e.externalId)||"",inputOptions:(e==null?void 0:e.inputOptions)||[],addToCartAllowed:(e==null?void 0:e.addToCartAllowed)||!1,price:e.price?{final:{amount:{value:((o=(n=(i=e==null?void 0:e.price)==null?void 0:i.final)==null?void 0:n.amount)==null?void 0:o.value)||0,currency:h((l=(u=(s=e==null?void 0:e.price)==null?void 0:s.final)==null?void 0:u.amount)==null?void 0:l.currency)}},regular:{amount:{value:((m=(p=(c=e==null?void 0:e.price)==null?void 0:c.regular)==null?void 0:p.amount)==null?void 0:m.value)||0,currency:h((a=(f=(g=e==null?void 0:e.price)==null?void 0:g.regular)==null?void 0:f.amount)==null?void 0:a.currency)}},roles:((F=e==null?void 0:e.price)==null?void 0:F.roles)||[]}:void 0,priceRange:e!=null&&e.priceRange?{minimum:{final:{amount:{value:((v=(I=(_=(R=e==null?void 0:e.priceRange)==null?void 0:R.minimum)==null?void 0:_.final)==null?void 0:I.amount)==null?void 0:v.value)||0,currency:h((z=(N=(U=($=e==null?void 0:e.priceRange)==null?void 0:$.minimum)==null?void 0:U.final)==null?void 0:N.amount)==null?void 0:z.currency)}},regular:{amount:{value:((D=(A=(O=(x=e==null?void 0:e.priceRange)==null?void 0:x.minimum)==null?void 0:O.regular)==null?void 0:A.amount)==null?void 0:D.value)||0,currency:h((B=(T=(E=(k=e==null?void 0:e.priceRange)==null?void 0:k.minimum)==null?void 0:E.regular)==null?void 0:T.amount)==null?void 0:B.currency)}}},maximum:{final:{amount:{value:((H=(G=(Q=(J=e==null?void 0:e.priceRange)==null?void 0:J.maximum)==null?void 0:Q.final)==null?void 0:G.amount)==null?void 0:H.value)||0,currency:h((j=(W=(M=(K=e==null?void 0:e.priceRange)==null?void 0:K.maximum)==null?void 0:M.final)==null?void 0:W.amount)==null?void 0:j.currency)}},regular:{amount:{value:((X=(q=(Y=(L=e==null?void 0:e.priceRange)==null?void 0:L.maximum)==null?void 0:Y.regular)==null?void 0:q.amount)==null?void 0:X.value)||0,currency:h((ee=(d=(V=(Z=e==null?void 0:e.priceRange)==null?void 0:Z.maximum)==null?void 0:V.regular)==null?void 0:d.amount)==null?void 0:ee.currency)}}}}:void 0,inStock:(e==null?void 0:e.inStock)||!1,typename:(e==null?void 0:e.__typename)||""};return se(r,(re=(S=(te=oe.getConfig().models)==null?void 0:te.Product)==null?void 0:S.transformer)==null?void 0:re.call(S,e))};function Ce(e,r){var n,o,s,u,l,c,p,m,g;const t=e==null?void 0:e.productSearch,i={facets:Fe((t==null?void 0:t.facets)||[],r),items:(t==null?void 0:t.items.map(f=>be(f==null?void 0:f.productView)))||[],pageInfo:{currentPage:((n=t==null?void 0:t.page_info)==null?void 0:n.current_page)||1,totalPages:((o=t==null?void 0:t.page_info)==null?void 0:o.total_pages)||1,totalItems:((s=t==null?void 0:t.page_info)==null?void 0:s.total_items)||0,pageSize:((u=t==null?void 0:t.page_info)==null?void 0:u.page_size)||10},totalCount:(t==null?void 0:t.total_count)||0,metadata:{filterableAttributes:((l=e==null?void 0:e.attributeMetadata)==null?void 0:l.filterableInSearch)||[],sortableAttributes:ae(((c=e==null?void 0:e.attributeMetadata)==null?void 0:c.sortable)||[],r)}};return se(i,(g=(m=(p=oe.getConfig().models)==null?void 0:p.ProductSearchResult)==null?void 0:m.transformer)==null?void 0:g.call(m,e))}function ae(e=[],r){return!e||e.length===0?[]:e.filter(t=>{var i;return t.attribute==="position"?(i=r==null?void 0:r.filter)==null?void 0:i.some(o=>o.attribute==="categoryPath"):!0}).map(t=>({...t,bidirectional:t.attribute==="price"}))}function Fe(e=[],r){var o,s;if(!e||e.length===0)return[];if((o=r==null?void 0:r.filter)==null?void 0:o.some(u=>u.attribute==="categoryPath"))return e.filter(u=>u.attribute!=="categories");const i=(s=r==null?void 0:r.filter)==null?void 0:s.find(u=>u.attribute==="categories"),n=(i==null?void 0:i.in)||[];return e.map(u=>u.attribute==="categories"?Re(u,n):u)}function Re(e,r){if(!e.buckets||e.buckets.length===0||r.length===0)return e;const t=new Map;return r.forEach(i=>{if(e.buckets.filter(o=>o.path?o.path.startsWith(i+"/"):!1).length>0&&e.buckets.every(s=>s.path?s.path.startsWith(i+"/")||s.path===i:!1)){const s=e.buckets.find(u=>u.path===i);if(s)t.set(i,s);else{const u=e.buckets.reduce((l,c)=>l+(c.count||0),0);t.set(i,{title:i,__typename:"CategoryView",count:u,path:i})}}}),t.size>0?{...e,buckets:Array.from(t.values())}:e}const _e=`
  query productSearch(
    $phrase: String!
    $pageSize: Int
    $currentPage: Int = 1
    $filter: [SearchClauseInput!]
    $sort: [ProductSearchSortInput!]
    $context: QueryContextInput
  ) {
    attributeMetadata {
      sortable {
        label
        attribute
        numeric
      }
      filterableInSearch {
        label
        attribute
        numeric
      }
    }

    productSearch(
      phrase: $phrase
      page_size: $pageSize
      current_page: $currentPage
      filter: $filter
      sort: $sort
      context: $context
    ) {
      total_count
      items {
        ...ProductView
      }
      facets {
        ...Facet
      }
      page_info {
        current_page
        page_size
        total_pages
      }
    }
  }
  ${ce}
  ${me}
`;class Ie{constructor(){P(this,"state",{});P(this,"initialized",!1)}initialize(){var u;if(this.initialized)return this.state;const r=new URLSearchParams(window.location.search),t=((u=r.get("q"))==null?void 0:u.trim())||"",i=Number(r.get("page"))||1,n=this.parseSortFromUrl(r.get("sort")),o=this.parseFiltersFromUrl(r.get("filter")),s=this.getCategoryFromPath();return this.state={phrase:t,currentPage:i,sort:n,filter:this.mergeCategoryFilter(o,s),pageSize:12},this.initialized=!0,this.state}getState(){return this.initialized?{...this.state}:this.initialize()}updateState(r,t=!0,i=!1){const n={...this.state};if(this.state={...this.state,...r},r.filter!==void 0){const o=r.filter||[];if(i||o.length===0)this.state.filter=o;else{const s=n.filter||[];this.state.filter=this.deduplicateFilters([...s,...o])}}if(!r.currentPage){const o=r.filter!==void 0&&JSON.stringify(n.filter)!==JSON.stringify(this.state.filter),s=r.sort&&JSON.stringify(n.sort)!==JSON.stringify(this.state.sort);(o||s)&&(this.state.currentPage=1)}return t&&this.syncUrlFromState(),this.hasStateChanged(n,this.state)}reset(){this.state={},this.initialized=!1}syncUrlFromState(){var s;const r=new URLSearchParams;if(this.state.phrase&&r.set("q",this.state.phrase),this.state.currentPage&&this.state.currentPage>1&&r.set("page",String(this.state.currentPage)),this.state.sort&&this.state.sort.length>0){const u=this.state.sort.map(l=>`${l.attribute}:${l.direction}`).join(",");r.set("sort",u)}const t=((s=this.state.filter)==null?void 0:s.filter(u=>u.attribute!=="categoryPath"))||[],i=this.deduplicateFilters(t);if(i.length>0){const u=i.map(l=>{var c;return l.range?`${l.attribute}:${l.range.from}-${l.range.to}`:(c=l.in)!=null&&c.length?`${l.attribute}:${l.in.join(",")}`:null}).filter(Boolean).join("|");u&&r.set("filter",u)}const n=r.toString(),o=n?`${window.location.pathname}?${n}`:window.location.pathname;window.history.replaceState({},"",o)}deduplicateFilters(r){return r.reduce((i,n)=>{if(n.in&&n.in.length===0||!n.in&&!n.range&&!n.eq&&!n.contains&&!n.startsWith)return i;const s=i.findIndex(u=>u.attribute===n.attribute);return s===-1?i.push(n):i[s]=n,i},[])}parseSortFromUrl(r){return!r||!r.trim()?[]:r.split(",").map(t=>{if(t=t.trim(),!t)return null;let i="",n="ASC";if(t.includes(":"))[i,n]=t.split(":");else if(t.includes("_")){const o=t.lastIndexOf("_");i=t.slice(0,o),n=t.slice(o+1).toUpperCase()==="DESC"?"DESC":"ASC"}else i=t;return i==="position"?null:{attribute:i,direction:n}}).filter(Boolean)}parseFiltersFromUrl(r){return!r||!r.trim()?[]:decodeURIComponent(r.replace(/\+/g,"%20")).split(/\||;/).reduce((i,n)=>{const o=n.trim();if(!o.includes(":"))return i;const[s,...u]=o.split(":"),l=u.join(":").trim();if(!s||!l)return i;if(s==="price"&&l.includes("-")){const[c,p]=l.split("-"),m=Number(c),g=Number(p);return!Number.isNaN(m)&&!Number.isNaN(g)&&i.push({attribute:"price",range:{from:m,to:g}}),i}if(s==="visibility"){const c=/,(?!\s)/,p=l.includes(",")&&c.test(l)?l.split(c).map(m=>m.trim()):[l];return i.push({attribute:s,in:p}),i}return i.push({attribute:s,in:l.split(/[|,]/).map(c=>c.trim()).filter(Boolean)}),i},[])}getCategoryFromPath(){const r=window.location.pathname.replace(/^\/|\/$/g,"");return!r||r.startsWith("search")?null:r.split("/").pop()||null}mergeCategoryFilter(r,t){if(!t)return r;const i=r.filter(n=>n.attribute!=="categoryPath");return[{attribute:"categoryPath",in:[t]},...i]}hasStateChanged(r,t){return r.phrase!==t.phrase||r.currentPage!==t.currentPage||r.pageSize!==t.pageSize||JSON.stringify(r.sort)!==JSON.stringify(t.sort)||JSON.stringify(r.filter)!==JSON.stringify(t.filter)}}const b=new Ie,C={request:{},result:{facets:[],pageInfo:{currentPage:0,totalPages:0,totalItems:0,pageSize:0},items:[],totalCount:0,suggestions:[],metadata:{filterableAttributes:[],sortableAttributes:[]}}},Je=async(e,r={})=>{const{scope:t,syncUrl:i=!0,replaceFilters:n=!1}=r,o=!t||t==="search";if(e===null)return y.emit("search/result",C,{scope:t}),C.result;if(o){b.getState();const s=i&&!n;b.updateState(e,s,n);const u=b.getState();return ne(u,t)}return ne(e,t)};async function ne(e,r){y.emit("search/loading",!0,{scope:r});try{const t=r==="popover"?pe:ge,i=window.crypto.randomUUID();fe(t,i,e.phrase||"",e.filter||[],e.pageSize||0,e.currentPage||0,e.sort||[]),he(t);const{errors:n,data:o}=await Pe(_e,{method:"GET",variables:{...e}});if(n&&!o)throw new Error("Error fetching product search");const s=Ce(o,e);return ye(t,i,s),Se(t),y.emit("search/result",{request:e,result:s},{scope:r}),s}catch(t){throw y.emit("search/error",t.message,{scope:r}),y.emit("search/result",C,{scope:r}),t}finally{y.emit("search/loading",!1,{scope:r})}}export{De as a,Ee as b,Be as c,Je as d,Pe as f,Te as g,ke as r,Ae as s};
//# sourceMappingURL=search.js.map
