/*! Copyright 2025 Adobe
All Rights Reserved. */
import{FetchGraphQL as I}from"@dropins/tools/fetch-graphql.js";import{s as d}from"./state.js";var g=(e=>(e.NEW="NEW",e.SUBMITTED="SUBMITTED",e.PENDING="PENDING",e.UPDATED="UPDATED",e.OPEN="OPEN",e.ORDERED="ORDERED",e.CLOSED="CLOSED",e.DECLINED="DECLINED",e.EXPIRED="EXPIRED",e.DRAFT="DRAFT",e))(g||{});const{setEndpoint:B,setFetchGraphQlHeader:G,removeFetchGraphQlHeader:z,setFetchGraphQlHeaders:W,fetchGraphQl:H,getConfig:V}=new I().getMethods(),x=["DRAFT","UPDATED","DECLINED","EXPIRED","NEW","OPEN"];function D(e){if(!e.items)return 0;const n=d.config;return(n==null?void 0:n.quoteSummaryDisplayTotal)===0?e.items.length:(n==null?void 0:n.quoteSummaryDisplayTotal)===1?e.total_quantity:e.items.length}function P(e){var a,t,i,l;const n=d.config;return{src:n!=null&&n.useConfigurableParentThumbnail?e.product.thumbnail.url:((t=(a=e.configured_variant)==null?void 0:a.thumbnail)==null?void 0:t.url)||e.product.thumbnail.url,alt:n!=null&&n.useConfigurableParentThumbnail?e.product.thumbnail.label:((l=(i=e.configured_variant)==null?void 0:i.thumbnail)==null?void 0:l.label)||e.product.thumbnail.label}}function w(e){var n;return((n=e.links)==null?void 0:n.length)>0?{count:e.links.length,result:e.links.map(a=>a.title).join(", ")}:null}function E(e,n){return e!=null&&e.length&&[...e].sort((t,i)=>i.quantity-t.quantity).find(t=>n>=t.quantity)||null}function C(e){var u,s;const n=e.quantity,a=e.__typename==="ConfigurableCartItem",t=a?(u=e.configured_variant)==null?void 0:u.price_tiers:e.product.price_tiers,i=a?(s=e.configured_variant)==null?void 0:s.price_range:e.product.price_range,l=E(t,n);return l?l.discount.amount_off>0:(i==null?void 0:i.maximum_price.discount.amount_off)>0}function A(e){var i,l,u,s,_,r,o,c;const n=e.quantity,a=E(e.product.price_tiers,n);if(a)return Math.round(a.discount.percent_off);let t;if(e.__typename==="ConfigurableCartItem")t=(s=(u=(l=(i=e==null?void 0:e.configured_variant)==null?void 0:i.price_range)==null?void 0:l.maximum_price)==null?void 0:u.discount)==null?void 0:s.percent_off;else{if(e.__typename==="BundleCartItem")return;t=(c=(o=(r=(_=e==null?void 0:e.product)==null?void 0:_.price_range)==null?void 0:r.maximum_price)==null?void 0:o.discount)==null?void 0:c.percent_off}if(t!==0)return Math.round(t)}function O(e){var n,a,t,i;return e.__typename==="ConfigurableCartItem"?{value:(a=(n=e.configured_variant)==null?void 0:n.price_range)==null?void 0:a.maximum_price.regular_price.value,currency:(i=(t=e.configured_variant)==null?void 0:t.price_range)==null?void 0:i.maximum_price.regular_price.currency}:{value:e.prices.original_item_price.value,currency:e.prices.original_item_price.currency}}function R(e){var t,i,l,u,s,_;let n,a;if(n=((i=(t=e==null?void 0:e.prices)==null?void 0:t.original_row_total)==null?void 0:i.value)-((u=(l=e==null?void 0:e.prices)==null?void 0:l.row_total)==null?void 0:u.value),a=(_=(s=e==null?void 0:e.prices)==null?void 0:s.row_total)==null?void 0:_.currency,n!==0)return{value:n,currency:a}}function S(e){var n;return((n=e.items)==null?void 0:n.map(a=>{var t,i,l,u,s,_,r,o;return{itemType:a.__typename,uid:a.uid,product:{uid:a.product.uid,sku:a.product.sku,name:a.product.name,priceRange:{maximumPrice:{regularPrice:{value:a.product.price_range.maximum_price.regular_price.value,currency:a.product.price_range.maximum_price.regular_price.currency}}}},image:P(a),links:w(a),discounted:C(a),discountedTotal:{value:a.prices.row_total.value,currency:a.prices.row_total.currency},catalogDiscount:{amountOff:a.prices.catalog_discount.amount_off,percentOff:a.prices.catalog_discount.percent_off},discounts:((i=(t=a.prices)==null?void 0:t.discounts)==null?void 0:i.map(c=>({label:c.label,value:c.value,amount:{value:c.amount.value,currency:c.amount.currency}})))??[],discountPercentage:A(a),insufficientQuantity:(a.__typename==="ConfigurableCartItem"?((l=a.configured_variant)==null?void 0:l.stock_status)??a.product.stock_status:a.product.stock_status)==="IN_STOCK"&&!a.is_available,outOfStock:a.product.stock_status==="OUT_OF_STOCK",stockStatus:a.product.stock_status,quantity:a.quantity,prices:{regularPrice:O(a),priceIncludingTax:{value:a.prices.price_including_tax.value,currency:a.prices.price_including_tax.currency},originalItemPrice:{value:a.prices.original_item_price.value,currency:a.prices.original_item_price.currency},originalRowTotal:{value:a.prices.original_row_total.value,currency:a.prices.original_row_total.currency},rowTotal:{value:a.prices.row_total.value,currency:a.prices.row_total.currency},rowTotalIncludingTax:{value:a.prices.row_total_including_tax.value,currency:a.prices.row_total_including_tax.currency}},savingsAmount:R(a),noteFromBuyer:(u=a.note_from_buyer)==null?void 0:u.map(c=>({createdAt:c.created_at,creatorId:c.creator_id,creatorType:c.creator_type,negotiableQuoteItemUid:c.negotiable_quote_item_uid,note:c.note,noteUid:c.note_uid})),noteFromSeller:(s=a.note_from_seller)==null?void 0:s.map(c=>({createdAt:c.created_at,creatorId:c.creator_id,creatorType:c.creator_type,negotiableQuoteItemUid:c.negotiable_quote_item_uid,note:c.note,noteUid:c.note_uid})),configurableOptions:(_=a.configurable_options)==null?void 0:_.map(c=>({optionLabel:c.option_label,valueLabel:c.value_label})),bundleOptions:(r=a.bundle_options)==null?void 0:r.map(c=>({label:c.label,values:c.values.map(p=>({label:p.label,quantity:p.quantity,originalPrice:{value:p.original_price.value,currency:p.original_price.currency},price:{value:p.priceV2.value,currency:p.priceV2.currency}}))})),customizableOptions:(o=a.customizable_options)==null?void 0:o.map(c=>({type:c.type,label:c.label,values:c.values.map(p=>({label:p.label,value:p.value}))}))}}))||[]}function N(e){return e.every(n=>!n.outOfStock&&!n.insufficientQuantity)}function k(e){var t,i,l,u,s,_;const n=T(e),a=S(e);return{uid:e.uid,name:e.name,createdAt:e.created_at,updatedAt:e.updated_at,expirationDate:e.expiration_date,status:n?g.NEW:e.status,isVirtual:!!e.is_virtual,salesRepName:e.sales_rep_name,buyer:{firstname:e.buyer.firstname,lastname:e.buyer.lastname},templateName:e.template_name,totalQuantity:D(e),comments:(t=e.comments)==null?void 0:t.map(r=>{const o={uid:r.uid,createdAt:r.created_at,author:{firstname:r.author.firstname,lastname:r.author.lastname},text:r.text};return Array.isArray(r.attachments)&&r.attachments.length>0&&(o.attachments=r.attachments.map(c=>({name:c.name,url:c.url}))),o}),prices:e.prices&&{appliedDiscounts:(i=e.prices.discounts)==null?void 0:i.map(r=>({amount:{value:r.amount.value,currency:r.amount.currency},label:r.label,coupon:r.coupon})),appliedTaxes:(l=e.prices.applied_taxes)==null?void 0:l.map(r=>({amount:{value:r.amount.value,currency:r.amount.currency},label:r.label})),discount:e.prices.discounts&&e.prices.grand_total&&b(e.prices.discounts,e.prices.grand_total.currency),grandTotal:e.prices.grand_total&&{value:e.prices.grand_total.value,currency:e.prices.grand_total.currency},grandTotalExcludingTax:e.prices.grand_total_excluding_tax&&{value:e.prices.grand_total_excluding_tax.value,currency:e.prices.grand_total_excluding_tax.currency},subtotalExcludingTax:e.prices.subtotal_excluding_tax&&{value:e.prices.subtotal_excluding_tax.value,currency:e.prices.subtotal_excluding_tax.currency},subtotalIncludingTax:e.prices.subtotal_including_tax&&{value:e.prices.subtotal_including_tax.value,currency:e.prices.subtotal_including_tax.currency},subtotalWithDiscountExcludingTax:e.prices.subtotal_with_discount_excluding_tax&&{value:e.prices.subtotal_with_discount_excluding_tax.value,currency:e.prices.subtotal_with_discount_excluding_tax.currency},...F(e),totalTax:e.prices.applied_taxes&&e.prices.grand_total&&b(e.prices.applied_taxes,e.prices.grand_total.currency)},history:(u=e.history)==null?void 0:u.map(r=>{var o,c,p,f,m,v,y;return{uid:r.uid,createdAt:r.created_at,author:{firstname:r.author.firstname,lastname:r.author.lastname},changeType:r.change_type,changes:{commentAdded:((o=r.changes)==null?void 0:o.comment_added)&&{comment:r.changes.comment_added.comment},customChanges:((c=r.changes)==null?void 0:c.custom_changes)&&{new_value:r.changes.custom_changes.new_value,old_value:r.changes.custom_changes.old_value,title:r.changes.custom_changes.title},expiration:((p=r.changes)==null?void 0:p.expiration)&&{newExpiration:r.changes.expiration.new_expiration,oldExpiration:r.changes.expiration.old_expiration},productsRemoved:((f=r.changes)==null?void 0:f.products_removed)&&{productsRemovedFromCatalog:r.changes.products_removed.products_removed_from_catalog||[],productsRemovedFromQuote:r.changes.products_removed.products_removed_from_quote||[]},statuses:((m=r.changes)==null?void 0:m.statuses)&&{changes:((v=r.changes.statuses.changes)==null?void 0:v.map(h=>({newStatus:h.new_status,oldStatus:h.old_status})))||[]},total:((y=r.changes)==null?void 0:y.total)&&r.changes.total.new_price&&r.changes.total.old_price&&{newPrice:{value:r.changes.total.new_price.value,currency:r.changes.total.new_price.currency},oldPrice:{value:r.changes.total.old_price.value,currency:r.changes.total.old_price.currency}}}}}),items:a,shippingAddresses:(s=e.shipping_addresses)==null?void 0:s.map(r=>{const o={uid:r.uid,firstname:r.firstname,lastname:r.lastname,company:r.company,street:r.street,city:r.city,postcode:r.postcode,country:{code:r.country.code,label:r.country.label},telephone:r.telephone};return r.region&&(o.region={code:r.region.code,label:r.region.label,regionId:r.region.region_id}),o}),canCheckout:["UPDATED","DECLINED"].includes(e.status)&&d.permissions.checkoutQuote&&((_=e.shipping_addresses)==null?void 0:_.length)>0&&N(a),canSendForReview:(n||x.includes(e.status))&&d.permissions.editQuote,canUpdateQuote:(n||x.includes(e.status))&&d.permissions.editQuote,canDelete:!["PENDING","SUBMITTED","ORDERED"].includes(e.status)&&d.permissions.deleteQuote,canClose:e.status?!["DRAFT","CLOSED","ORDERED","OPEN"].includes(e.status):!1,readOnly:!n&&["ORDERED","SUBMITTED","CLOSED","PENDING"].includes(e.status)||!d.permissions.editQuote}}function X(e){return e?k(e):null}function T(e){return e.status==="SUBMITTED"&&!(e.history??[]).some(n=>{var a,t;return n.change_type==="UPDATED"&&(((t=(a=n.changes)==null?void 0:a.statuses)==null?void 0:t.changes)??[]).length>0})}function Q(e){const n=T(e);return{uid:e.uid,name:e.name,createdAt:e.created_at,updatedAt:e.updated_at,status:n?g.NEW:e.status,buyer:{firstname:e.buyer.firstname,lastname:e.buyer.lastname},templateName:e.template_name,prices:{grandTotal:{value:e.prices.grand_total.value,currency:e.prices.grand_total.currency}}}}function K(e){var t;if(!e)return null;const n={items:((t=e.items)==null?void 0:t.filter(i=>i==null?void 0:i.uid).map(Q))||[],pageInfo:{currentPage:e.page_info.current_page,pageSize:e.page_info.page_size,totalPages:e.page_info.total_pages},totalCount:e.total_count,sortFields:e.sort_fields?{default:e.sort_fields.default,options:e.sort_fields.options}:void 0},a=U(n);return{...n,paginationInfo:a||void 0}}function U(e){if(!(e!=null&&e.pageInfo)||!e.totalCount)return null;const{currentPage:n,pageSize:a,totalPages:t}=e.pageInfo,{totalCount:i}=e,l=i>0?(n-1)*a+1:0,u=Math.min(n*a,i);return{currentPage:n,totalCount:i,pageSize:a,startItem:l,endItem:u,totalPages:t,pageSizeOptions:[20,30,50,100,200]}}const j=()=>[20,30,50,100,200];function b(e,n){return e!=null&&e.length?e.reduce((a,t)=>({value:a.value+t.amount.value,currency:t.amount.currency}),{value:0,currency:n}):{value:0,currency:n}}function F(e){var t;if(!e||!((t=e.shipping_addresses)!=null&&t.length))return{};const a=e.shipping_addresses[0].selected_shipping_method;return a?{shippingIncludingTax:a.price_incl_tax&&{value:a.price_incl_tax.value,currency:a.price_incl_tax.currency},shippingExcludingTax:a.price_excl_tax&&{value:a.price_excl_tax.value,currency:a.price_excl_tax.currency}}:{}}export{U as a,K as b,G as c,W as d,V as e,H as f,j as g,z as r,B as s,X as t};
//# sourceMappingURL=transform-quote.js.map
