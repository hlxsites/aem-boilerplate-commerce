/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as B,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{memo as G}from"@dropins/tools/preact-compat.js";import{useState as m,useEffect as O}from"@dropins/tools/preact-hooks.js";import{Card as D,InLineAlert as H,ProgressSpinner as J,Field as _,Input as q,Picker as z,Button as $}from"@dropins/tools/components.js";import{i as K}from"./company-permissions.js";import{g as Q,c as W,u as X,i as Y,a as Z}from"./updateCompanyUser.js";import{useText as L}from"@dropins/tools/i18n.js";import{c as ee}from"./useInLineAlert.js";function te(b){const{mode:N,entityId:p,parentStructureId:g,onSaved:E}=b,c=L({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError"}),[r,y]=m({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[R,d]=m({}),[n,f]=m({}),[w,A]=m(!1),[C,U]=m(null),[T,j]=m(null),[I,x]=m(""),[l,t]=m(""),[i,V]=m(!1);O(()=>{N!=="edit"||!p||(A(!0),Q(p).then(e=>{var h;if(!e)return;const a=e.email||"";y(S=>({...S,firstName:e.firstName||"",lastName:e.lastName||"",email:a,jobTitle:e.jobTitle||"",telephone:e.telephone||"",status:e.status||"ACTIVE"})),t(a),(h=e==null?void 0:e.role)!=null&&h.id&&y(S=>({...S,roleId:e.role.id})),V((e==null?void 0:e.isCompanyAdmin)??!1)}).finally(()=>A(!1)))},[N,p]);const P=e=>/.+@.+\..+/.test(e),F=(e,a)=>e==="firstName"?a!=null&&a.trim()?null:c.firstNameRequired:e==="lastName"?a!=null&&a.trim()?null:c.lastNameRequired:e==="email"?a!=null&&a.trim()?P(a.trim())?null:c.emailInvalid:c.emailRequired:e==="roleId"?a?null:c.selectRole:null,M=(e,a)=>{y(h=>({...h,[e]:a})),e==="email"&&j(null),C&&U(null)};return{values:r,errors:R,touched:n,loading:w,setValue:M,onBlur:async(e,a)=>{a!==void 0&&M(e,a),f(v=>({...v,[e]:!0}));const h=a!==void 0?a:r[e],S=F(e,h);if(d(S?v=>({...v,[e]:S}):v=>{const o={...v};return delete o[e],o}),e==="email"){const o=(a!==void 0?a:r.email||"").trim();if(N==="edit"&&o.toLowerCase()===(l||"").trim().toLowerCase()){j(null);return}if(P(o)&&o!==I){const u=await Y(o);x(o),j(u),u===!1&&d(k=>({...k,email:"A user with this email address is already a member of your company."}))}}},submit:async()=>{const e=["firstName","lastName","email","roleId"],a={};for(const o of e){const u=F(o,r[o]);u&&(a[o]=u)}if(d(a),f({firstName:!0,lastName:!0,email:!0,roleId:!0}),Object.keys(a).length||T===!1){setTimeout(()=>{const o=document.querySelector(".company-user-form__content .dropin-field__hint--error");if(o){const u=o.closest(".dropin-field");if(u){u.scrollIntoView({behavior:"smooth",block:"center"});const k=u.querySelector("input, select");k&&k.focus()}}},100);return}const h=`${r.firstName||""} ${r.lastName||""}`.trim()||r.email||"",v=i||K({id:r.roleId})?"ACTIVE":r.status;try{if(N==="add"){const o=await W({email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",roleId:r.roleId,status:v,targetId:g??null});if(!o){U(c.createUserError);return}E({label:h,structureId:o.structureId,entityId:o.id,type:"user"})}else p&&(await X({id:p,email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",status:v,roleId:r.roleId}),E({label:h,entityId:p,type:"user"}))}catch(o){const u=o instanceof Error?o.message:c.saveUserError;U(u)}},isCompanyAdmin:i,generalError:C}}function ae(){const b=L({loadRolesError:"Company.CompanyStructure.messages.loadRolesError"}),[N,p]=m([]),[g,E]=m(!0),[c,r]=m(null);return O(()=>{let y=!0;return E(!0),Z({pageSize:1e3}).then(R=>{y&&p(R)}).catch(()=>{y&&r(b.loadRolesError)}).finally(()=>{y&&E(!1)}),()=>{y=!1}},[b.loadRolesError]),{roles:N,loading:g,error:c}}const pe=G(({mode:b,entityId:N,parentStructureId:p,permissions:g,onSaved:E,onCancel:c})=>{const r=(g==null?void 0:g.canEditUsers)??!1,{roles:y,loading:R}=ae(),{values:d,errors:n,touched:f,loading:w,setValue:A,onBlur:C,submit:U,isCompanyAdmin:T,generalError:j}=te({mode:b,entityId:N,parentStructureId:p,onSaved:E}),[I,x]=m(!1),l=L({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator",save:"Company.CompanyStructure.shared.buttons.save",cancel:"Company.CompanyStructure.shared.buttons.cancel"});return B("div",{children:[s("h3",{className:"acm-structure-panel__title",children:b==="add"?l.addUser:l.editUser}),B(D,{variant:"secondary",className:`company-user-form__card ${I?"is-working":""}`,children:[j?s(H,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:j}):null,I?s("div",{className:"company-user-form__overlay","aria-live":"polite",children:s(J,{size:"small"})}):null,w||R?s(ee,{}):B("div",{className:"company-user-form__content",children:[s(_,{label:l.jobTitle,className:"acm-structure-panel__field",error:f.jobTitle&&n.jobTitle?n.jobTitle:void 0,children:s(q,{name:"job_title",type:"text",value:d.jobTitle||"",onBlur:t=>{const i=t.target;C("jobTitle",i.value)},variant:"primary",size:"medium"})}),s(_,{label:l.userRole,required:!0,className:"acm-structure-panel__field",error:!T&&f.roleId&&n.roleId?n.roleId:void 0,disabled:T,children:T?s(z,{name:"role",value:"MA==",options:[{value:"MA==",text:l.companyAdministrator}]}):s(z,{name:"role",value:d.roleId||"placeholder",onChange:t=>{var i,V;return A("roleId",String(((i=t==null?void 0:t.target)==null?void 0:i.value)==="placeholder"?"":((V=t==null?void 0:t.target)==null?void 0:V.value)??""))},onBlur:t=>{const i=t.target;C("roleId",i.value==="placeholder"?"":i.value)},options:[{value:"placeholder",text:l.selectRole,disabled:!0},...y.map(t=>({value:t.id,text:t.name}))]})}),s(_,{label:l.firstName,required:!0,className:"acm-structure-panel__field",error:f.firstName&&n.firstName?n.firstName:void 0,children:s(q,{name:"first_name",type:"text",value:d.firstName,onBlur:t=>{const i=t.target;C("firstName",i.value)},variant:"primary",size:"medium"})}),s(_,{label:l.lastName,required:!0,className:"acm-structure-panel__field",error:f.lastName&&n.lastName?n.lastName:void 0,children:s(q,{name:"last_name",type:"text",value:d.lastName,onBlur:t=>{const i=t.target;C("lastName",i.value)},variant:"primary",size:"medium"})}),s(_,{label:l.email,required:!0,className:"acm-structure-panel__field",error:f.email&&n.email?n.email:void 0,children:s(q,{name:"email",type:"email",value:d.email,onBlur:t=>{const i=t.target;C("email",i.value)},placeholder:"jdoe@example.com",variant:"primary",size:"medium"})}),s(_,{label:l.workPhoneNumber,className:"acm-structure-panel__field",error:f.telephone&&n.telephone?n.telephone:void 0,children:s(q,{name:"telephone",type:"text",value:d.telephone||"",onBlur:t=>{const i=t.target;C("telephone",i.value)},variant:"primary",size:"medium"})}),s(_,{label:l.status,className:"acm-structure-panel__field",disabled:T||!r,children:s(z,{name:"status",value:d.status,onChange:t=>{var i;return A("status",String(((i=t==null?void 0:t.target)==null?void 0:i.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:l.active},{value:"INACTIVE",text:l.inactive}]})})]})]}),w||R?null:B("div",{className:"acm-structure-modal__actions",children:[s($,{type:"button",variant:"primary",disabled:I||!r,onClick:async()=>{if(!I){x(!0);try{await U()}finally{x(!1)}}},children:l.save}),s($,{type:"button",variant:"secondary",disabled:I,onClick:c,children:l.cancel})]})]})});export{pe as C};
//# sourceMappingURL=CompanyUserForm.js.map
