/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as L,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{memo as G}from"@dropins/tools/preact-compat.js";import{useState as u,useEffect as D}from"@dropins/tools/preact-hooks.js";import{Card as H,InLineAlert as J,ProgressSpinner as K,Field as g,Input as A,Picker as P,Button as $}from"@dropins/tools/components.js";import{i as Q}from"./company-permissions.js";import{g as W,c as X,u as Y,i as Z}from"./updateCompanyUser.js";import{useText as O}from"@dropins/tools/i18n.js";import{u as ee}from"./useCompanyRoles.js";import{C as ae}from"./CompanyLoaders.js";function te(U){const{mode:I,entityId:h,parentStructureId:E,onSaved:q,onError:v}=U,c=O({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError"}),[r,T]=u({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[w,d]=u({}),[m,p]=u({}),[x,R]=u(!1),[y,j]=u(null),[S,_]=u(null),[N,V]=u(""),[l,a]=u(""),[i,k]=u(!1);D(()=>{I!=="edit"||!h||(R(!0),W(h).then(e=>{var f;if(!e)return;const t=e.email||"";T(b=>({...b,firstName:e.firstName||"",lastName:e.lastName||"",email:t,jobTitle:e.jobTitle||"",telephone:e.telephone||"",status:e.status||"ACTIVE"})),a(t),(f=e==null?void 0:e.role)!=null&&f.id&&T(b=>({...b,roleId:e.role.id})),k((e==null?void 0:e.isCompanyAdmin)??!1)}).finally(()=>R(!1)))},[I,h]);const z=e=>/.+@.+\..+/.test(e),F=(e,t)=>e==="firstName"?t!=null&&t.trim()?null:c.firstNameRequired:e==="lastName"?t!=null&&t.trim()?null:c.lastNameRequired:e==="email"?t!=null&&t.trim()?z(t.trim())?null:c.emailInvalid:c.emailRequired:e==="roleId"?t?null:c.selectRole:null,M=(e,t)=>{T(f=>({...f,[e]:t})),e==="email"&&_(null),y&&j(null)};return{values:r,errors:w,touched:m,loading:x,setValue:M,onBlur:async(e,t)=>{t!==void 0&&M(e,t),p(C=>({...C,[e]:!0}));const f=t!==void 0?t:r[e],b=F(e,f);if(d(b?C=>({...C,[e]:b}):C=>{const o={...C};return delete o[e],o}),e==="email"){const o=(t!==void 0?t:r.email||"").trim();if(I==="edit"&&o.toLowerCase()===(l||"").trim().toLowerCase()){_(null);return}if(z(o)&&o!==N){const n=await Z(o);V(o),_(n),n===!1&&d(B=>({...B,email:"A user with this email address is already a member of your company."}))}}},submit:async()=>{const e=["firstName","lastName","email","roleId"],t={};for(const o of e){const n=F(o,r[o]);n&&(t[o]=n)}if(d(t),p({firstName:!0,lastName:!0,email:!0,roleId:!0}),Object.keys(t).length||S===!1){setTimeout(()=>{const o=document.querySelector(".company-user-form__content .dropin-field__hint--error");if(o){const n=o.closest(".dropin-field");if(n){n.scrollIntoView({behavior:"smooth",block:"center"});const B=n.querySelector("input, select");B&&B.focus()}}},100);return}const f=`${r.firstName||""} ${r.lastName||""}`.trim()||r.email||"",C=i||Q({id:r.roleId})?"ACTIVE":r.status;try{if(I==="add"){const o=await X({email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",roleId:r.roleId,status:C,targetId:E??null});if(!o){const n=c.createUserError;v?v(n):j(n);return}q({label:f,structureId:o.structureId,entityId:o.id,type:"user"})}else h&&(await Y({id:h,email:r.email||"",firstName:r.firstName||"",lastName:r.lastName||"",jobTitle:r.jobTitle||"",telephone:r.telephone||"",status:C,roleId:r.roleId}),q({label:f,entityId:h,type:"user"}))}catch(o){const n=o instanceof Error?o.message:c.saveUserError;v?v(n):j(n)}},isCompanyAdmin:i,generalError:y}}const ye=G(({mode:U,entityId:I,parentStructureId:h,permissions:E,onSaved:q,onCancel:v,onError:c})=>{const r=(E==null?void 0:E.canEditUsers)??!1,{roles:T,isLoading:w}=ee(),{values:d,errors:m,touched:p,loading:x,setValue:R,onBlur:y,submit:j,isCompanyAdmin:S,generalError:_}=te({mode:U,entityId:I,parentStructureId:h,onSaved:q,onError:c?a=>{c(a),v()}:void 0}),[N,V]=u(!1),l=O({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator",save:"Company.CompanyStructure.shared.buttons.save",cancel:"Company.CompanyStructure.shared.buttons.cancel"});return L("div",{children:[s("h3",{className:"acm-structure-panel__title",children:U==="add"?l.addUser:l.editUser}),L(H,{variant:"secondary",className:`company-user-form__card ${N?"is-working":""}`,children:[!c&&_?s(J,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:_}):null,N?s("div",{className:"company-user-form__overlay","aria-live":"polite",children:s(K,{size:"small"})}):null,x||w?s(ae,{}):L("div",{className:"company-user-form__content",children:[s(g,{label:l.jobTitle,className:"acm-structure-panel__field",error:p.jobTitle&&m.jobTitle?m.jobTitle:void 0,children:s(A,{name:"job_title",type:"text",value:d.jobTitle||"",onBlur:a=>{const i=a.target;y("jobTitle",i.value)},variant:"primary",size:"medium"})}),s(g,{label:l.userRole,required:!0,className:"acm-structure-panel__field",error:!S&&p.roleId&&m.roleId?m.roleId:void 0,disabled:S,children:S?s(P,{name:"role",value:"MA==",options:[{value:"MA==",text:l.companyAdministrator}]}):s(P,{name:"role",value:d.roleId||"placeholder",onChange:a=>{var i,k;return R("roleId",String(((i=a==null?void 0:a.target)==null?void 0:i.value)==="placeholder"?"":((k=a==null?void 0:a.target)==null?void 0:k.value)??""))},onBlur:a=>{const i=a.target;y("roleId",i.value==="placeholder"?"":i.value)},options:[{value:"placeholder",text:l.selectRole,disabled:!0},...T.map(a=>({value:a.id,text:a.name}))]})}),s(g,{label:l.firstName,required:!0,className:"acm-structure-panel__field",error:p.firstName&&m.firstName?m.firstName:void 0,children:s(A,{name:"first_name",type:"text",value:d.firstName,onBlur:a=>{const i=a.target;y("firstName",i.value)},variant:"primary",size:"medium"})}),s(g,{label:l.lastName,required:!0,className:"acm-structure-panel__field",error:p.lastName&&m.lastName?m.lastName:void 0,children:s(A,{name:"last_name",type:"text",value:d.lastName,onBlur:a=>{const i=a.target;y("lastName",i.value)},variant:"primary",size:"medium"})}),s(g,{label:l.email,required:!0,className:"acm-structure-panel__field",error:p.email&&m.email?m.email:void 0,children:s(A,{name:"email",type:"email",value:d.email,onBlur:a=>{const i=a.target;y("email",i.value)},placeholder:"jdoe@example.com",variant:"primary",size:"medium"})}),s(g,{label:l.workPhoneNumber,className:"acm-structure-panel__field",error:p.telephone&&m.telephone?m.telephone:void 0,children:s(A,{name:"telephone",type:"text",value:d.telephone||"",onBlur:a=>{const i=a.target;y("telephone",i.value)},variant:"primary",size:"medium"})}),s(g,{label:l.status,className:"acm-structure-panel__field",disabled:S||!r,children:s(P,{name:"status",value:d.status,onChange:a=>{var i;return R("status",String(((i=a==null?void 0:a.target)==null?void 0:i.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:l.active},{value:"INACTIVE",text:l.inactive}]})})]})]}),x||w?null:L("div",{className:"acm-structure-modal__actions",children:[s($,{type:"button",variant:"primary",disabled:N||!r,onClick:async()=>{if(!N){V(!0);try{await j()}finally{V(!1)}}},children:l.save}),s($,{type:"button",variant:"secondary",disabled:N,onClick:v,children:l.cancel})]})]})});export{ye as C};
//# sourceMappingURL=CompanyUserForm.js.map
