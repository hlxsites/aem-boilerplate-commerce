/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as k,jsx as t,Fragment as me}from"@dropins/tools/preact-jsx-runtime.js";import{useState as L,useEffect as $,useRef as se,useCallback as O}from"@dropins/tools/preact-hooks.js";import{Slot as be,classes as Se}from"@dropins/tools/lib.js";import{Card as ie,InLineAlert as le,ProgressSpinner as ue,Field as pe,Input as ye,Button as _,Modal as Ce,IllustratedMessage as ve,Icon as Me,Header as Te}from"@dropins/tools/components.js";import{f as fe}from"../chunks/fetchUserPermissions.js";import{b as ge}from"../chunks/company-permissions.js";import{useText as G}from"@dropins/tools/i18n.js";import{u as Ie}from"../chunks/useCompanyContextListener.js";import{a as Ee,i as we}from"../chunks/isCompanyUser.js";import*as he from"@dropins/tools/preact-compat.js";import{memo as Le}from"@dropins/tools/preact-compat.js";import{T as Ne}from"../chunks/Tree.js";import{C as xe}from"../chunks/CompanyUserForm.js";import{events as re}from"@dropins/tools/event-bus.js";import{p as oe,E as ce}from"../chunks/acdl.js";import{g as Ue,c as Ze,u as Ae,a as De,b as _e,d as ke}from"../chunks/updateCompanyTeam.js";import{d as Pe}from"../chunks/updateCompanyUser.js";import{u as Ve}from"../chunks/useInLineAlert.js";import{C as He,a as Fe}from"../chunks/CompanyLoaders.js";import"../chunks/fetch-error.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/useCompanyRoles.js";import"../chunks/isCompanyRoleNameAvailable.js";const Re=u=>he.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...u},he.createElement("path",{d:"M12.002 21L11.8275 21.4686C11.981 21.5257 12.1528 21.5041 12.2873 21.4106C12.4218 21.3172 12.502 21.1638 12.502 21H12.002ZM3.89502 17.9823H3.39502C3.39502 18.1912 3.52485 18.378 3.72059 18.4509L3.89502 17.9823ZM3.89502 8.06421L4.07193 7.59655C3.91831 7.53844 3.74595 7.55948 3.61082 7.65284C3.47568 7.74619 3.39502 7.89997 3.39502 8.06421H3.89502ZM12.0007 21H11.5007C11.5007 21.1638 11.5809 21.3172 11.7154 21.4106C11.8499 21.5041 12.0216 21.5257 12.1751 21.4686L12.0007 21ZM20.1076 17.9823L20.282 18.4509C20.4778 18.378 20.6076 18.1912 20.6076 17.9823H20.1076ZM20.1076 8.06421H20.6076C20.6076 7.89997 20.527 7.74619 20.3918 7.65284C20.2567 7.55948 20.0843 7.53844 19.9307 7.59655L20.1076 8.06421ZM12.0007 11.1311L11.8238 10.6634C11.6293 10.737 11.5007 10.9232 11.5007 11.1311H12.0007ZM20.2858 8.53191C20.5441 8.43421 20.6743 8.14562 20.5766 7.88734C20.4789 7.62906 20.1903 7.49889 19.932 7.5966L20.2858 8.53191ZM12.002 4.94826L12.1775 4.48008C12.0605 4.43623 11.9314 4.43775 11.8154 4.48436L12.002 4.94826ZM5.87955 6.87106C5.62334 6.97407 5.49915 7.26528 5.60217 7.52149C5.70518 7.77769 5.99639 7.90188 6.2526 7.79887L5.87955 6.87106ZM18.1932 7.80315C18.4518 7.90008 18.74 7.76904 18.8369 7.51047C18.9338 7.2519 18.8028 6.96371 18.5442 6.86678L18.1932 7.80315ZM12 4.94827L11.5879 5.23148C11.6812 5.36719 11.8353 5.44827 12 5.44827C12.1647 5.44827 12.3188 5.36719 12.4121 5.23148L12 4.94827ZM14.0263 2L14.2028 1.53218C13.9875 1.45097 13.7446 1.52717 13.6143 1.71679L14.0263 2ZM21.8421 4.94827L22.2673 5.2113C22.3459 5.08422 22.3636 4.92863 22.3154 4.78717C22.2673 4.64571 22.1584 4.53319 22.0186 4.48045L21.8421 4.94827ZM9.97368 2L10.3857 1.71679C10.2554 1.52717 10.0125 1.45097 9.79721 1.53218L9.97368 2ZM2.15789 4.94827L1.98142 4.48045C1.84161 4.53319 1.73271 4.64571 1.68456 4.78717C1.63641 4.92863 1.65406 5.08422 1.73267 5.2113L2.15789 4.94827ZM12 11.1256L11.6702 11.5014C11.8589 11.667 12.1411 11.667 12.3298 11.5014L12 11.1256ZM15.0395 8.45812L14.8732 7.98659C14.8131 8.00779 14.7576 8.04028 14.7097 8.08232L15.0395 8.45812ZM23 5.65024L23.3288 6.0269C23.5095 5.86916 23.5527 5.60532 23.4318 5.39817C23.3109 5.19102 23.0599 5.09893 22.8337 5.17871L23 5.65024ZM8.96053 8.45812L9.29034 8.08232C9.24244 8.04028 9.18695 8.00779 9.12685 7.98659L8.96053 8.45812ZM1 5.65024L1.16632 5.17871C0.940115 5.09893 0.689119 5.19102 0.568192 5.39817C0.447264 5.60532 0.49048 5.86916 0.671176 6.0269L1 5.65024ZM12.1764 20.5314L4.06945 17.5137L3.72059 18.4509L11.8275 21.4686L12.1764 20.5314ZM4.39502 17.9823V8.06421H3.39502V17.9823H4.39502ZM3.71811 8.53187L11.8251 11.5987L12.1789 10.6634L4.07193 7.59655L3.71811 8.53187ZM11.502 11.1311V21H12.502V11.1311H11.502ZM12.1751 21.4686L20.282 18.4509L19.9332 17.5137L11.8262 20.5314L12.1751 21.4686ZM20.6076 17.9823V8.06421H19.6076V17.9823H20.6076ZM19.9307 7.59655L11.8238 10.6634L12.1776 11.5987L20.2845 8.53187L19.9307 7.59655ZM11.5007 11.1311V21H12.5007V11.1311H11.5007ZM19.932 7.5966L11.8251 10.6634L12.1789 11.5987L20.2858 8.53191L19.932 7.5966ZM11.8154 4.48436L5.87955 6.87106L6.2526 7.79887L12.1885 5.41217L11.8154 4.48436ZM11.8265 5.41645L18.1932 7.80315L18.5442 6.86678L12.1775 4.48008L11.8265 5.41645ZM11.502 4.94826V11.1311H12.502V4.94826H11.502ZM12.4121 5.23148L14.4384 2.28321L13.6143 1.71679L11.5879 4.66507L12.4121 5.23148ZM13.8498 2.46782L21.6656 5.4161L22.0186 4.48045L14.2028 1.53218L13.8498 2.46782ZM21.4169 4.68525L20.5485 6.08919L21.3989 6.61524L22.2673 5.2113L21.4169 4.68525ZM12.4121 4.66507L10.3857 1.71679L9.56162 2.28321L11.5879 5.23148L12.4121 4.66507ZM9.79721 1.53218L1.98142 4.48045L2.33437 5.4161L10.1502 2.46782L9.79721 1.53218ZM1.73267 5.2113L2.60109 6.61524L3.45154 6.08919L2.58312 4.68525L1.73267 5.2113ZM12.3298 11.5014L15.3693 8.83392L14.7097 8.08232L11.6702 10.7498L12.3298 11.5014ZM15.2058 8.92965L23.1663 6.12177L22.8337 5.17871L14.8732 7.98659L15.2058 8.92965ZM22.6712 5.27358L19.7764 7.80067L20.4341 8.554L23.3288 6.0269L22.6712 5.27358ZM12.3298 10.7498L9.29034 8.08232L8.63072 8.83392L11.6702 11.5014L12.3298 10.7498ZM9.12685 7.98659L1.16632 5.17871L0.83368 6.12177L8.79421 8.92965L9.12685 7.98659ZM0.671176 6.0269L3.56591 8.554L4.22356 7.80067L1.32882 5.27358L0.671176 6.0269Z",fill:"currentColor"})),ae={name:40,description:1e3};function Be(u){const{mode:I,entityId:p,parentStructureId:d,onSaved:e,onError:b,onSuccess:c}=u,r=G({teamTitleRequired:"Company.CompanyStructure.shared.validation.teamTitleRequired",teamNameMaxLength:"Company.CompanyStructure.shared.validation.teamNameMaxLength",teamDescriptionMaxLength:"Company.CompanyStructure.shared.validation.teamDescriptionMaxLength",createTeamError:"Company.CompanyStructure.messages.createTeamError",saveTeamError:"Company.CompanyStructure.messages.saveTeamError",createTeamSuccess:"Company.CompanyStructure.messages.createTeamSuccess",updateTeamSuccess:"Company.CompanyStructure.messages.updateTeamSuccess"}),[m,o]=L({id:"",name:"",description:""}),[y,C]=L({}),[g,D]=L({}),[M,w]=L(!1),[V,P]=L(null);$(()=>{I!=="edit"||!p||(w(!0),Ue(p).then(f=>{f&&o({id:f.id,name:f.name||"",description:f.description||""})}).finally(()=>w(!1)))},[I,p]);const H=(f,S)=>f==="name"?S.trim()?S.length>ae.name?r.teamNameMaxLength:null:r.teamTitleRequired:f==="description"&&S&&S.length>ae.description?r.teamDescriptionMaxLength:null,x=(f,S)=>{o(U=>({...U,[f]:S})),V&&P(null)};return{values:m,errors:y,touched:g,loading:M,setValue:x,onBlur:(f,S)=>{S!==void 0&&x(f,S),D(Z=>({...Z,[f]:!0}));const U=S!==void 0?S:m[f]||"",T=H(f,U);C(T?Z=>({...Z,[f]:T}):Z=>{const E={...Z};return delete E[f],E})},submit:async()=>{const f=H("name",m.name),S=H("description",m.description||""),U={},T={name:!0,description:!0};if(f&&(U.name=f),S&&(U.description=S),D(T),Object.keys(U).length>0){C(U);return}const Z=m.name;try{if(I==="add"){const E=await Ze({name:m.name,description:m.description||null,targetId:d??null});if(!E){const Y=r.createTeamError;b?b(Y):P(Y);return}e({label:Z,structureId:E.structureId,entityId:E.id,type:"team",description:m.description||void 0}),c&&c(r.createTeamSuccess)}else p&&(await Ae({id:p,name:m.name,description:m.description||null}),e({label:Z,entityId:p,type:"team",description:m.description||void 0}),c&&c(r.updateTeamSuccess))}catch(E){const Y=E instanceof Error?E.message:r.saveTeamError;b?b(Y):P(Y)}},generalError:V}}const Oe=Le(({mode:u,entityId:I,parentStructureId:p,permissions:d,onSaved:e,onCancel:b,onError:c,onSuccess:r})=>{const m=(d==null?void 0:d.canEditUsers)??!1,{values:o,errors:y,touched:C,loading:g,onBlur:D,submit:M,generalError:w}=Be({mode:u,entityId:I,parentStructureId:p,onSaved:e,onError:c?x=>{c(x),b()}:void 0,onSuccess:r}),[V,P]=L(!1),H=G({addTeam:"Company.CompanyStructure.shared.titles.addTeam",editTeam:"Company.CompanyStructure.shared.titles.editTeam",teamTitle:"Company.CompanyStructure.shared.fields.teamTitle",description:"Company.CompanyStructure.shared.fields.description"});return k("div",{children:[t("h3",{className:"acm-structure-panel__title",children:u==="add"?H.addTeam:H.editTeam}),k(ie,{variant:"secondary",className:`company-team-form__card ${V?"is-working":""}`,children:[!c&&w?t(le,{className:"company-team-form__notification",type:"error",variant:"secondary",heading:w}):null,V?t("div",{className:"company-team-form__overlay","aria-live":"polite",children:t(ue,{size:"small"})}):null,g?t(He,{}):k("div",{className:"company-team-form__content",children:[t(pe,{label:H.teamTitle,required:!0,className:"acm-structure-panel__field",error:C.name&&y.name?y.name:void 0,children:t(ye,{name:"team_title",type:"text",value:o.name,onBlur:x=>{const z=x.target;D("name",z.value)},variant:"primary",size:"medium",disabled:!m,maxLength:ae.name})}),t(pe,{label:H.description,className:"acm-structure-panel__field",error:C.description&&y.description?y.description:void 0,children:t(ye,{name:"team_description",type:"textarea",value:o.description||"",onBlur:x=>{const z=x.target;D("description",z.value)},variant:"primary",size:"medium",disabled:!m,maxLength:ae.description})})]})]}),g?null:k("div",{className:"acm-structure-modal__actions",children:[t(_,{type:"button",variant:"primary",onClick:async()=>{if(!V){P(!0);try{await M()}finally{P(!1)}}},disabled:V||!m,children:"Save"}),t(_,{type:"button",variant:"secondary",disabled:V,onClick:b,children:"Cancel"})]})]})});function ze({handleSetInLineAlert:u,permissions:I}={permissions:null}){const p=(I==null?void 0:I.canViewUsers)??!1,d=G({loadError:"Company.CompanyStructure.messages.loadError",updateError:"Company.CompanyStructure.messages.updateError",failedToMoveItem:"Company.CompanyStructure.messages.failedToMoveItem",removeUserSuccess:"Company.CompanyStructure.messages.removeUserSuccess",deleteTeamSuccess:"Company.CompanyStructure.messages.deleteTeamSuccess",removeMultipleSuccess:"Company.CompanyStructure.messages.removeMultipleSuccess",moveUserSuccess:"Company.CompanyStructure.messages.moveUserSuccess",moveTeamSuccess:"Company.CompanyStructure.messages.moveTeamSuccess"}),{loadError:e,updateError:b}=d,[c,r]=L(null),[m,o]=L(!0),[y,C]=L(!1),[g,D]=L(!1),[M,w]=L(new Set),[V,P]=L(null),[H,x]=L(new Set),[z,X]=L({}),f=se(u),S=se(!1),U=se(!1);$(()=>{f.current=u},[u]);const T=O((a,l)=>{u&&(a==="success"?u({type:"success",text:l}):a==="error"?u({type:"error",text:l}):u(),C(!1))},[u]),Z=O(async()=>{if(S.current)return null;if(S.current=!0,!p)return o(!1),r(null),w(new Set),P(null),x(new Set),S.current=!1,null;o(!0);try{const l=await De();return r(l),w(new Set(l.map(A=>A.id))),o(!1),l}catch{return o(!1),f.current&&f.current({type:"error",text:e}),null}finally{S.current=!1}},[p,e]);$(()=>{p&&!U.current&&(U.current=!0,Z())},[p,Z]),$(()=>{const a=()=>{o(!0),w(new Set),P(null),x(new Set),Z()},l=re.on("companyContext/changed",a,{eager:!0});return()=>{l==null||l.off()}},[Z]);const E=O(async(a,l)=>{try{if(C(!0),!await _e({id:a,parentId:l}))return T("error",d.failedToMoveItem),!1;const v=new Map(c==null?void 0:c.map(i=>[i.id,i])).get(a),n=(v==null?void 0:v.type)==="team"?d.moveTeamSuccess:d.moveUserSuccess;return r(i=>i?i.map(h=>h.id===a?{...h,parentId:l}:h):null),w(i=>new Set([...i,l])),oe(ce.EDIT_COMPANY_STRUCTURE_EVENT,{action:"move",nodeId:a,newParentId:l}),re.emit("companyStructure/updated",{message:"Structure updated",action:"move",nodeId:a,newParentId:l,nodes:c||[]}),T("success",n),!0}catch(A){const F=A instanceof Error?A.message:b;return T("error",F),!1}finally{C(!1)}},[c,T,b,d.failedToMoveItem,d.moveUserSuccess,d.moveTeamSuccess]),Y=O(()=>{c&&w(new Set(c.map(a=>a.id)))},[c]),q=O(()=>{if(c){const a=c.filter(l=>l.parentId===null).map(l=>l.id);w(new Set(a))}},[c]),j=O(a=>{r(l=>{const A=l?[...l,{id:a.id,parentId:a.parentId,label:a.label,type:a.type,entityId:a.entityId,description:a.description}]:[{id:a.id,parentId:a.parentId,label:a.label,type:a.type,entityId:a.entityId,description:a.description}];return re.emit("companyStructure/updated",{message:"Structure updated",action:"add",nodeId:a.id,newParentId:a.parentId||void 0,nodes:A}),oe(ce.EDIT_COMPANY_STRUCTURE_EVENT,{action:"add",nodeId:a.id,newParentId:a.parentId||void 0,nodeType:a.type}),A}),a.parentId&&w(l=>new Set([...l,a.parentId]))},[]),Q=O((a,l,A)=>{l&&r(F=>F?F.map(v=>a.includes(v.id)?{...v,label:l,description:A}:v):null)},[]),W=O(async a=>{if(a.length)try{C(!0);const l=new Map((c||[]).map(v=>[v.id,v])),A=a.map(v=>l.get(v)).filter(Boolean);for(const v of a){const n=l.get(v);!n||!n.entityId||(n.type==="team"?await ke(n.entityId):await Pe({id:n.entityId}))}r(v=>{if(!v)return null;const n=new Set(a);return v.filter(i=>!n.has(i.id))}),P(null),x(new Set),oe(ce.EDIT_COMPANY_STRUCTURE_EVENT,{action:"remove",nodeIds:a}),re.emit("companyStructure/updated",{message:"Structure updated",action:"remove",nodeIds:a,nodes:c||[]});let F;if(a.length===1){const v=A[0];F=(v==null?void 0:v.type)==="team"?d.deleteTeamSuccess:d.removeUserSuccess}else F=d.removeMultipleSuccess.replace("{count}",a.length.toString());T("success",F)}catch(l){const A=l instanceof Error?l.message:b;T("error",A)}finally{C(!1)}},[c,T,b,d.removeUserSuccess,d.deleteTeamSuccess,d.removeMultipleSuccess]),ee=O(a=>{X(a)},[]),J=O(()=>{D(!0),T("success",""),X({})},[T]),te=O(a=>{a==null||a(),D(!1),X({})},[]);return{nodes:c,loading:m,submitLoading:y,showEditForm:g,inputChange:z,expanded:M,setExpanded:w,selected:V,setSelected:P,selectedMany:H,setSelectedMany:x,move:E,expandAll:Y,collapseAll:q,insertNode:j,renameNodes:Q,removeNodes:W,handleInputChange:ee,handleShowEditForm:J,handleHideEditForm:te,renderAlertMessage:T,working:y}}const Ye=Le(({permissions:u,slots:I})=>{var v;const p=(u==null?void 0:u.canEditUsers)??!1,d=(u==null?void 0:u.canViewUsers)??!1,e=G({expandAll:"Company.CompanyStructure.shared.buttons.expandAll",collapseAll:"Company.CompanyStructure.shared.buttons.collapseAll",addUser:"Company.CompanyStructure.shared.buttons.addUser",addTeam:"Company.CompanyStructure.shared.buttons.addTeam",editSelected:"Company.CompanyStructure.shared.buttons.editSelected",remove:"Company.CompanyStructure.shared.buttons.remove",ok:"Company.CompanyStructure.shared.buttons.ok",cancel:"Company.CompanyStructure.shared.buttons.cancel",close:"Company.CompanyStructure.shared.buttons.close",deleting:"Company.CompanyStructure.shared.buttons.deleting",removing:"Company.CompanyStructure.shared.buttons.removing",noStructureData:"Company.CompanyStructure.messages.noStructureData",processing:"Company.CompanyStructure.shared.messages.processing",cannotDeleteUser:"Company.CompanyStructure.messages.cannotDeleteUser",cannotDeleteTeam:"Company.CompanyStructure.messages.cannotDeleteTeam",removeUserConfirm:"Company.CompanyStructure.messages.removeUserConfirm",deleteTeamConfirm:"Company.CompanyStructure.messages.deleteTeamConfirm",removeItemsConfirm:"Company.CompanyStructure.messages.removeItemsConfirm",teamDescription:"Company.CompanyStructure.shared.messages.teamDescription",removeUserMessage:"Company.CompanyStructure.messages.removeUserMessage",cannotDeleteUserMessage:"Company.CompanyStructure.messages.cannotDeleteUserMessage",cannotDeleteTeamMessage:"Company.CompanyStructure.messages.cannotDeleteTeamMessage",removeItemsMessage:"Company.CompanyStructure.messages.removeItemsMessage",companyStructureActions:"Company.CompanyStructure.shared.ariaLabels.companyStructureActions",expandAllNodes:"Company.CompanyStructure.shared.ariaLabels.expandAllNodes",collapseAllNodes:"Company.CompanyStructure.shared.ariaLabels.collapseAllNodes",addUserAria:"Company.CompanyStructure.shared.ariaLabels.addUser",addTeamAria:"Company.CompanyStructure.shared.ariaLabels.addTeam",editSelectedAria:"Company.CompanyStructure.shared.ariaLabels.editSelected",removeSelectedAria:"Company.CompanyStructure.shared.ariaLabels.removeSelected",showDescription:"Company.CompanyStructure.shared.ariaLabels.showDescription",delete:"Company.CompanyStructure.shared.options.delete",expand:"Company.CompanyStructure.shared.options.expand",collapse:"Company.CompanyStructure.shared.options.collapse",deleteTeamMessage:"Company.CompanyStructure.messages.deleteTeamMessage"}),{inLineAlertProps:b,handleSetInLineAlert:c}=Ve(),{nodes:r,loading:m,submitLoading:o,expanded:y,setExpanded:C,selected:g,setSelected:D,selectedMany:M,setSelectedMany:w,move:V,expandAll:P,collapseAll:H,insertNode:x,renameNodes:z,removeNodes:X}=ze({handleSetInLineAlert:c,permissions:u}),[f,S]=L(null),[U,T]=L("add"),[Z,E]=L(!1),[Y,q]=L([]),[j,Q]=L({title:"",body:"",confirmLabel:e.remove,blocked:!1}),[W,ee]=L(null),J=()=>S(null),te=((v=r==null?void 0:r.find(n=>n.parentId===null))==null?void 0:v.id)??null,a=(r||[]).map(n=>({id:n.id,parentId:n.parentId,label:n.label})),l=(n,i)=>{let h=n;const s=new Map(a.map(R=>[R.id,R])),N=new Set;for(;h&&!N.has(h);){N.add(h);const R=s.get(h);if(!R)break;if(R.parentId===i)return!0;h=R.parentId??null}return!1},A=(r||[]).map(n=>({id:n.id,parentId:n.parentId,label:n.label,type:n.type,description:n.description,entityId:n.entityId})),F=k(me,{children:[(()=>{const n=M!=null&&M.size?Array.from(M):g?[g]:[],i=p&&n.length===1,h=p&&n.length>=1;return t(ie,{variant:"secondary",className:"acm-structure-toolbar-card acm-structure-toolbar-card--spaced",children:k("div",{className:"acm-structure-toolbar",role:"toolbar","aria-label":e.companyStructureActions,children:[t(_,{type:"button",variant:"secondary",onClick:P,"aria-label":e.expandAllNodes,disabled:!d,"aria-disabled":!d,children:e.expandAll}),t(_,{type:"button",variant:"secondary",onClick:H,"aria-label":e.collapseAllNodes,disabled:!d,"aria-disabled":!d,children:e.collapseAll}),t(_,{type:"button",variant:"primary",onClick:()=>{T("add"),S("user")},"aria-label":e.addUserAria,disabled:!p,"aria-disabled":!p,children:e.addUser}),t(_,{type:"button",variant:"primary",onClick:()=>{T("add"),S("team")},"aria-label":e.addTeamAria,disabled:!p,"aria-disabled":!p,children:e.addTeam}),t(_,{type:"button",variant:"primary",disabled:!i,"aria-disabled":!i,"aria-label":e.editSelectedAria,onClick:()=>{if(!i)return;const s=n,N=r==null?void 0:r.find(R=>R.id===s[0]);(N==null?void 0:N.type)==="user"?(T("edit"),S("user")):(T("edit"),S("team"))},children:e.editSelected}),t(_,{type:"button",variant:"secondary",disabled:!h||o,"aria-disabled":!h||o,"aria-label":e.removeSelectedAria,onClick:()=>{if(!h||o)return;const s=n;if(s.length===1){const N=r==null?void 0:r.find(K=>K.id===s[0]);if(!N)return;(r==null?void 0:r.some(K=>K.parentId===N.id))?(Q({title:N.type==="user"?e.cannotDeleteUser:e.cannotDeleteTeam,body:N.type==="user"?e.cannotDeleteUserMessage:e.cannotDeleteTeamMessage,confirmLabel:void 0,blocked:!0}),q([]),E(!0)):(Q({title:N.type==="user"?e.removeUserConfirm:e.deleteTeamConfirm,body:N.type==="user"?e.removeUserMessage:e.deleteTeamMessage,confirmLabel:N.type==="user"?e.remove:e.delete,blocked:!1}),q(s),E(!0))}else Q({title:e.removeItemsConfirm.replace("{count}",s.length.toString()),body:e.removeItemsMessage,confirmLabel:e.remove,blocked:!1}),q(s),E(!0)},children:e.remove})]})})})(),f?k("div",{className:"acm-structure-panel",children:[o?k("div",{className:"acm-structure-working","aria-live":"polite",children:[t(ue,{size:"small"})," ",e.processing]}):null,f==="user"?(()=>{const n=M!=null&&M.size?Array.from(M):g?[g]:[],i=n.length?r==null?void 0:r.find(s=>s.id===n[0]):void 0,h=(i==null?void 0:i.id)??te;return t(xe,{mode:U,entityId:i==null?void 0:i.entityId,parentStructureId:h,permissions:u,onSaved:s=>{U==="add"?s.structureId&&(x({id:s.structureId,parentId:h,label:s.label,type:s.type,entityId:s.entityId}),s.structureId&&(D(s.structureId),w(new Set([s.structureId])))):n.length&&z(n,s.label),J()},onCancel:J,onError:s=>{c({text:s,type:"error"})},onSuccess:s=>{c({text:s,type:"success"})}})})():null,f==="team"?(()=>{const n=M!=null&&M.size?Array.from(M):g?[g]:[],i=n.length?r==null?void 0:r.find(s=>s.id===n[0]):void 0,h=(i==null?void 0:i.id)??te;return t(Oe,{mode:U,entityId:i==null?void 0:i.entityId,parentStructureId:h,permissions:u,onSaved:s=>{U==="add"?s.structureId&&(x({id:s.structureId,parentId:h,label:s.label,type:s.type,entityId:s.entityId,description:s.description}),s.structureId&&(D(s.structureId),w(new Set([s.structureId])))):n.length&&z(n,s.label,s.description),J()},onCancel:J,onError:s=>{c({text:s,type:"error"})},onSuccess:s=>{c({text:s,type:"success"})}})})():null]}):null,k(ie,{variant:"secondary",className:`acm-structure-tree-card ${o?"is-working":""}`,children:[b&&b.text?t(le,{className:"acm-structure-panel__notification",type:b.type||"success",variant:"secondary",heading:b.text}):null,!m&&!o&&r&&r.length===0?t(le,{className:"acm-structure-panel__notification",type:"warning",variant:"secondary",heading:e.noStructureData}):null,!m&&o?t("div",{className:"acm-structure-tree-overlay","aria-live":"polite",children:t(ue,{size:"medium"})}):null,m?t("div",{className:"acm-structure-tree-content",children:t(Fe,{rows:8})}):t("div",{className:"acm-structure-tree-content",children:t(Ne,{rootId:null,items:a,expandedIds:y,selectedId:g,selectedIds:M,onExpandedChange:C,onSelectedChange:D,onSelectedIdsChange:w,renderExpander:({expanded:n,toggle:i})=>t("button",{type:"button",className:`acm-structure-expander acm-structure-expander-button ${n?"is-open":""}`,"aria-label":n?e.collapse:e.expand,onClick:h=>{h.stopPropagation(),i()},children:n?"âˆ’":"+"}),renderNode:({item:n,hasChildren:i,select:h,expander:s,checkbox:N,icon:R})=>{var K;return k("div",{className:"acm-structure-row",onClick:h,children:[i?s?t("span",{onClick:B=>B.stopPropagation(),children:s()}):t("span",{className:"acm-structure-expander acm-structure-expander--placeholder"}):t("span",{className:"acm-structure-expander acm-structure-expander--placeholder"}),t("span",{className:"acm-structure-handle","aria-hidden":!0}),R?t("span",{onClick:B=>B.stopPropagation(),children:R()}):t("span",{className:`acm-structure-icon ${((K=r==null?void 0:r.find(B=>B.id===n.id))==null?void 0:K.type)==="team"?"is-team":"is-user"}`,"aria-hidden":!0}),N?t("span",{onClick:B=>B.stopPropagation(),children:N()}):null,t("span",{className:"acm-structure-label",children:n.label}),(()=>{const B=r==null?void 0:r.find(ne=>ne.id===n.id),de=(B==null?void 0:B.type)==="team"&&B.description||"";return de?t(_,{type:"button",variant:"secondary",onClick:ne=>{ne.stopPropagation(),ee({id:n.id,text:de})},"aria-label":e.showDescription,className:"acm-structure-description-button",children:"?"}):null})()]})},draggable:()=>!o&&p,canDrop:(n,i)=>{if(!p||n===i)return!1;const h=r==null?void 0:r.find(s=>s.id===n);return h&&h.parentId===i?!1:!l(i,n)},onMove:async({id:n,newParentId:i})=>{p&&await V(n,i)}})})]}),Z?t(Ce,{open:Z,onClose:()=>{o||(E(!1),q([]))},children:k("div",{className:"acm-structure-modal-content",children:[t("h3",{className:"acm-structure-modal-title",children:j.title}),t("div",{children:j.body}),t("div",{className:"acm-structure-modal-actions",children:j.blocked?t(_,{type:"button",variant:"secondary",disabled:o,onClick:()=>{o||(E(!1),q([]))},children:e.ok}):k(me,{children:[t(_,{type:"button",variant:"secondary",disabled:o,onClick:()=>{o||(E(!1),q([]))},children:e.cancel}),t(_,{type:"button",variant:"primary",disabled:o,onClick:async()=>{await X(Y),E(!1),q([])},children:o?j.confirmLabel===e.delete?e.deleting:e.removing:j.confirmLabel||e.remove})]})})]})}):null,W?t(Ce,{open:!!W,onClose:()=>ee(null),children:k("div",{className:"acm-structure-modal-content",children:[t("h3",{className:"acm-structure-modal-title",children:e.teamDescription}),t("div",{children:W.text}),t("div",{className:"acm-structure-modal-actions",children:t(_,{type:"button",variant:"secondary",onClick:()=>ee(null),children:e.close})})]})}):null]});return I!=null&&I.StructureData?t(be,{name:"StructureData",slot:I.StructureData,context:{structureData:A,Default:F}}):F}),qe=()=>{const u=G({fetchPermissionsError:"Company.CompanyStructure.messages.fetchPermissionsError"}),[I,p]=L(null),[d,e]=L(!0),[b,c]=L(null),r=O(async()=>{var m,o;try{e(!0),c(null);const{roleResponse:y}=await fe(),C=(o=(m=y==null?void 0:y.data)==null?void 0:m.customer)==null?void 0:o.role,g=ge(C);p(g)}catch(y){c(y instanceof Error?y:new Error(u.fetchPermissionsError))}finally{e(!1)}},[u.fetchPermissionsError]);return $(()=>{let m=!0;return(async()=>{var y,C;try{e(!0),c(null);const{roleResponse:g}=await fe();if(!m)return;const D=(C=(y=g==null?void 0:g.data)==null?void 0:y.customer)==null?void 0:C.role,M=ge(D);p(M)}catch(g){if(!m)return;c(g instanceof Error?g:new Error(u.fetchPermissionsError))}finally{m&&e(!1)}})(),()=>{m=!1}},[]),{permissions:I,loading:d,error:b,refreshPermissions:r}},$e="/customer/company/create",je=({className:u,children:I,createCompanyAccountUrl:p=$e,...d})=>{const e=G({individualUserMessage:"Company.CustomerCompanyInfo.individualUserMessage",createAccountCta:"Company.CustomerCompanyInfo.createAccountCta"});return t(ve,{className:Se(["company-management-company-structure-empty",u]),icon:t(Me,{source:Re}),heading:e.individualUserMessage||"You don't have a company account yet.",action:t(_,{as:"a",href:p,variant:"primary","data-testid":"company-structure-create-company-button",children:e.createAccountCta||"Create a Company Account"}),variant:"secondary","data-testid":"company-structure-empty",...d})},gt=({className:u,withHeader:I=!1,slots:p,isAuthenticated:d=!1,onRedirectLogin:e,onRedirectAccount:b})=>{const c=G({containerTitle:"Company.CompanyStructure.containerTitle",noAccessTitle:"Company.CompanyStructure.noAccess.title",noAccessMessage:"Company.CompanyStructure.noAccess.message"}),{permissions:r,refreshPermissions:m}=qe(),[o,y]=L("loading");return Ie(m),$(()=>{let C=!0;return(async()=>{try{if(!d){C&&y("redirect-login");return}if(!await Ee()){C&&(console.log("Company registration disabled - redirecting to account dashboard"),y("redirect-account"));return}await we()?C&&y("show-structure"):C&&y("show-empty")}catch(g){console.error("Error in CompanyStructure - redirecting to login page:",g),C&&y("redirect-login")}})(),()=>{C=!1}},[d]),$(()=>{o==="show-structure"&&r&&((r.canViewUsers??!1)||y("no-access"))},[o,r]),$(()=>{o==="redirect-login"&&e&&e(),o==="redirect-account"&&b&&b()},[o,e,b]),o==="loading"||o==="redirect-login"||o==="redirect-account"?null:o==="show-empty"?t(je,{className:u}):o==="no-access"?t(ve,{className:u,heading:c.noAccessTitle||"Access Restricted",message:t("p",{children:c.noAccessMessage||"You don't have permission to view the company structure. Please contact your company administrator."})}):o==="show-structure"?k("div",{className:Se(["account-company-structure",u]),children:[I?t(Te,{title:c.containerTitle,divider:!1,className:"company-structure__title"}):null,t(Ye,{slots:p,permissions:r})]}):null};export{gt as CompanyStructure,gt as default};
//# sourceMappingURL=CompanyStructure.js.map
