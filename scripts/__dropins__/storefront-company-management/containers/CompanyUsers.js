/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as a,jsxs as P}from"@dropins/tools/preact-jsx-runtime.js";import{useState as h,useRef as F,useMemo as z,useCallback as u,useEffect as D}from"@dropins/tools/preact-hooks.js";import{Button as x,InLineAlert as q,Picker as K,Modal as R}from"@dropins/tools/components.js";import{u as Z,T as H}from"../chunks/useUserPermissions.js";import{C as $}from"../chunks/CompanyUserForm.js";import{classes as J}from"@dropins/tools/lib.js";import"@dropins/tools/event-bus.js";import{u as Q}from"../chunks/useInLineAlert.js";import{g as W,u as X}from"../chunks/updateCompanyUserStatus.js";import{useText as j}from"@dropins/tools/i18n.js";import{d as Y}from"../chunks/updateCompanyUser.js";import{a as ee}from"../chunks/CompanyLoaders.js";import{f as ae}from"../chunks/fetchUserPermissions.js";import{u as te}from"../chunks/useCompanyContextListener2.js";import"@dropins/tools/preact.js";import"../chunks/company-permissions.js";import"@dropins/tools/preact-compat.js";import"../chunks/useCompanyRoles.js";import"../chunks/useCompanyContextListener.js";import"../chunks/isCompanyRoleNameAvailable.js";import"../chunks/fetch-error.js";import"@dropins/tools/fetch-graphql.js";const ne=t=>{try{return atob(t)}catch{return t}},se=t=>!t||typeof t!="string"?t:ne(t),re=(t,i)=>!t||typeof t!="string"?"":t==="ACTIVE"&&i.statusActive?i.statusActive:t==="INACTIVE"&&i.statusInactive?i.statusInactive:t.charAt(0).toUpperCase()+t.slice(1).toLowerCase(),oe=(t,i)=>{const l=(t==null?void 0:t.trim())||"",r=(i==null?void 0:i.trim())||"";return`${l} ${r}`.trim()},ie=({filterType:t,onFilterChange:i,translations:l})=>{const r=[{type:"all",label:l.showAllUsers,ariaLabel:l.showAllUsers},{type:"active",label:l.showActiveUsers,ariaLabel:l.showActiveUsers},{type:"inactive",label:l.showInactiveUsers,ariaLabel:l.showInactiveUsers}];return a("div",{className:"filterButtons",role:"group","aria-label":l.ariaFilterOptions,children:r.filter(m=>m.type!==t).map(m=>a(x,{variant:"tertiary",onClick:()=>i(m.type),"aria-label":m.ariaLabel,children:m.label},m.type))})},le=20,O=1,ce=({translations:t})=>{const[i,l]=h([]),[r,m]=h(!1),[e,p]=h(O),[g,v]=h(le),[M,A]=h("all"),[S,d]=h(0),[w,U]=h(1),[k,_]=h(""),[n,B]=h(null),b=F(t);b.current=t;const L=z(()=>{switch(M){case"active":return{status:"ACTIVE"};case"inactive":return{status:"INACTIVE"};default:return}},[M]),T=u(async()=>{m(!0);try{const c=await W({pageSize:g,currentPage:e,filter:L});l(c.users),d(c.totalCount||c.users.length),U(c.pageInfo.totalPages),_(b.current.ariaDataLoaded.replace("{count}",c.users.length.toString()))}catch{l([]),d(0),U(1),_(b.current.ariaDataError)}finally{m(!1)}},[g,e,L]),y=u(async()=>{try{const{allowedIds:c}=await ae();B(c)}catch{B(new Set)}},[]);D(()=>{T()},[T]),D(()=>{y()},[y]);const f=u(c=>{A(c),p(O)},[]),s=u(c=>{let E;if(typeof c=="string")E=c;else if("target"in c&&c.target&&"value"in c.target)E=c.target.value;else return;const G=parseInt(E,10);isNaN(G)||(v(G),p(O))},[]),C=u(()=>{e>1&&p(e-1)},[e]),I=u(()=>{e<w&&p(e+1)},[e,w]),N=(n==null?void 0:n.has("Magento_Company::users_edit"))||!1,o=u(async()=>{await y(),await T()},[y,T]);return{users:i,userPermissions:n,currentPage:e,pageSize:g,totalItems:S,totalPages:w,filterType:M,filter:L,loading:r,announcement:k,canEditUsers:N,handleFilterChange:f,handlePageSizeChange:s,handlePreviousPage:C,handleNextPage:I,refreshUsers:o}},V=t=>{const[i,l]=h(!1),[r,m]=h(null),e=u(g=>{g&&m(g),l(!0)},[]),p=u(()=>{l(!1),m(null),t==null||t()},[t]);return{isOpen:i,selectedId:r,open:e,close:p}},me=({className:t,userId:i,userStatus:l,onClose:r,isOpen:m=!1,...e})=>{const[p,g]=h(!1),[v,M]=h(!1),{inLineAlertProps:A,showError:S,clearAlert:d}=Q(),w=F(null),U=F(null),k=`modal-title-${i}`,_=`modal-desc-${i}`,n=j({title:"Company.CompanyUsers.managementModal.title",setActiveText:"Company.CompanyUsers.managementModal.setActiveText",setInactiveText:"Company.CompanyUsers.managementModal.setInactiveText",deleteText:"Company.CompanyUsers.managementModal.deleteText",setActiveButton:"Company.CompanyUsers.managementModal.setActiveButton",setInactiveButton:"Company.CompanyUsers.managementModal.setInactiveButton",settingActiveButton:"Company.CompanyUsers.managementModal.settingActiveButton",settingInactiveButton:"Company.CompanyUsers.managementModal.settingInactiveButton",deleteButton:"Company.CompanyUsers.managementModal.deleteButton",deletingButton:"Company.CompanyUsers.managementModal.deletingButton",cancelButton:"Company.CompanyUsers.managementModal.cancelButton",setActiveErrorGeneric:"Company.CompanyUsers.managementModal.setActiveErrorGeneric",setActiveErrorSpecific:"Company.CompanyUsers.managementModal.setActiveErrorSpecific",setInactiveErrorGeneric:"Company.CompanyUsers.managementModal.setInactiveErrorGeneric",setInactiveErrorSpecific:"Company.CompanyUsers.managementModal.setInactiveErrorSpecific",deleteErrorGeneric:"Company.CompanyUsers.managementModal.deleteErrorGeneric",deleteErrorSpecific:"Company.CompanyUsers.managementModal.deleteErrorSpecific",ariaCloseModal:"Company.CompanyUsers.managementModal.ariaLabels.closeModal",ariaModalDescription:"Company.CompanyUsers.managementModal.ariaLabels.modalDescription"}),B=u(async()=>{if(v)return;const s=l==="ACTIVE"?"INACTIVE":"ACTIVE",C=s==="ACTIVE";M(!0),d();try{(await X({id:i,status:s})).success?r():S(C?n.setActiveErrorSpecific:n.setInactiveErrorSpecific)}catch(I){const N=I instanceof Error?I.message:C?n.setActiveErrorGeneric:n.setInactiveErrorGeneric;S(N)}finally{M(!1)}},[i,l,r,v,d,S,n.setActiveErrorSpecific,n.setInactiveErrorSpecific,n.setActiveErrorGeneric,n.setInactiveErrorGeneric]),b=u(async()=>{if(!p){g(!0),d();try{(await Y({id:i})).success?r():S(n.deleteErrorSpecific)}catch(s){const C=s instanceof Error?s.message:n.deleteErrorGeneric;S(C)}finally{g(!1)}}},[i,r,p,d,S,n.deleteErrorSpecific,n.deleteErrorGeneric]),L=u(()=>{d(),r()},[r,d]),T=u(s=>{if(s.key==="Escape"&&(d(),r()),s.key==="Tab"){const C=w.current;if(!C)return;const I=C.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),N=I[0],o=I[I.length-1];s.shiftKey?document.activeElement===N&&(o.focus(),s.preventDefault()):document.activeElement===o&&(N.focus(),s.preventDefault())}},[r,d]),y=u(s=>{s.target===s.currentTarget&&(d(),r())},[r,d]),f=u(()=>{d(),r()},[r,d]);return D(()=>{if(m)return U.current=document.activeElement,document.addEventListener("keydown",T),setTimeout(()=>{const s=w.current;if(s){const C=s.querySelector("button");C?C.focus():s.focus()}},100),()=>{document.removeEventListener("keydown",T)};U.current&&U.current.focus()},[m,T]),m?a("div",{className:J(["company-management-company-users-management-modal-overlay",t]),onClick:y,...e,children:P("div",{ref:w,className:"company-management-company-users-management-modal",role:"dialog","aria-modal":"true","aria-labelledby":k,"aria-describedby":_,tabIndex:-1,children:[P("div",{className:"company-management-company-users-management-modal__header",children:[a("h2",{id:k,className:"company-management-company-users-management-modal__title",children:n.title}),a("button",{className:"company-management-company-users-management-modal__close",onClick:f,"aria-label":n.ariaCloseModal,children:"Ã—"})]}),P("div",{id:_,className:"company-management-company-users-management-modal__content",children:[a("p",{className:"company-management-company-users-management-modal__text",children:l==="ACTIVE"?n.setInactiveText:n.setActiveText}),a("p",{className:"company-management-company-users-management-modal__text",children:n.deleteText})]}),(A==null?void 0:A.text)&&a("div",{className:"company-management-company-users-management-modal__alert",role:"alert","aria-live":"assertive",children:a(q,{type:"error",heading:A.text,icon:A.icon,"data-testid":"companyUsersManagementModalAlert"})}),P("div",{className:"company-management-company-users-management-modal__actions",children:[a(x,{variant:"primary",onClick:B,disabled:v,className:"company-management-company-users-management-modal__button-primary",children:v?l==="ACTIVE"?n.settingInactiveButton:n.settingActiveButton:l==="ACTIVE"?n.setInactiveButton:n.setActiveButton}),a(x,{variant:"tertiary",onClick:b,disabled:p,className:"company-management-company-users-management-modal__button-delete",children:p?n.deletingButton:n.deleteButton}),a(x,{variant:"secondary",onClick:L,className:"company-management-company-users-management-modal__button-cancel",children:n.cancelButton})]})]})}):null},pe=[{text:"20",value:"20"},{text:"30",value:"30"},{text:"50",value:"50"},{text:"100",value:"100"},{text:"200",value:"200"}],ke=({children:t,className:i,...l})=>{const r=F(null),{permissions:m}=Z(),e=j({showAllUsers:"Company.CompanyUsers.filters.showAll",showActiveUsers:"Company.CompanyUsers.filters.showActive",showInactiveUsers:"Company.CompanyUsers.filters.showInactive",idColumn:"Company.CompanyUsers.columns.id",nameColumn:"Company.CompanyUsers.columns.name",emailColumn:"Company.CompanyUsers.columns.email",roleColumn:"Company.CompanyUsers.columns.role",teamColumn:"Company.CompanyUsers.columns.team",statusColumn:"Company.CompanyUsers.columns.status",actionsColumn:"Company.CompanyUsers.columns.actions",statusActive:"Company.CompanyUsers.status.active",statusInactive:"Company.CompanyUsers.status.inactive",emptyTeam:"Company.CompanyUsers.emptyTeam",emptyActions:"Company.CompanyUsers.emptyActions",itemsText:"Company.CompanyUsers.pagination.itemsCount",itemsPerPageLabel:"Company.CompanyUsers.pagination.itemsPerPage",showLabel:"Company.CompanyUsers.pagination.show",perPageLabel:"Company.CompanyUsers.pagination.perPage",previousPage:"Company.CompanyUsers.pagination.previous",nextPage:"Company.CompanyUsers.pagination.next",pageInfo:"Company.CompanyUsers.pagination.pageInfo",ariaLoadingUsers:"Company.CompanyUsers.ariaLabels.loadingUsers",ariaUsersTable:"Company.CompanyUsers.ariaLabels.usersTable",ariaFilterOptions:"Company.CompanyUsers.ariaLabels.filterOptions",ariaPaginationNav:"Company.CompanyUsers.ariaLabels.paginationNav",ariaPageSizeSelector:"Company.CompanyUsers.ariaLabels.pageSizeSelector",ariaPreviousPageFull:"Company.CompanyUsers.ariaLabels.previousPageFull",ariaNextPageFull:"Company.CompanyUsers.ariaLabels.nextPageFull",ariaCurrentPage:"Company.CompanyUsers.ariaLabels.currentPage",ariaShowingUsers:"Company.CompanyUsers.ariaLabels.showingUsers",ariaDataLoaded:"Company.CompanyUsers.ariaLabels.dataLoaded",ariaDataError:"Company.CompanyUsers.ariaLabels.dataError",ariaPageNavigation:"Company.CompanyUsers.ariaLabels.pageNavigation",manageUser:"Company.CompanyUsers.actions.manage",editUser:"Company.CompanyUsers.actions.edit",ariaManageUser:"Company.CompanyUsers.ariaLabels.manageUser",ariaEditUser:"Company.CompanyUsers.ariaLabels.editUser",addNewUser:"Company.CompanyUsers.actions.addNewUser"}),{users:p,loading:g,currentPage:v,pageSize:M,filterType:A,totalItems:S,totalPages:d,announcement:w,canEditUsers:U,handleFilterChange:k,handlePageSizeChange:_,handlePreviousPage:n,handleNextPage:B,refreshUsers:b}=ce({translations:{ariaDataLoaded:e.ariaDataLoaded,ariaDataError:e.ariaDataError}}),L=F(e);L.current=e,D(()=>{!g&&r.current&&p.length>0&&r.current.setAttribute("aria-busy","false")},[g,v,A,p.length]);const T=u(()=>{b()},[b]);te(T);const y=V(b),f=V(b),s=V(b),C=z(()=>{const o=L.current;return[{key:"id",label:o.idColumn},{key:"name",label:o.nameColumn},{key:"email",label:o.emailColumn},{key:"role",label:o.roleColumn},{key:"team",label:o.teamColumn},{key:"status",label:o.statusColumn},{key:"actions",label:o.actionsColumn}]},[]),I=z(()=>p.map(o=>{const c=oe(o.firstName,o.lastName),E=L.current;return{id:se(o.id),name:c,email:o.email,role:o.role,team:o.team||E.emptyTeam,status:re(o.status,E),actions:U?P("div",{className:"user-actions",children:[a(x,{variant:"tertiary",onClick:()=>f.open(o.id),"aria-label":E.ariaEditUser.replace("{name}",c),className:"edit-user-button",children:E.editUser}),a(x,{variant:"tertiary",onClick:()=>y.open(o.id),"aria-label":E.ariaManageUser.replace("{name}",c),className:"manage-user-button",children:E.manageUser})]}):a("span",{className:"no-actions",children:E.emptyActions})}}),[p,U,f,y]),N=z(()=>p.find(o=>o.id===y.selectedId),[p,y.selectedId]);return P("section",{className:i,...l,children:[a("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:w}),a(ie,{filterType:A,onFilterChange:k,translations:{showAllUsers:e.showAllUsers,showActiveUsers:e.showActiveUsers,showInactiveUsers:e.showInactiveUsers,ariaFilterOptions:e.ariaFilterOptions}}),a("div",{ref:r,"aria-busy":g,children:g?P("div",{className:"loadingContainer",role:"status","aria-live":"polite",children:[a(ee,{testId:"companyUsersTableLoader"}),a("span",{className:"sr-only",children:e.ariaLoadingUsers})]}):a(H,{columns:C,rowData:I,mobileLayout:"stacked","aria-label":e.ariaUsersTable,summary:e.ariaShowingUsers.replace("{count}",p.length.toString())})}),P("nav",{"aria-label":e.ariaPaginationNav,className:"paginationContainer",children:[a("div",{"aria-live":"polite","aria-atomic":"true",children:e.itemsText.replace("{count}",S.toString())}),d>1&&P("div",{className:"paginationButtons",role:"group","aria-label":e.ariaPageNavigation,children:[a(x,{variant:"secondary",onClick:n,disabled:v===1,"aria-label":e.ariaPreviousPageFull.replace("{current}",v.toString()),children:e.previousPage}),a("span",{"aria-current":"page","aria-live":"polite",children:e.pageInfo.replace("{current}",v.toString()).replace("{total}",d.toString())}),a(x,{variant:"secondary",onClick:B,disabled:v===d,"aria-label":e.ariaNextPageFull.replace("{current}",v.toString()),children:e.nextPage})]}),P("div",{className:"pageSizeSelector",children:[a("label",{htmlFor:"page-size-select",id:"page-size-label",children:a("span",{children:e.showLabel})}),a(K,{id:"page-size-select",name:"pageSize",value:M.toString(),options:pe,onChange:_,"aria-labelledby":"page-size-label","aria-describedby":"page-size-description"}),a("span",{id:"page-size-description",children:e.perPageLabel})]})]}),U&&a("div",{className:"addUserButtonContainer",children:a(x,{variant:"primary",onClick:()=>s.open(),"aria-label":e.addNewUser,children:e.addNewUser})}),t,s.isOpen&&U&&a(R,{open:s.isOpen,onClose:s.close,size:"medium",children:a($,{mode:"add",entityId:void 0,parentStructureId:void 0,permissions:m,onSaved:s.close,onCancel:s.close})}),f.selectedId&&f.isOpen&&U&&a(R,{open:f.isOpen,onClose:f.close,size:"medium",children:a($,{mode:"edit",entityId:f.selectedId,parentStructureId:void 0,permissions:m,onSaved:f.close,onCancel:f.close})}),y.selectedId&&U&&N&&a(me,{isOpen:y.isOpen,userId:y.selectedId,userStatus:N.status||"ACTIVE",onClose:y.close})]})};export{ke as CompanyUsers,ke as default};
//# sourceMappingURL=CompanyUsers.js.map
