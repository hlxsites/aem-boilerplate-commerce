/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as a,jsxs as h}from"@dropins/tools/preact-jsx-runtime.js";import{useState as b,useRef as F,useCallback as y,useEffect as G,useMemo as R}from"@dropins/tools/preact-hooks.js";import{InLineAlert as se,Button as P,Icon as oe,Skeleton as ie,SkeletonRow as le,Picker as ce}from"@dropins/tools/components.js";import{Fragment as me}from"@dropins/tools/preact.js";import{classes as j,VComponent as Q}from"@dropins/tools/lib.js";import{useText as q}from"@dropins/tools/i18n.js";import{u as de}from"../chunks/useCompanyContextListener.js";import{u as pe,d as ye,g as ue}from"../chunks/getCompanyUsers.js";import{f as ge}from"../chunks/fetchUserPermissions.js";import{u as Ce,C as be}from"../chunks/useInLineAlert.js";import"@dropins/tools/event-bus.js";import"../chunks/fetch-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/preact-compat.js";const he=(d,l)=>!d||typeof d!="string"?"":d==="ACTIVE"&&l.statusActive?l.statusActive:d==="INACTIVE"&&l.statusInactive?l.statusInactive:d.charAt(0).toUpperCase()+d.slice(1).toLowerCase(),ve=(d,l)=>{const u=(d==null?void 0:d.trim())||"",r=(l==null?void 0:l.trim())||"";return`${u} ${r}`.trim()},fe=({className:d,userId:l,userStatus:u,onClose:r,isOpen:w=!1,...I})=>{const[S,i]=b(!1),[v,U]=b(!1),{inLineAlertProps:T,showError:m,clearAlert:p}=Ce(),x=F(null),B=F(null),_=`modal-title-${l}`,k=`modal-desc-${l}`,e=q({title:"Company.CompanyUsers.managementModal.title",setActiveText:"Company.CompanyUsers.managementModal.setActiveText",setInactiveText:"Company.CompanyUsers.managementModal.setInactiveText",deleteText:"Company.CompanyUsers.managementModal.deleteText",setActiveButton:"Company.CompanyUsers.managementModal.setActiveButton",setInactiveButton:"Company.CompanyUsers.managementModal.setInactiveButton",settingActiveButton:"Company.CompanyUsers.managementModal.settingActiveButton",settingInactiveButton:"Company.CompanyUsers.managementModal.settingInactiveButton",deleteButton:"Company.CompanyUsers.managementModal.deleteButton",deletingButton:"Company.CompanyUsers.managementModal.deletingButton",cancelButton:"Company.CompanyUsers.managementModal.cancelButton",setActiveErrorGeneric:"Company.CompanyUsers.managementModal.setActiveErrorGeneric",setActiveErrorSpecific:"Company.CompanyUsers.managementModal.setActiveErrorSpecific",setInactiveErrorGeneric:"Company.CompanyUsers.managementModal.setInactiveErrorGeneric",setInactiveErrorSpecific:"Company.CompanyUsers.managementModal.setInactiveErrorSpecific",deleteErrorGeneric:"Company.CompanyUsers.managementModal.deleteErrorGeneric",deleteErrorSpecific:"Company.CompanyUsers.managementModal.deleteErrorSpecific",ariaCloseModal:"Company.CompanyUsers.managementModal.ariaLabels.closeModal",ariaModalDescription:"Company.CompanyUsers.managementModal.ariaLabels.modalDescription"}),s=y(async()=>{if(v)return;const o=u==="ACTIVE"?"INACTIVE":"ACTIVE",f=o==="ACTIVE";U(!0),p();try{(await pe({id:l,status:o})).success?r():m(f?e.setActiveErrorSpecific:e.setInactiveErrorSpecific)}catch{m(f?e.setActiveErrorGeneric:e.setInactiveErrorGeneric)}finally{U(!1)}},[l,u,r,v,p,m,e.setActiveErrorSpecific,e.setInactiveErrorSpecific,e.setActiveErrorGeneric,e.setInactiveErrorGeneric]),g=y(async()=>{if(!S){i(!0),p();try{(await ye({id:l})).success?r():m(e.deleteErrorSpecific)}catch{m(e.deleteErrorGeneric)}finally{i(!1)}}},[l,r,S,p,m,e.deleteErrorSpecific,e.deleteErrorGeneric]),L=y(()=>{p(),r()},[r,p]),C=y(o=>{if(o.key==="Escape"&&(p(),r()),o.key==="Tab"){const f=x.current;if(!f)return;const n=f.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),M=n[0],A=n[n.length-1];o.shiftKey?document.activeElement===M&&(A.focus(),o.preventDefault()):document.activeElement===A&&(M.focus(),o.preventDefault())}},[r,p]),N=y(o=>{o.target===o.currentTarget&&(p(),r())},[r,p]),D=y(()=>{p(),r()},[r,p]);return G(()=>{if(w)return B.current=document.activeElement,document.addEventListener("keydown",C),setTimeout(()=>{const o=x.current;if(o){const f=o.querySelector("button");f?f.focus():o.focus()}},100),()=>{document.removeEventListener("keydown",C)};B.current&&B.current.focus()},[w,C]),w?a("div",{className:j(["company-management-company-users-management-modal-overlay",d]),onClick:N,...I,children:h("div",{ref:x,className:"company-management-company-users-management-modal",role:"dialog","aria-modal":"true","aria-labelledby":_,"aria-describedby":k,tabIndex:-1,children:[h("div",{className:"company-management-company-users-management-modal__header",children:[a("h2",{id:_,className:"company-management-company-users-management-modal__title",children:e.title}),a("button",{className:"company-management-company-users-management-modal__close",onClick:D,"aria-label":e.ariaCloseModal,children:"Ã—"})]}),h("div",{id:k,className:"company-management-company-users-management-modal__content",children:[a("p",{className:"company-management-company-users-management-modal__text",children:u==="ACTIVE"?e.setInactiveText:e.setActiveText}),a("p",{className:"company-management-company-users-management-modal__text",children:e.deleteText})]}),(T==null?void 0:T.text)&&a("div",{className:"company-management-company-users-management-modal__alert",role:"alert","aria-live":"assertive",children:a(se,{type:"error",heading:T.text,icon:T.icon,"data-testid":"companyUsersManagementModalAlert"})}),h("div",{className:"company-management-company-users-management-modal__actions",children:[a(P,{variant:"primary",onClick:s,disabled:v,className:"company-management-company-users-management-modal__button-primary",children:v?u==="ACTIVE"?e.settingInactiveButton:e.settingActiveButton:u==="ACTIVE"?e.setInactiveButton:e.setActiveButton}),a("button",{type:"button",onClick:g,disabled:S,className:"company-management-company-users-management-modal__button-delete",children:S?e.deletingButton:e.deleteButton}),a(P,{variant:"secondary",onClick:L,className:"company-management-company-users-management-modal__button-cancel",children:e.cancelButton})]})]})}):null},Ue=({className:d,children:l,columns:u=[],rowData:r=[],mobileLayout:w="none",caption:I,expandedRows:S=new Set,loading:i=!1,skeletonRowCount:v=10,onSortChange:U,...T})=>{const m=q({sortedAscending:"Dropin.Table.sortedAscending",sortedDescending:"Dropin.Table.sortedDescending",sortBy:"Dropin.Table.sortBy"}),p=e=>{if(!U)return;let s;e.sortBy===!0?s="asc":e.sortBy==="asc"?s="desc":s=!0,U(e.key,s)},x=e=>{if(e.sortBy===void 0)return null;let s,g;return e.sortBy==="asc"?(s="ChevronUp",g=m.sortedAscending.replace("{label}",e.label)):e.sortBy==="desc"?(s="ChevronDown",g=m.sortedDescending.replace("{label}",e.label)):(s="Sort",g=m.sortBy.replace("{label}",e.label)),a(P,{variant:"tertiary",size:"medium",className:"dropin-table__header__sort-button",icon:a(oe,{source:s}),"aria-label":g,onClick:()=>p(e)})},B=()=>Array.from({length:v},(e,s)=>a("tr",{className:"dropin-table__body__row",children:u.map(g=>a("td",{className:"dropin-table__body__cell","data-label":g.label,children:a(ie,{children:a(le,{variant:"row",size:"small",fullWidth:!0})})},g.key))},`skeleton-${s}`)),_=()=>r.map((e,s)=>{const g=e._rowDetails!==void 0,L=S.has(s);return h(me,{children:[a("tr",{className:"dropin-table__body__row",children:u.map(C=>{const N=e[C.key];return typeof N=="string"||typeof N=="number"?a("td",{className:"dropin-table__body__cell","data-label":C.label,children:N},C.key):a("td",{className:"dropin-table__body__cell","data-label":C.label,children:a(Q,{node:N})},C.key)})}),g&&L&&a("tr",{className:"dropin-table__row-details dropin-table__row-details--expanded",id:`row-${s}-details`,children:a("td",{className:"dropin-table__row-details__cell",colSpan:u.length,role:"region","aria-labelledby":`row-${s}-details`,children:typeof e._rowDetails=="string"?e._rowDetails:a(Q,{node:e._rowDetails})})},`${s}-details`)]},s)}),k=e=>{if(e.sortBy===!0)return"none";if(e.sortBy==="asc")return"ascending";if(e.sortBy==="desc")return"descending"};return a("div",{className:j(["dropin-table",`dropin-table--mobile-layout-${w}`,d]),children:h("table",{...T,className:"dropin-table__table",children:[I&&a("caption",{className:"dropin-table__caption",children:I}),a("thead",{className:"dropin-table__header",children:a("tr",{className:"dropin-table__header__row",children:u.map(e=>h("th",{className:j(["dropin-table__header__cell",["dropin-table__header__cell--sorted",e.sortBy==="asc"||e.sortBy==="desc"],["dropin-table__header__cell--sortable",e.sortBy!==void 0]]),"aria-sort":k(e),children:[e.label,x(e)]},e.key))})}),a("tbody",{className:"dropin-table__body",children:i?B():_()})]})})},_e=20,z=1,Ae=[{text:"20",value:"20"},{text:"30",value:"30"},{text:"50",value:"50"},{text:"100",value:"100"},{text:"200",value:"200"}],ze=({children:d,className:l,...u})=>{var H;const[r,w]=b([]),[I,S]=b(!1),[i,v]=b(z),[U,T]=b(_e),[m,p]=b("all"),[x,B]=b(0),[_,k]=b(1),[e,s]=b(""),[g,L]=b(!1),[C,N]=b(""),[D,o]=b(null),f=F(null),n=q({showAllUsers:"Company.CompanyUsers.filters.showAll",showActiveUsers:"Company.CompanyUsers.filters.showActive",showInactiveUsers:"Company.CompanyUsers.filters.showInactive",idColumn:"Company.CompanyUsers.columns.id",nameColumn:"Company.CompanyUsers.columns.name",emailColumn:"Company.CompanyUsers.columns.email",roleColumn:"Company.CompanyUsers.columns.role",teamColumn:"Company.CompanyUsers.columns.team",statusColumn:"Company.CompanyUsers.columns.status",actionsColumn:"Company.CompanyUsers.columns.actions",statusActive:"Company.CompanyUsers.status.active",statusInactive:"Company.CompanyUsers.status.inactive",emptyTeam:"Company.CompanyUsers.emptyTeam",emptyActions:"Company.CompanyUsers.emptyActions",itemsText:"Company.CompanyUsers.pagination.itemsCount",itemsPerPageLabel:"Company.CompanyUsers.pagination.itemsPerPage",showLabel:"Company.CompanyUsers.pagination.show",perPageLabel:"Company.CompanyUsers.pagination.perPage",previousPage:"Company.CompanyUsers.pagination.previous",nextPage:"Company.CompanyUsers.pagination.next",pageInfo:"Company.CompanyUsers.pagination.pageInfo",ariaLoadingUsers:"Company.CompanyUsers.ariaLabels.loadingUsers",ariaUsersTable:"Company.CompanyUsers.ariaLabels.usersTable",ariaFilterOptions:"Company.CompanyUsers.ariaLabels.filterOptions",ariaPaginationNav:"Company.CompanyUsers.ariaLabels.paginationNav",ariaPageSizeSelector:"Company.CompanyUsers.ariaLabels.pageSizeSelector",ariaPreviousPageFull:"Company.CompanyUsers.ariaLabels.previousPageFull",ariaNextPageFull:"Company.CompanyUsers.ariaLabels.nextPageFull",ariaCurrentPage:"Company.CompanyUsers.ariaLabels.currentPage",ariaShowingUsers:"Company.CompanyUsers.ariaLabels.showingUsers",ariaDataLoaded:"Company.CompanyUsers.ariaLabels.dataLoaded",ariaDataError:"Company.CompanyUsers.ariaLabels.dataError",ariaPageNavigation:"Company.CompanyUsers.ariaLabels.pageNavigation",manageUser:"Company.CompanyUsers.actions.manage",ariaManageUser:"Company.CompanyUsers.ariaLabels.manageUser"}),M=F(n);M.current=n;const A=F(null),K=R(()=>{switch(m){case"active":return{status:"ACTIVE"};case"inactive":return{status:"INACTIVE"};default:return}},[m]),V=y(async()=>{var t;S(!0);try{const c=await ue({pageSize:U,currentPage:i,filter:K});if(w(c.users),B(c.totalCount||c.users.length),s(M.current.ariaDataLoaded.replace("{count}",c.users.length.toString())),(t=c.pageInfo)!=null&&t.totalPages)k(c.pageInfo.totalPages);else{const E=Math.ceil((c.totalCount||c.users.length)/U);k(E||1)}}catch(c){console.error("Failed to fetch company users:",c),w([]),B(0),k(1),s(M.current.ariaDataError)}finally{S(!1)}},[U,i,K]);A.current=V;const Z=y(async()=>{try{const{allowedIds:t}=await ge();o(t)}catch(t){console.error("Failed to fetch user permissions:",t),o(new Set)}},[]);G(()=>{V()},[V]),G(()=>{Z()},[Z]),G(()=>{!I&&f.current&&r.length>0&&f.current.setAttribute("aria-busy","false")},[I,i,m,r.length]);const X=y(()=>{var t;v(z),(t=A.current)==null||t.call(A)},[]);de(X);const $=y(t=>{p(t),v(z)},[]),Y=y(t=>{let c;if(typeof t=="string")c=t;else if("target"in t&&t.target&&"value"in t.target)c=t.target.value;else return;const E=parseInt(c,10);isNaN(E)||(T(E),v(z))},[]),ee=y(()=>{i>1&&v(i-1)},[i]),ae=y(()=>{i<_&&v(i+1)},[i,_]),W=y(t=>{N(t),L(!0)},[]),te=y(()=>{var t;L(!1),N(""),(t=A.current)==null||t.call(A)},[]),ne=R(()=>{const t=M.current;return[{key:"id",label:t.idColumn},{key:"name",label:t.nameColumn},{key:"email",label:t.emailColumn},{key:"role",label:t.roleColumn},{key:"team",label:t.teamColumn},{key:"status",label:t.statusColumn},{key:"actions",label:t.actionsColumn}]},[]),O=(D==null?void 0:D.has("Magento_Company::users_edit"))||!1,re=R(()=>r.map(t=>{var J;const c=ve(t.firstName,t.lastName),E=M.current;return{id:t.id,name:c,email:t.email,role:t.role,team:t.team||E.emptyTeam,status:he(t.status,E),actions:O?a(P,{variant:"tertiary",onClick:()=>W(t.id),"aria-label":((J=E.ariaManageUser)==null?void 0:J.replace("{name}",c))||`Manage user ${c}`,className:"manage-user-button",children:E.manageUser||"Manage"}):a("span",{className:"no-actions",children:E.emptyActions})}}),[r,W,O]);return h("section",{className:l,...u,children:[a("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:e}),h("div",{className:"filterButtons",role:"group","aria-label":n.ariaFilterOptions,children:[m!=="all"&&a(P,{variant:"tertiary",onClick:()=>$("all"),"aria-label":n.showAllUsers,children:n.showAllUsers}),m!=="active"&&a(P,{variant:"tertiary",onClick:()=>$("active"),"aria-label":n.showActiveUsers,children:n.showActiveUsers}),m!=="inactive"&&a(P,{variant:"tertiary",onClick:()=>$("inactive"),"aria-label":n.showInactiveUsers,children:n.showInactiveUsers})]}),a("div",{ref:f,"aria-busy":I,children:I?h("div",{className:"loadingContainer",role:"status","aria-live":"polite",children:[a(be,{testId:"companyUsersTableLoader"}),a("span",{className:"sr-only",children:n.ariaLoadingUsers})]}):a(Ue,{columns:ne,rowData:re,mobileLayout:"stacked","aria-label":n.ariaUsersTable,summary:n.ariaShowingUsers.replace("{count}",r.length.toString())})}),h("nav",{"aria-label":n.ariaPaginationNav,className:"paginationContainer",children:[a("div",{"aria-live":"polite","aria-atomic":"true",children:n.itemsText.replace("{count}",x.toString())}),_>1&&h("div",{className:"paginationButtons",role:"group","aria-label":n.ariaPageNavigation,children:[a(P,{variant:"secondary",onClick:ee,disabled:i===1,"aria-label":n.ariaPreviousPageFull.replace("{current}",i.toString()),children:n.previousPage}),a("span",{"aria-current":"page","aria-live":"polite",children:n.pageInfo.replace("{current}",i.toString()).replace("{total}",_.toString())}),a(P,{variant:"secondary",onClick:ae,disabled:i===_,"aria-label":n.ariaNextPageFull.replace("{current}",i.toString()),children:n.nextPage})]}),h("div",{className:"pageSizeSelector",children:[a("label",{htmlFor:"page-size-select",id:"page-size-label",children:a("span",{children:n.showLabel})}),a(ce,{id:"page-size-select",name:"pageSize",value:U.toString(),options:Ae,onChange:Y,"aria-labelledby":"page-size-label","aria-describedby":"page-size-description"}),a("span",{id:"page-size-description",children:n.perPageLabel})]})]}),d,C&&O&&a(fe,{isOpen:g,userId:C,userStatus:((H=r.find(t=>t.id===C))==null?void 0:H.status)||"ACTIVE",onClose:te})]})};export{ze as CompanyUsers,ze as default};
//# sourceMappingURL=CompanyUsers.js.map
