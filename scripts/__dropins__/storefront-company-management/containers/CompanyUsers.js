/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as a,jsxs as I}from"@dropins/tools/preact-jsx-runtime.js";import{useState as _,useRef as x,useMemo as D,useCallback as v,useEffect as F}from"@dropins/tools/preact-hooks.js";import{Button as P,InLineAlert as Z,Icon as W,Skeleton as H,SkeletonRow as J,Picker as Q,Modal as j}from"@dropins/tools/components.js";import{Fragment as X}from"@dropins/tools/preact.js";import{classes as V,VComponent as q}from"@dropins/tools/lib.js";import{useText as R}from"@dropins/tools/i18n.js";import{C as K}from"../chunks/CompanyUserForm.js";import"@dropins/tools/event-bus.js";import{u as Y,C as ee}from"../chunks/useInLineAlert.js";import{g as ae,u as te}from"../chunks/updateCompanyUserStatus.js";import{d as ne}from"../chunks/updateCompanyUser.js";import{f as re}from"../chunks/fetchUserPermissions.js";import{u as se}from"../chunks/useCompanyContextListener.js";import"@dropins/tools/preact-compat.js";import"../chunks/company-permissions.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";const oe=(s,c)=>!s||typeof s!="string"?"":s==="ACTIVE"&&c.statusActive?c.statusActive:s==="INACTIVE"&&c.statusInactive?c.statusInactive:s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(),ie=(s,c)=>{const n=(s==null?void 0:s.trim())||"",o=(c==null?void 0:c.trim())||"";return`${n} ${o}`.trim()},le=({filterType:s,onFilterChange:c,translations:n})=>{const o=[{type:"all",label:n.showAllUsers,ariaLabel:n.showAllUsers},{type:"active",label:n.showActiveUsers,ariaLabel:n.showActiveUsers},{type:"inactive",label:n.showInactiveUsers,ariaLabel:n.showInactiveUsers}];return a("div",{className:"filterButtons",role:"group","aria-label":n.ariaFilterOptions,children:o.filter(t=>t.type!==s).map(t=>a(P,{variant:"tertiary",onClick:()=>c(t.type),"aria-label":t.ariaLabel,children:t.label},t.type))})},ce=20,G=1,me=({translations:s})=>{const[c,n]=_([]),[o,t]=_(!1),[m,C]=_(G),[h,N]=_(ce),[E,S]=_("all"),[f,u]=_(0),[b,w]=_(1),[k,L]=_(""),[e,r]=_(null),g=x(s);g.current=s;const B=D(()=>{switch(E){case"active":return{status:"ACTIVE"};case"inactive":return{status:"INACTIVE"};default:return}},[E]),d=v(async()=>{t(!0);try{const l=await ae({pageSize:h,currentPage:m,filter:B});n(l.users),u(l.totalCount||l.users.length),w(l.pageInfo.totalPages),L(g.current.ariaDataLoaded.replace("{count}",l.users.length.toString()))}catch{n([]),u(0),w(1),L(g.current.ariaDataError)}finally{t(!1)}},[h,m,B]),y=v(async()=>{try{const{allowedIds:l}=await re();r(l)}catch{r(new Set)}},[]);F(()=>{d()},[d]),F(()=>{y()},[y]);const T=v(l=>{S(l),C(G)},[]),p=v(l=>{let z;if(typeof l=="string")z=l;else if("target"in l&&l.target&&"value"in l.target)z=l.target.value;else return;const $=parseInt(z,10);isNaN($)||(N($),C(G))},[]),U=v(()=>{m>1&&C(m-1)},[m]),A=v(()=>{m<b&&C(m+1)},[m,b]),i=(e==null?void 0:e.has("Magento_Company::users_edit"))||!1,M=v(async()=>{await y(),await d()},[y,d]);return{users:c,userPermissions:e,currentPage:m,pageSize:h,totalItems:f,totalPages:b,filterType:E,filter:B,loading:o,announcement:k,canEditUsers:i,handleFilterChange:T,handlePageSizeChange:p,handlePreviousPage:U,handleNextPage:A,refreshUsers:M}},O=s=>{const[c,n]=_(!1),[o,t]=_(null),m=v(h=>{h&&t(h),n(!0)},[]),C=v(()=>{n(!1),t(null),s==null||s()},[s]);return{isOpen:c,selectedId:o,open:m,close:C}},de=({className:s,userId:c,userStatus:n,onClose:o,isOpen:t=!1,...m})=>{const[C,h]=_(!1),[N,E]=_(!1),{inLineAlertProps:S,showError:f,clearAlert:u}=Y(),b=x(null),w=x(null),k=`modal-title-${c}`,L=`modal-desc-${c}`,e=R({title:"Company.CompanyUsers.managementModal.title",setActiveText:"Company.CompanyUsers.managementModal.setActiveText",setInactiveText:"Company.CompanyUsers.managementModal.setInactiveText",deleteText:"Company.CompanyUsers.managementModal.deleteText",setActiveButton:"Company.CompanyUsers.managementModal.setActiveButton",setInactiveButton:"Company.CompanyUsers.managementModal.setInactiveButton",settingActiveButton:"Company.CompanyUsers.managementModal.settingActiveButton",settingInactiveButton:"Company.CompanyUsers.managementModal.settingInactiveButton",deleteButton:"Company.CompanyUsers.managementModal.deleteButton",deletingButton:"Company.CompanyUsers.managementModal.deletingButton",cancelButton:"Company.CompanyUsers.managementModal.cancelButton",setActiveErrorGeneric:"Company.CompanyUsers.managementModal.setActiveErrorGeneric",setActiveErrorSpecific:"Company.CompanyUsers.managementModal.setActiveErrorSpecific",setInactiveErrorGeneric:"Company.CompanyUsers.managementModal.setInactiveErrorGeneric",setInactiveErrorSpecific:"Company.CompanyUsers.managementModal.setInactiveErrorSpecific",deleteErrorGeneric:"Company.CompanyUsers.managementModal.deleteErrorGeneric",deleteErrorSpecific:"Company.CompanyUsers.managementModal.deleteErrorSpecific",ariaCloseModal:"Company.CompanyUsers.managementModal.ariaLabels.closeModal",ariaModalDescription:"Company.CompanyUsers.managementModal.ariaLabels.modalDescription"}),r=v(async()=>{if(N)return;const p=n==="ACTIVE"?"INACTIVE":"ACTIVE",U=p==="ACTIVE";E(!0),u();try{(await te({id:c,status:p})).success?o():f(U?e.setActiveErrorSpecific:e.setInactiveErrorSpecific)}catch(A){const i=A instanceof Error?A.message:U?e.setActiveErrorGeneric:e.setInactiveErrorGeneric;f(i)}finally{E(!1)}},[c,n,o,N,u,f,e.setActiveErrorSpecific,e.setInactiveErrorSpecific,e.setActiveErrorGeneric,e.setInactiveErrorGeneric]),g=v(async()=>{if(!C){h(!0),u();try{(await ne({id:c})).success?o():f(e.deleteErrorSpecific)}catch(p){const U=p instanceof Error?p.message:e.deleteErrorGeneric;f(U)}finally{h(!1)}}},[c,o,C,u,f,e.deleteErrorSpecific,e.deleteErrorGeneric]),B=v(()=>{u(),o()},[o,u]),d=v(p=>{if(p.key==="Escape"&&(u(),o()),p.key==="Tab"){const U=b.current;if(!U)return;const A=U.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),i=A[0],M=A[A.length-1];p.shiftKey?document.activeElement===i&&(M.focus(),p.preventDefault()):document.activeElement===M&&(i.focus(),p.preventDefault())}},[o,u]),y=v(p=>{p.target===p.currentTarget&&(u(),o())},[o,u]),T=v(()=>{u(),o()},[o,u]);return F(()=>{if(t)return w.current=document.activeElement,document.addEventListener("keydown",d),setTimeout(()=>{const p=b.current;if(p){const U=p.querySelector("button");U?U.focus():p.focus()}},100),()=>{document.removeEventListener("keydown",d)};w.current&&w.current.focus()},[t,d]),t?a("div",{className:V(["company-management-company-users-management-modal-overlay",s]),onClick:y,...m,children:I("div",{ref:b,className:"company-management-company-users-management-modal",role:"dialog","aria-modal":"true","aria-labelledby":k,"aria-describedby":L,tabIndex:-1,children:[I("div",{className:"company-management-company-users-management-modal__header",children:[a("h2",{id:k,className:"company-management-company-users-management-modal__title",children:e.title}),a("button",{className:"company-management-company-users-management-modal__close",onClick:T,"aria-label":e.ariaCloseModal,children:"Ã—"})]}),I("div",{id:L,className:"company-management-company-users-management-modal__content",children:[a("p",{className:"company-management-company-users-management-modal__text",children:n==="ACTIVE"?e.setInactiveText:e.setActiveText}),a("p",{className:"company-management-company-users-management-modal__text",children:e.deleteText})]}),(S==null?void 0:S.text)&&a("div",{className:"company-management-company-users-management-modal__alert",role:"alert","aria-live":"assertive",children:a(Z,{type:"error",heading:S.text,icon:S.icon,"data-testid":"companyUsersManagementModalAlert"})}),I("div",{className:"company-management-company-users-management-modal__actions",children:[a(P,{variant:"primary",onClick:r,disabled:N,className:"company-management-company-users-management-modal__button-primary",children:N?n==="ACTIVE"?e.settingInactiveButton:e.settingActiveButton:n==="ACTIVE"?e.setInactiveButton:e.setActiveButton}),a(P,{variant:"tertiary",onClick:g,disabled:C,className:"company-management-company-users-management-modal__button-delete",children:C?e.deletingButton:e.deleteButton}),a(P,{variant:"secondary",onClick:B,className:"company-management-company-users-management-modal__button-cancel",children:e.cancelButton})]})]})}):null},pe=({className:s,children:c,columns:n=[],rowData:o=[],mobileLayout:t="none",caption:m,expandedRows:C=new Set,loading:h=!1,skeletonRowCount:N=10,onSortChange:E,...S})=>{const f=R({sortedAscending:"Dropin.Table.sortedAscending",sortedDescending:"Dropin.Table.sortedDescending",sortBy:"Dropin.Table.sortBy"}),u=e=>{if(!E)return;let r;e.sortBy===!0?r="asc":e.sortBy==="asc"?r="desc":r=!0,E(e.key,r)},b=e=>{if(e.sortBy===void 0)return null;let r,g;return e.sortBy==="asc"?(r="ChevronUp",g=f.sortedAscending.replace("{label}",e.label)):e.sortBy==="desc"?(r="ChevronDown",g=f.sortedDescending.replace("{label}",e.label)):(r="Sort",g=f.sortBy.replace("{label}",e.label)),a(P,{variant:"tertiary",size:"medium",className:"dropin-table__header__sort-button",icon:a(W,{source:r}),"aria-label":g,onClick:()=>u(e)})},w=()=>Array.from({length:N},(e,r)=>a("tr",{className:"dropin-table__body__row",children:n.map(g=>a("td",{className:"dropin-table__body__cell","data-label":g.label,children:a(H,{children:a(J,{variant:"row",size:"small",fullWidth:!0})})},g.key))},`skeleton-${r}`)),k=()=>o.map((e,r)=>{const g=e._rowDetails!==void 0,B=C.has(r);return I(X,{children:[a("tr",{className:"dropin-table__body__row",children:n.map(d=>{const y=e[d.key];return typeof y=="string"||typeof y=="number"?a("td",{className:"dropin-table__body__cell","data-label":d.label,children:y},d.key):a("td",{className:"dropin-table__body__cell","data-label":d.label,children:a(q,{node:y})},d.key)})}),g&&B&&a("tr",{className:"dropin-table__row-details dropin-table__row-details--expanded",id:`row-${r}-details`,children:a("td",{className:"dropin-table__row-details__cell",colSpan:n.length,role:"region","aria-labelledby":`row-${r}-details`,children:typeof e._rowDetails=="string"?e._rowDetails:a(q,{node:e._rowDetails})})},`${r}-details`)]},r)}),L=e=>{if(e.sortBy===!0)return"none";if(e.sortBy==="asc")return"ascending";if(e.sortBy==="desc")return"descending"};return a("div",{className:V(["dropin-table",`dropin-table--mobile-layout-${t}`,s]),children:I("table",{...S,className:"dropin-table__table",children:[m&&a("caption",{className:"dropin-table__caption",children:m}),a("thead",{className:"dropin-table__header",children:a("tr",{className:"dropin-table__header__row",children:n.map(e=>I("th",{className:V(["dropin-table__header__cell",["dropin-table__header__cell--sorted",e.sortBy==="asc"||e.sortBy==="desc"],["dropin-table__header__cell--sortable",e.sortBy!==void 0]]),"aria-sort":L(e),children:[e.label,b(e)]},e.key))})}),a("tbody",{className:"dropin-table__body",children:h?w():k()})]})})},ye=[{text:"20",value:"20"},{text:"30",value:"30"},{text:"50",value:"50"},{text:"100",value:"100"},{text:"200",value:"200"}],Le=({children:s,className:c,...n})=>{const o=x(null),t=R({showAllUsers:"Company.CompanyUsers.filters.showAll",showActiveUsers:"Company.CompanyUsers.filters.showActive",showInactiveUsers:"Company.CompanyUsers.filters.showInactive",idColumn:"Company.CompanyUsers.columns.id",nameColumn:"Company.CompanyUsers.columns.name",emailColumn:"Company.CompanyUsers.columns.email",roleColumn:"Company.CompanyUsers.columns.role",teamColumn:"Company.CompanyUsers.columns.team",statusColumn:"Company.CompanyUsers.columns.status",actionsColumn:"Company.CompanyUsers.columns.actions",statusActive:"Company.CompanyUsers.status.active",statusInactive:"Company.CompanyUsers.status.inactive",emptyTeam:"Company.CompanyUsers.emptyTeam",emptyActions:"Company.CompanyUsers.emptyActions",itemsText:"Company.CompanyUsers.pagination.itemsCount",itemsPerPageLabel:"Company.CompanyUsers.pagination.itemsPerPage",showLabel:"Company.CompanyUsers.pagination.show",perPageLabel:"Company.CompanyUsers.pagination.perPage",previousPage:"Company.CompanyUsers.pagination.previous",nextPage:"Company.CompanyUsers.pagination.next",pageInfo:"Company.CompanyUsers.pagination.pageInfo",ariaLoadingUsers:"Company.CompanyUsers.ariaLabels.loadingUsers",ariaUsersTable:"Company.CompanyUsers.ariaLabels.usersTable",ariaFilterOptions:"Company.CompanyUsers.ariaLabels.filterOptions",ariaPaginationNav:"Company.CompanyUsers.ariaLabels.paginationNav",ariaPageSizeSelector:"Company.CompanyUsers.ariaLabels.pageSizeSelector",ariaPreviousPageFull:"Company.CompanyUsers.ariaLabels.previousPageFull",ariaNextPageFull:"Company.CompanyUsers.ariaLabels.nextPageFull",ariaCurrentPage:"Company.CompanyUsers.ariaLabels.currentPage",ariaShowingUsers:"Company.CompanyUsers.ariaLabels.showingUsers",ariaDataLoaded:"Company.CompanyUsers.ariaLabels.dataLoaded",ariaDataError:"Company.CompanyUsers.ariaLabels.dataError",ariaPageNavigation:"Company.CompanyUsers.ariaLabels.pageNavigation",manageUser:"Company.CompanyUsers.actions.manage",editUser:"Company.CompanyUsers.actions.edit",ariaManageUser:"Company.CompanyUsers.ariaLabels.manageUser",ariaEditUser:"Company.CompanyUsers.ariaLabels.editUser",addNewUser:"Company.CompanyUsers.actions.addNewUser"}),{users:m,loading:C,currentPage:h,pageSize:N,filterType:E,totalItems:S,totalPages:f,announcement:u,canEditUsers:b,handleFilterChange:w,handlePageSizeChange:k,handlePreviousPage:L,handleNextPage:e,refreshUsers:r}=me({translations:{ariaDataLoaded:t.ariaDataLoaded,ariaDataError:t.ariaDataError}}),g=x(t);g.current=t,F(()=>{!C&&o.current&&m.length>0&&o.current.setAttribute("aria-busy","false")},[C,h,E,m.length]);const B=v(()=>{r()},[r]);se(B);const d=O(r),y=O(r),T=O(r),p=D(()=>{const i=g.current;return[{key:"id",label:i.idColumn},{key:"name",label:i.nameColumn},{key:"email",label:i.emailColumn},{key:"role",label:i.roleColumn},{key:"team",label:i.teamColumn},{key:"status",label:i.statusColumn},{key:"actions",label:i.actionsColumn}]},[]),U=D(()=>m.map(i=>{const M=ie(i.firstName,i.lastName),l=g.current;return{id:i.id,name:M,email:i.email,role:i.role,team:i.team||l.emptyTeam,status:oe(i.status,l),actions:b?I("div",{className:"user-actions",children:[a(P,{variant:"tertiary",onClick:()=>y.open(i.id),"aria-label":l.ariaEditUser.replace("{name}",M),className:"edit-user-button",children:l.editUser}),a(P,{variant:"tertiary",onClick:()=>d.open(i.id),"aria-label":l.ariaManageUser.replace("{name}",M),className:"manage-user-button",children:l.manageUser})]}):a("span",{className:"no-actions",children:l.emptyActions})}}),[m,b,y,d]),A=D(()=>m.find(i=>i.id===d.selectedId),[m,d.selectedId]);return I("section",{className:c,...n,children:[a("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:u}),a(le,{filterType:E,onFilterChange:w,translations:{showAllUsers:t.showAllUsers,showActiveUsers:t.showActiveUsers,showInactiveUsers:t.showInactiveUsers,ariaFilterOptions:t.ariaFilterOptions}}),a("div",{ref:o,"aria-busy":C,children:C?I("div",{className:"loadingContainer",role:"status","aria-live":"polite",children:[a(ee,{testId:"companyUsersTableLoader"}),a("span",{className:"sr-only",children:t.ariaLoadingUsers})]}):a(pe,{columns:p,rowData:U,mobileLayout:"stacked","aria-label":t.ariaUsersTable,summary:t.ariaShowingUsers.replace("{count}",m.length.toString())})}),I("nav",{"aria-label":t.ariaPaginationNav,className:"paginationContainer",children:[a("div",{"aria-live":"polite","aria-atomic":"true",children:t.itemsText.replace("{count}",S.toString())}),f>1&&I("div",{className:"paginationButtons",role:"group","aria-label":t.ariaPageNavigation,children:[a(P,{variant:"secondary",onClick:L,disabled:h===1,"aria-label":t.ariaPreviousPageFull.replace("{current}",h.toString()),children:t.previousPage}),a("span",{"aria-current":"page","aria-live":"polite",children:t.pageInfo.replace("{current}",h.toString()).replace("{total}",f.toString())}),a(P,{variant:"secondary",onClick:e,disabled:h===f,"aria-label":t.ariaNextPageFull.replace("{current}",h.toString()),children:t.nextPage})]}),I("div",{className:"pageSizeSelector",children:[a("label",{htmlFor:"page-size-select",id:"page-size-label",children:a("span",{children:t.showLabel})}),a(Q,{id:"page-size-select",name:"pageSize",value:N.toString(),options:ye,onChange:k,"aria-labelledby":"page-size-label","aria-describedby":"page-size-description"}),a("span",{id:"page-size-description",children:t.perPageLabel})]})]}),b&&a("div",{className:"addUserButtonContainer",children:a(P,{variant:"primary",onClick:()=>T.open(),"aria-label":t.addNewUser,children:t.addNewUser})}),s,T.isOpen&&b&&a(j,{open:T.isOpen,onClose:T.close,size:"medium",children:a(K,{mode:"add",entityId:null,parentStructureId:null,permissions:{canEditUsers:b},onSaved:T.close,onCancel:T.close})}),y.selectedId&&y.isOpen&&b&&a(j,{open:y.isOpen,onClose:y.close,size:"medium",children:a(K,{mode:"edit",entityId:y.selectedId,parentStructureId:null,permissions:{canEditUsers:b},onSaved:y.close,onCancel:y.close})}),d.selectedId&&b&&A&&a(de,{isOpen:d.isOpen,userId:d.selectedId,userStatus:A.status||"ACTIVE",onClose:d.close})]})};export{Le as CompanyUsers,Le as default};
//# sourceMappingURL=CompanyUsers.js.map
