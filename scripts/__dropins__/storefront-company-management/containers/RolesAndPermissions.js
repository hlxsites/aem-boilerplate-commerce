/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as C,Fragment as ae}from"@dropins/tools/preact-jsx-runtime.js";import{useCallback as $,useMemo as ve,useState as f,useRef as Y,useEffect as G}from"@dropins/tools/preact-hooks.js";import{classes as me}from"@dropins/tools/lib.js";import{Button as T,Picker as ge,Card as te,Header as ue,InLineAlert as re,Field as be,Input as Ae,ProgressSpinner as ie,Modal as Pe,IllustratedMessage as le}from"@dropins/tools/components.js";import{D as K,u as Ee}from"../chunks/useCompanyRoles.js";import{a as ce,b as Te}from"../chunks/company-permissions.js";import{f as _e}from"../chunks/fetchUserPermissions.js";import{u as we}from"../chunks/useInLineAlert.js";import{u as Se}from"../chunks/useCompanyContextListener.js";import{T as xe}from"../chunks/Tree.js";import{i as Ie}from"../chunks/isCompanyRoleNameAvailable.js";import{useText as Z}from"@dropins/tools/i18n.js";import{T as Me}from"../chunks/Table.js";import"../chunks/fetch-error.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/preact-compat.js";import"@dropins/tools/preact.js";const ke=l=>{try{if(/^\d+$/.test(l))return l;const n=atob(l).match(/(\d+)$/);return n?n[1]:l}catch(r){return console.warn("Failed to decode role ID:",l,r),l}},Fe=({className:l,roles:r,isLoading:n,canManageRoles:m=!1,onShowCreateForm:s,onShowEditForm:p,onDuplicateRole:_,onDeleteRole:y,totalCount:u=r.length,currentPage:R=1,pageSize:i=K,onPageChange:h,onPageSizeChange:w,children:b,...S})=>{const v=Z({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage"}),H=[{key:"id",label:v.columnId||"ID"},{key:"name",label:v.columnRole||"Role"},{key:"usersCount",label:v.columnUsers||"Users"},{key:"actions",label:v.columnActions||"Actions"}],M=$(t=>m&&t.id!=="0",[m]),q=$(t=>m&&t.id!=="0",[m]),A=$(t=>m&&t.id!=="0"&&u>1,[m,u]),L=$(t=>{const N=[];return M(t)&&N.push(e(T,{variant:"tertiary",size:"medium",onClick:()=>p(t.id),className:"role-action-button",children:v.editButton||"Edit"},"edit")),q(t)&&_&&N.push(e(T,{variant:"tertiary",size:"medium",onClick:()=>_(t.id),className:"role-action-button",children:v.duplicateButton||"Duplicate"},"duplicate")),A(t)&&y&&N.push(e(T,{variant:"tertiary",size:"medium",onClick:()=>y(t.id),className:"role-action-button",children:v.deleteButton||"Delete"},"delete")),N.length===0?m?e("span",{className:"no-actions",children:v.systemRoleLabel||"System Role"}):null:e("div",{className:"role-actions-container",children:N.map((P,k)=>C("span",{className:"role-action-wrapper",children:[k>0&&e("span",{className:"separator",children:"|"}),P]},k))})},[M,q,A,p,_,y,v,m]),F=ve(()=>r.map(t=>({id:ke(t.id),name:t.name,usersCount:t.usersCount,actions:e("div",{className:"roles-actions",children:L(t)})})),[r,L]),O=[K,30,50,100,200].map(t=>({value:t.toString(),label:t.toString(),text:t.toString()})),U=Math.ceil(u/i),D=R<U,B=R>1,x=(R-1)*i,I=x+i;return C("div",{...S,className:me(["company-management-role-and-permission-table",l]),"data-testid":"role-and-permission-table",children:[e("div",{className:"roles-table-container",children:e(Me,{columns:H,rowData:F,mobileLayout:"none",loading:n,skeletonRowCount:10})}),C("div",{className:"table-footer",children:[e("div",{className:"table-footer-left",children:C("span",{className:"item-count",children:["Items ",x+1," to ",Math.min(I,u)," of ",u," total"]})}),U>1&&e("div",{className:"table-footer-center",children:C("div",{className:"page-navigation",children:[e(T,{variant:"tertiary",size:"medium",onClick:()=>h==null?void 0:h(R-1),disabled:!B,className:"page-nav-button",children:"<"}),e("span",{className:"page-info",children:R}),e(T,{variant:"tertiary",size:"medium",onClick:()=>h==null?void 0:h(R+1),disabled:!D,className:"page-nav-button",children:">"})]})}),e("div",{className:"table-footer-right",children:C("div",{className:"pagination-controls",children:[e("span",{className:"pagination-label",children:v.show||"Show"}),e(ge,{value:i.toString(),onChange:t=>{const N=t.target;w==null||w(parseInt(N.value,10))},options:O,className:"page-size-picker",placeholder:"Select page size"}),e("span",{className:"pagination-label",children:v.perPage||"per page"})]})})]}),m&&e("div",{className:"add-role-section",children:e(T,{variant:"primary",onClick:s,children:v.addNewRole||"Add New Role"})}),b]})},De={MAX_LENGTH:40},ne=l=>(typeof l=="string"?l:String(l||"")).trim().slice(0,De.MAX_LENGTH),de=({mode:l,role:r,aclResources:n,existingRoleNames:m=[],loading:s=!1,onSubmit:p,onCancel:_,inLineAlertProps:y,prefillName:u,prefillPermissions:R})=>{const i=Z({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[h,w]=f({name:(r==null?void 0:r.name)||""}),[b,S]=f({}),[v,H]=f({}),[M,q]=f(!1),[A,L]=f(!1),[F,O]=f([]),[U,D]=f(new Set),[B,x]=f(new Set),I=Y(null),t=Y("");G(()=>{if(l==="edit"&&r){if(w({name:r.name}),r.permissions&&r.permissions.length>0){const o=ce(r.permissions);x(new Set(o))}}else if(l==="create")if(w({name:u??""}),R&&R.length>0){const a=ce(R);x(new Set(a))}else x(new Set)},[l,r,u,R]),G(()=>{if(n.length>0){const o=Le(n);O(o);const a=o.filter(d=>!d.parentId).map(d=>d.id);D(new Set(a))}},[n]),G(()=>()=>{I.current&&clearTimeout(I.current)},[]);const N=$(o=>{const a=ne(o);return a?(l==="edit"&&r?m.filter(g=>g!==r.name):m).includes(a)?i.roleNameExists:null:i.roleNameRequired||"This is a required field."},[l,r,m,i.roleNameRequired,i.roleNameExists]),P=$(async o=>{const a=ne(o),d=N(a);if(d)return d;if(l==="edit"&&r&&a===r.name)return null;try{return q(!0),await Ie({name:a})?null:i.roleNameExists}catch(g){return console.error("Role name validation failed:",g),null}finally{q(!1)}},[l,r,i.roleNameExists,N]),k=$(o=>{I.current&&clearTimeout(I.current),o!==t.current&&(I.current=setTimeout(async()=>{const a=await P(o);S(a?d=>({...d,name:a}):d=>({...d,name:""})),t.current=o},500))},[P]),J=()=>{const o={};let a=!0;const d=N(h.name);return d&&(o.name=d,a=!1),S(o),a},j=o=>{const a=typeof o=="string"?o:o.target.value;w(d=>({...d,name:a})),b.name&&S(d=>({...d,name:""})),k(a)},Q=o=>{const d=o.target.value;H(g=>({...g,name:!0})),I.current&&clearTimeout(I.current),P(d).then(g=>{S(g?V=>({...V,name:g}):V=>({...V,name:""})),t.current=d})},W=()=>{const o=new Set(F.map(a=>a.id));D(o)},X=()=>{D(new Set)},ee=async o=>{o.preventDefault(),H({name:!0}),L(!0);try{const a=await P(h.name);if(a){S(g=>({...g,name:a}));return}if(!J())return;const d={name:ne(h.name),permissions:Array.from(B)};p&&await p(d)}catch(a){console.error("Form submission failed:",a)}finally{L(!1)}},se=l==="create"?i.createTitle:i.editTitle;return C(te,{variant:"secondary",className:"edit-role-and-permission",children:[e(ue,{title:se,divider:!1,className:"edit-role-and-permission__title"}),(y==null?void 0:y.text)&&e(re,{className:"edit-role-and-permission__notification",type:y.type,variant:"secondary",heading:y.text,"data-testid":"editRoleInLineAlert"}),C("form",{className:"edit-role-and-permission-form",onSubmit:ee,children:[C("div",{className:"edit-role-and-permission__section",children:[e("h3",{className:"edit-role-and-permission__section-title",children:i.roleInformation||"Role Information"}),e(be,{label:i.roleName||"Role Name",required:!0,error:v.name&&b.name?b.name:void 0,children:e(Ae,{type:"text",name:"roleName",value:h.name,onChange:j,onBlur:Q,disabled:s||A,"data-testid":"roleNameInput",placeholder:i.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),M&&e("div",{className:"edit-role-and-permission__validation-spinner",children:e(ie,{size:"medium"})})]}),C("div",{className:"edit-role-and-permission__section",children:[e("h3",{className:"edit-role-and-permission__section-title",children:i.rolePermissions}),e("p",{className:"edit-role-and-permission__permissions-description",children:i.permissionsDescription}),C("div",{className:"edit-role-and-permission__tree-controls",children:[e(T,{type:"button",variant:"tertiary",onClick:W,disabled:s||A,children:i.expandAll}),e(T,{type:"button",variant:"tertiary",onClick:X,disabled:s||A,children:i.collapseAll})]}),e("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":i.rolePermissions,children:F.length>0?e(xe,{items:F,expandedIds:U,onExpandedChange:D,checkedIds:B,onCheckedChange:x,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:o,expanded:a,hasChildren:d,toggle:g,checkbox:V})=>C("div",{className:"edit-role-and-permission__tree-node",children:[d&&e("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:g,"aria-label":a?`Collapse ${o.label}`:`Expand ${o.label}`,children:a?"âˆ’":"+"}),V&&V(),e("span",{className:"edit-role-and-permission__tree-label",children:o.label})]})}):e("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),C("div",{className:"edit-role-and-permission__actions",children:[e(T,{type:"button",variant:"secondary",onClick:_,disabled:s||A,children:i.cancel}),e(T,{type:"submit",variant:"primary",disabled:s||A||M,children:s||A?i.saving:i.saveRole})]})]}),(s||A)&&C("div",{className:"edit-role-and-permission__loading-overlay",children:[e(ie,{size:"large"}),e("div",{className:"edit-role-and-permission__loading-text",children:i.saving})]})]})},Le=l=>{const r=[],n=(s,p)=>{r.push({id:s.id,parentId:p||null,label:s.text}),s.children&&[...s.children].sort((y,u)=>y.sortOrder-u.sortOrder).forEach(y=>{n(y,s.id)})};return[...l].sort((s,p)=>s.sortOrder-p.sortOrder).forEach(s=>n(s)),r},Oe=({isOpen:l,hasUsers:r=!1,onConfirm:n,onCancel:m})=>{const s=Z({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!l)return null;const p=r?s.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":s.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return C(Pe,{open:!0,onClose:m,title:e(ae,{children:r?s.cannotDeleteModalTitle||"Cannot Delete Role":s.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[e("div",{className:"delete-role-modal__content",children:e("p",{children:p})}),e("div",{className:"delete-role-modal__actions",children:r?e(T,{variant:"primary",onClick:n,className:"delete-role-modal__ok-btn",children:s.cannotDeleteModalOk||"OK"}):C(ae,{children:[e(T,{variant:"secondary",onClick:m,className:"delete-role-modal__cancel-btn",children:s.deleteModalCancel||"Cancel"}),e(T,{variant:"primary",onClick:n,className:"delete-role-modal__confirm-btn",children:s.deleteModalConfirm||"Delete"})]})})]})},Ue=()=>{const[l,r]=f(null),[n,m]=f(!0),[s,p]=f(null),_=Y(!1),y=Y(!1),u=$(async()=>{var R,i;if(!_.current){_.current=!0,m(!0),p(null);try{const{roleResponse:h}=await _e(),w=(i=(R=h==null?void 0:h.data)==null?void 0:R.customer)==null?void 0:i.role,b=Te(w);r(b)}catch(h){console.error("Failed to fetch user permissions:",h),p(h)}finally{m(!1),_.current=!1}}},[]);return G(()=>{y.current||(y.current=!0,u())},[u]),{permissions:l,loading:n,error:s,refetch:u}},rs=({className:l,withHeader:r=!1})=>{const n=Z({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:m,handleSetInLineAlert:s}=we(),{permissions:p,loading:_,error:y}=Ue(),{roles:u,aclResources:R,isLoading:i,isCreating:h,isUpdating:w,error:b,createRole:S,updateRole:v,deleteRole:H,clearError:M}=Ee(K,!0,!0),[q,A]=f(!1),[L,F]=f(!1),[O,U]=f(null),[D,B]=f(1),[x,I]=f(K),[t,N]=f(null),[P,k]=f(null);G(()=>()=>{b&&M(),k(null)},[b,M]),Se(()=>{B(1),L&&(F(!1),U(null)),N(null),M()},{eager:!0});const J=(p==null?void 0:p.canViewRoles)??!1,j=(p==null?void 0:p.canManageRoles)??!1,Q=J||j;if(_)return e("div",{"data-testid":"rolesAndPermissionsLoader",children:e("div",{children:"Loading..."})});if(y)return e(te,{variant:"secondary",className:"roles-and-permissions-error",children:e("div",{className:"roles-and-permissions-error__wrapper",children:e("div",{className:"roles-and-permissions-error__content",children:e(le,{heading:n.errorTitle||"Error Loading Permissions",message:e("p",{children:n.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})});if(!Q)return e(te,{variant:"secondary",className:"roles-and-permissions-no-access",children:e("div",{className:"roles-and-permissions-no-access__wrapper",children:e("div",{className:"roles-and-permissions-no-access__content",children:e(le,{heading:n.noAccessTitle||"Access Restricted",message:e("p",{children:n.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})});const W=u.length,X=(D-1)*x,ee=X+x,se=u.slice(X,ee),o=c=>{B(c)},a=c=>{I(c),B(1)},d=()=>{k(null),A(!0)},g=()=>{k(null),A(!1)},V=c=>{U(c),F(!0)},oe=()=>{F(!1),U(null)},pe=c=>{const E=u.find(z=>z.id===c);E&&(k({name:`${E.name} - Duplicated`,permissions:E.permissions||[]}),A(!0))},he=async c=>{try{if(await S({name:c.name,permissions:c.permissions})){const z=n.createSuccess?n.createSuccess.replace("{roleName}",c.name):`Role "${c.name}" created successfully!`;s({type:"success",text:z}),g()}else s({type:"error",text:n.createError||"Failed to create role. Please try again."})}catch{s({type:"error",text:n.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},ye=async c=>{if(O)try{if(await v({id:O,name:c.name,permissions:c.permissions})){const z=n.updateSuccess?n.updateSuccess.replace("{roleName}",c.name):`Role "${c.name}" updated successfully!`;s({type:"success",text:z}),oe()}else s({type:"error",text:n.updateError||"Failed to update role. Please try again."})}catch{s({type:"error",text:n.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},fe=c=>{const E=u.find(Ce=>Ce.id===c);if(!E)return;const z=E.usersCount>0;N({id:c,name:E.name,hasUsers:z})},Re=async()=>{if(t){if(t.hasUsers){N(null);return}try{if(await H(t.id)){const E=n.deleteRoleSuccess?n.deleteRoleSuccess.replace("{roleName}",t.name||"Unknown Role"):`You have deleted role "${t.name||"Unknown Role"}".`;s({type:"success",text:E})}else s({type:"error",text:n.deleteError||"Failed to delete role. Please try again."})}catch{s({type:"error",text:n.deleteError||"Failed to delete role. Please try again."})}finally{N(null)}}},Ne=()=>N(null);return C("div",{className:me(["roles-and-permissions",l]),children:[r?e(ue,{title:n.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,b&&e(re,{type:"error",heading:n.errorTitle||"Error",description:n.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:M}),m&&m.text&&e(re,{type:m.type||"success",heading:m.text,icon:m.icon}),q?e(de,{mode:"create",aclResources:R,existingRoleNames:u.map(c=>c.name),loading:h,onSubmit:he,onCancel:()=>{k(null),g()},inLineAlertProps:b?{type:"error",text:b}:void 0,prefillName:P==null?void 0:P.name,prefillPermissions:P==null?void 0:P.permissions}):L&&O?e(de,{mode:"edit",role:u.find(c=>c.id===O),aclResources:R,existingRoleNames:u.map(c=>c.name),loading:w,onSubmit:ye,onCancel:oe,inLineAlertProps:b?{type:"error",text:b}:void 0}):e(Fe,{roles:se,isLoading:i,canManageRoles:j,onShowCreateForm:d,onShowEditForm:V,onDuplicateRole:pe,onDeleteRole:fe,totalCount:W,currentPage:D,pageSize:x,onPageChange:o,onPageSizeChange:a}),e(Oe,{isOpen:!!t,hasUsers:t==null?void 0:t.hasUsers,onConfirm:Re,onCancel:Ne})]})};export{rs as RolesAndPermissions,rs as default};
//# sourceMappingURL=RolesAndPermissions.js.map
