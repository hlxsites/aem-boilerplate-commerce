/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as z,Fragment as ge}from"@dropins/tools/preact-jsx-runtime.js";import{useState as _,useCallback as P,useEffect as ee,useMemo as he,useRef as re}from"@dropins/tools/preact-hooks.js";import{classes as me,VComponent as Re}from"@dropins/tools/lib.js";import{Button as X,Icon as Ee,Skeleton as ke,SkeletonRow as Se,Picker as xe,Checkbox as De,Card as ye,Header as de,InLineAlert as ue,Field as Ie,Input as Fe,ProgressSpinner as _e,Modal as Me,IllustratedMessage as Ne}from"@dropins/tools/components.js";import{u as be}from"../chunks/useCompanyContextListener.js";import{g as ve,a as Be,c as Le,u as ze,d as Ue,i as we}from"../chunks/isCompanyRoleNameAvailable.js";import{f as Ce,b as Oe}from"../chunks/company-permissions.js";import{f as $e}from"../chunks/fetchUserPermissions.js";import{u as Ve}from"../chunks/useInLineAlert.js";import{useText as ie}from"@dropins/tools/i18n.js";import{Fragment as qe}from"@dropins/tools/preact.js";import"@dropins/tools/event-bus.js";import"../chunks/fetch-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/preact-compat.js";const He=({className:m,children:c,columns:i=[],rowData:u=[],mobileLayout:n="none",caption:h,expandedRows:k=new Set,loading:w=!1,skeletonRowCount:N=10,onSortChange:y,...d})=>{const p=ie({sortedAscending:"Dropin.Table.sortedAscending",sortedDescending:"Dropin.Table.sortedDescending",sortBy:"Dropin.Table.sortBy"}),U=l=>{if(!y)return;let b;l.sortBy===!0?b="asc":l.sortBy==="asc"?b="desc":b=!0,y(l.key,b)},j=l=>{if(l.sortBy===void 0)return null;let b,v;return l.sortBy==="asc"?(b="ChevronUp",v=p.sortedAscending.replace("{label}",l.label)):l.sortBy==="desc"?(b="ChevronDown",v=p.sortedDescending.replace("{label}",l.label)):(b="Sort",v=p.sortBy.replace("{label}",l.label)),e(X,{variant:"tertiary",size:"medium",className:"dropin-table__header__sort-button",icon:e(Ee,{source:b}),"aria-label":v,onClick:()=>U(l)})},H=()=>Array.from({length:N},(l,b)=>e("tr",{className:"dropin-table__body__row",children:i.map(v=>e("td",{className:"dropin-table__body__cell","data-label":v.label,children:e(ke,{children:e(Se,{variant:"row",size:"small",fullWidth:!0})})},v.key))},`skeleton-${b}`)),S=()=>u.map((l,b)=>{const v=l._rowDetails!==void 0,G=k.has(b);return z(qe,{children:[e("tr",{className:"dropin-table__body__row",children:i.map($=>{const F=l[$.key];return typeof F=="string"||typeof F=="number"?e("td",{className:"dropin-table__body__cell","data-label":$.label,children:F},$.key):e("td",{className:"dropin-table__body__cell","data-label":$.label,children:e(Re,{node:F})},$.key)})}),v&&G&&e("tr",{className:"dropin-table__row-details dropin-table__row-details--expanded",id:`row-${b}-details`,children:e("td",{className:"dropin-table__row-details__cell",colSpan:i.length,role:"region","aria-labelledby":`row-${b}-details`,children:typeof l._rowDetails=="string"?l._rowDetails:e(Re,{node:l._rowDetails})})},`${b}-details`)]},b)}),I=l=>{if(l.sortBy===!0)return"none";if(l.sortBy==="asc")return"ascending";if(l.sortBy==="desc")return"descending"};return e("div",{className:me(["dropin-table",`dropin-table--mobile-layout-${n}`,m]),children:z("table",{...d,className:"dropin-table__table",children:[h&&e("caption",{className:"dropin-table__caption",children:h}),e("thead",{className:"dropin-table__header",children:e("tr",{className:"dropin-table__header__row",children:i.map(l=>z("th",{className:me(["dropin-table__header__cell",["dropin-table__header__cell--sorted",l.sortBy==="asc"||l.sortBy==="desc"],["dropin-table__header__cell--sortable",l.sortBy!==void 0]]),"aria-sort":I(l),children:[l.label,j(l)]},l.key))})}),e("tbody",{className:"dropin-table__body",children:w?H():S()})]})})},oe=20,je=(m=oe,c=!0,i=!1)=>{const[u,n]=_([]),[h,k]=_([]),[w,N]=_(0),[y,d]=_(1),[p,U]=_(m),[j,H]=_(1),[S,I]=_(!1),[l,b]=_(!1),[v,G]=_(!1),[$,F]=_(!1),[x,C]=_(null),A=P(async(s={})=>{I(!0),C(null);try{if(i){const t=await ve({pageSize:1e3,currentPage:1,...s});n(t.items),N(t.totalCount),H(1),d(1)}else{const t=await ve({pageSize:p,currentPage:y,...s});n(t.items),N(t.totalCount),H(t.pageInfo.totalPages),d(t.pageInfo.currentPage)}}catch(t){C(t instanceof Error?t.message:"Failed to fetch roles")}finally{I(!1)}},[i,p,y]),L=P(async()=>{try{const s=await Be();k(s)}catch(s){C(s instanceof Error?s.message:"Failed to fetch ACL resources")}},[]),M=P(async s=>{b(!0),C(null);try{const t=await Le(s);return await A(),t}catch(t){return C(t instanceof Error?t.message:"Failed to create role"),null}finally{b(!1)}},[A]),V=P(async s=>{G(!0),C(null);try{const t=await ze(s);return n(E=>E.map(D=>D.id===t.id?t:D)),t}catch(t){return C(t instanceof Error?t.message:"Failed to update role"),null}finally{G(!1)}},[]),r=P(async s=>{F(!0),C(null);try{const t=await Ue({id:s});return t&&(n(E=>E.filter(D=>D.id!==s)),N(E=>E-1)),t}catch(t){return C(t instanceof Error?t.message:"Failed to delete role"),!1}finally{F(!1)}},[]),B=P(async s=>{try{return await we({name:s})}catch(t){return C(t instanceof Error?t.message:"Failed to check role name availability"),!1}},[]),T=P(s=>{d(s)},[]),q=P(s=>{U(s),d(1)},[]),J=P(async()=>{await Promise.all([A(),L()])},[A,L]),W=P(()=>{C(null)},[]);return ee(()=>{c&&A()},[A,c]),ee(()=>{c&&L()},[L,c]),be(P(()=>{d(1),n([]),k([]),N(0),H(0),I(!0)},[]),{eager:!0}),{roles:u,aclResources:h,totalCount:w,currentPage:y,pageSize:p,totalPages:j,isLoading:S,isCreating:l,isUpdating:v,isDeleting:$,error:x,fetchRoles:A,fetchAclResources:L,createRole:M,updateRole:V,deleteRole:r,checkRoleNameAvailability:B,setPage:T,setPageSize:q,refresh:J,clearError:W}},Ge=m=>{try{if(/^\d+$/.test(m))return m;const i=atob(m).match(/(\d+)$/);return i?i[1]:m}catch(c){return console.warn("Failed to decode role ID:",m,c),m}},Ke=({className:m,roles:c,isLoading:i,canManageRoles:u=!1,onShowCreateForm:n,onShowEditForm:h,onDuplicateRole:k,onDeleteRole:w,totalCount:N=c.length,currentPage:y=1,pageSize:d=oe,onPageChange:p,onPageSizeChange:U,children:j,...H})=>{const S=ie({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage"}),I=[{key:"id",label:S.columnId||"ID"},{key:"name",label:S.columnRole||"Role"},{key:"usersCount",label:S.columnUsers||"Users"},{key:"actions",label:S.columnActions||"Actions"}],l=P(r=>u&&r.id!=="0",[u]),b=P(r=>u&&r.id!=="0",[u]),v=P(r=>u&&r.id!=="0"&&N>1,[u,N]),G=P(r=>{const B=[];return l(r)&&B.push(e(X,{variant:"tertiary",size:"medium",onClick:()=>h(r.id),className:"role-action-button",children:S.editButton||"Edit"},"edit")),b(r)&&k&&B.push(e(X,{variant:"tertiary",size:"medium",onClick:()=>k(r.id),className:"role-action-button",children:S.duplicateButton||"Duplicate"},"duplicate")),v(r)&&w&&B.push(e(X,{variant:"tertiary",size:"medium",onClick:()=>w(r.id),className:"role-action-button",children:S.deleteButton||"Delete"},"delete")),B.length===0?u?e("span",{className:"no-actions",children:S.systemRoleLabel||"System Role"}):null:e("div",{className:"role-actions-container",children:B.map((T,q)=>z("span",{className:"role-action-wrapper",children:[q>0&&e("span",{className:"separator",children:"|"}),T]},q))})},[l,b,v,h,k,w,S,u]),$=he(()=>c.map(r=>({id:Ge(r.id),name:r.name,usersCount:r.usersCount,actions:e("div",{className:"roles-actions",children:G(r)})})),[c,G]),F=[oe,30,50,100,200].map(r=>({value:r.toString(),label:r.toString(),text:r.toString()})),x=Math.ceil(N/d),C=y<x,A=y>1,L=(y-1)*d,M=L+d,V=P(()=>{const r=[];if(x<=7)for(let T=1;T<=x;T++)r.push(T);else if(r.push(1),y<=3){for(let T=2;T<=5;T++)r.push(T);r.push("ellipsis-end"),r.push(x)}else if(y>=x-2){r.push("ellipsis-start");for(let T=x-4;T<=x;T++)r.push(T)}else{r.push("ellipsis-start");for(let T=y-1;T<=y+1;T++)r.push(T);r.push("ellipsis-end"),r.push(x)}return r},[y,x]);return z("div",{...H,className:me(["company-management-role-and-permission-table",m]),"data-testid":"role-and-permission-table",children:[e("div",{className:"roles-table-container",children:e(He,{columns:I,rowData:$,mobileLayout:"stacked",loading:i,skeletonRowCount:10})}),z("div",{className:"table-footer",children:[e("div",{className:"table-footer-left",children:z("span",{className:"item-count",children:["Items ",L+1," to ",Math.min(M,N)," of ",N," total"]})}),x>1&&e("div",{className:"table-footer-center",children:z("div",{className:"page-navigation",children:[e(X,{variant:"tertiary",size:"medium",onClick:()=>p==null?void 0:p(y-1),disabled:!A,className:"page-nav-button",children:"<"}),V().map(r=>typeof r=="string"?e("span",{className:"page-ellipsis",children:"..."},r):e(X,{variant:"tertiary",size:"medium",onClick:()=>p==null?void 0:p(r),disabled:r===y,className:r===y?"page-num-button active":"page-num-button",children:r},r)),e(X,{variant:"tertiary",size:"medium",onClick:()=>p==null?void 0:p(y+1),disabled:!C,className:"page-nav-button",children:">"})]})}),e("div",{className:"table-footer-right",children:z("div",{className:"pagination-controls",children:[e("span",{className:"pagination-label",children:S.show||"Show"}),e(xe,{value:d.toString(),onChange:r=>{const B=r.target;U==null||U(parseInt(B.value,10))},options:F,className:"page-size-picker"}),e("span",{className:"pagination-label",children:S.perPage||"per page"})]})})]}),u&&e("div",{className:"add-role-section",children:e(X,{variant:"primary",onClick:n,children:S.addNewRole||"Add New Role"})}),j]})},Xe=(m,c=!1)=>{const i=new Map;for(const u of m){const n=u.parentId??null,h=i.get(n)??[];h.push(u),i.set(n,h)}if(!c)for(const[,u]of i)u.sort((n,h)=>n.label.localeCompare(h.label));return i},Ye=({items:m,rootId:c=null,className:i,expandedIds:u,selectedId:n=null,selectedIds:h,onExpandedChange:k,onSelectedChange:w,onSelectedIdsChange:N,renderNode:y,role:d="tree",preserveOrder:p=!1,draggable:U,canDrop:j,onMove:H,isCheckable:S,checkedIds:I,onCheckedChange:l,biDirectionalChecking:b=!1,renderExpander:v,renderCheckbox:G,renderIcon:$})=>{const F=he(()=>Xe(m,p),[m,p]),x=re(null),C=re(!1),A=he(()=>new Map(m.map(s=>[s.id,s])),[m]),L=(s,t)=>{const E=[],D=[t];for(;D.length;){const g=D.pop(),o=s.get(g)??[];for(const a of o)E.push(a.id),D.push(a.id)}return E},M=P(s=>L(F,s),[F]),V=P(s=>S?S(s):!0,[S]),r=P(s=>{if(!A.get(s))return{checked:!1,indeterminate:!1};const E=I??new Set;if(b){if(E.has(s))return{checked:!0,indeterminate:!1};const o=M(s).filter(f=>{const K=A.get(f);return K?V(K):!1});return o.length===0?{checked:!1,indeterminate:!1}:o.reduce((f,K)=>E.has(K)?f+1:f,0)===0?{checked:!1,indeterminate:!1}:{checked:!1,indeterminate:!0}}const D=[s,...M(s)].filter(o=>{const a=A.get(o);return a?V(a):!1});if(D.length===0)return{checked:!1,indeterminate:!1};const g=D.reduce((o,a)=>E.has(a)?o+1:o,0);return g===0?{checked:!1,indeterminate:!1}:g===D.length?{checked:!0,indeterminate:!1}:{checked:!1,indeterminate:!0}},[A,M,V,I,b]),B=P(s=>{if(!l)return;const t=new Set(I??[]),{checked:E}=r(s),D=M(s),g=[s,...D].filter(o=>{const a=A.get(o);return a?V(a):!1});if(E)for(const o of g)t.delete(o);else for(const o of g)t.add(o);if(b&&!E){const o=A.get(s);if(o){let a=o.parentId;for(;a;){const f=A.get(a);if(!f||!V(f))break;t.add(a),a=f.parentId}}}l(t)},[I,l,r,M,A,V,b]),T=P(s=>e(De,{name:`tree-checkbox-${Math.random().toString(36).substr(2,9)}`,checked:s.checked,indeterminate:s.indeterminate,onChange:s.onCheck}),[]),q=P(s=>{const t=new Set(u);t.has(s)?t.delete(s):t.add(s),k(t)},[u,k]),J=P(s=>{const t=A.get(s);if(t&&V(t)&&l&&B(s),!N){w==null||w(s);return}const E=!!C.current,D=E?new Set(h??[]):new Set;E&&D.has(s)?D.delete(s):D.add(s),N(D),C.current=!1},[w,N,h,A,V,l,B]),W=(s,t)=>{const E=F.get(s)??[];return E.length?e("ul",{role:t===1?d:"group",className:t===1?i??"acm-tree":"acm-tree__group",children:E.map((g,o)=>{const a=(F.get(g.id)??[]).length>0,f=u.has(g.id),K=h?h.has(g.id):n===g.id,se=!!(U!=null&&U(g)),ne=O=>j?j(O,g.id):O!==g.id,le=a?()=>v?v({expanded:f,hasChildren:a,toggle:()=>q(g.id)}):null:void 0,ae=(()=>{if(!l)return;const O=A.get(g.id);if(!O||!V(O))return;const Y=r(g.id),Q=G||T;return()=>Q({checked:Y.checked,indeterminate:Y.indeterminate,onCheck:()=>B(g.id)})})(),ce=$?()=>$({item:g,level:t,hasChildren:a,expanded:f}):void 0,pe=y({item:g,level:t,expanded:f,selected:!!K,hasChildren:a,toggle:()=>q(g.id),select:()=>J(g.id),...le?{expander:le}:{},...ae?{checkbox:ae}:{},...ce?{icon:ce}:{}});return z("li",{role:"treeitem",className:"acm-tree__item","data-level":t,"aria-expanded":a?f:void 0,"aria-selected":K||void 0,"aria-level":t,"aria-setsize":E.length,"aria-posinset":o+1,draggable:se,onMouseDown:O=>{C.current=!!(O.metaKey||O.ctrlKey)},onDragStart:O=>{var Y;if(O.stopPropagation(),!!se){x.current=g.id;try{(Y=O.dataTransfer)==null||Y.setData("text/plain",g.id)}catch{}}},onDragOver:O=>{var Q;O.stopPropagation();const Y=x.current??(((Q=O.dataTransfer)==null?void 0:Q.getData("text/plain"))||"");Y&&ne(Y)&&O.preventDefault()},onDrop:O=>{var Q;O.stopPropagation();const Y=x.current??(((Q=O.dataTransfer)==null?void 0:Q.getData("text/plain"))||"");x.current=null,Y&&ne(Y)&&(H==null||H({id:Y,newParentId:g.id}))},children:[pe,a&&f?W(g.id,t+1):null]},g.id)})}):null};return e("div",{className:"acm-tree-root",children:W(c,1)})},We={MAX_LENGTH:40},fe=m=>(typeof m=="string"?m:String(m||"")).trim().slice(0,We.MAX_LENGTH),Ae=({mode:m,role:c,aclResources:i,existingRoleNames:u=[],loading:n=!1,onSubmit:h,onCancel:k,inLineAlertProps:w,prefillName:N,prefillPermissions:y})=>{const d=ie({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[p,U]=_({name:(c==null?void 0:c.name)||""}),[j,H]=_({}),[S,I]=_({}),[l,b]=_(!1),[v,G]=_(!1),[$,F]=_([]),[x,C]=_(new Set),[A,L]=_(new Set),M=re(null),V=re(""),r=re(!1);ee(()=>{if(!r.current){if(r.current=!0,m==="edit"&&c){if(U({name:c.name}),c.permissions&&c.permissions.length>0){const o=Ce(c.permissions);L(new Set(o))}}else if(m==="create")if(U({name:N??""}),y&&y.length>0){const a=Ce(y);L(new Set(a))}else L(new Set)}},[m,c,N,y]),ee(()=>{if(i.length>0){const o=Ze(i);F(o);const a=o.filter(f=>!f.parentId).map(f=>f.id);C(new Set(a))}},[i]),ee(()=>()=>{M.current&&clearTimeout(M.current)},[]);const B=P(o=>{const a=fe(o);return a?(m==="edit"&&c?u.filter(K=>K!==c.name):u).includes(a)?d.roleNameExists:null:d.roleNameRequired||"This is a required field."},[m,c,u,d.roleNameRequired,d.roleNameExists]),T=P(async o=>{const a=fe(o),f=B(a);if(f)return f;if(m==="edit"&&c&&a===c.name)return null;try{return b(!0),await we({name:a})?null:d.roleNameExists}catch(K){return console.error("Role name validation failed:",K),null}finally{b(!1)}},[m,c,d.roleNameExists,B]),q=P(o=>{M.current!==null&&clearTimeout(M.current),o!==V.current&&(M.current=window.setTimeout(async()=>{const a=await T(o);H(a?f=>({...f,name:a}):f=>({...f,name:""})),V.current=o},500))},[T]),J=()=>{const o={};let a=!0;const f=B(p.name);return f&&(o.name=f,a=!1),H(o),a},W=o=>{const a=typeof o=="string"?o:o.target.value;U(f=>({...f,name:a})),j.name&&H(f=>({...f,name:""})),q(a)},s=()=>{I(o=>({...o,name:!0})),M.current&&(clearTimeout(M.current),M.current=null)},t=()=>{const o=new Set($.map(a=>a.id));C(o)},E=()=>{C(new Set)},D=async o=>{if(o.preventDefault(),!v&&(I({name:!0}),!!J()&&!j.name)){G(!0);try{const a={name:fe(p.name),permissions:Array.from(A)};h&&await h(a)}catch(a){console.error("Form submission failed:",a)}finally{G(!1)}}},g=m==="create"?d.createTitle:d.editTitle;return z(ye,{variant:"secondary",className:"edit-role-and-permission",children:[e(de,{level:2,size:"large",title:g,divider:!1,className:"edit-role-and-permission__title"}),(w==null?void 0:w.text)&&e(ue,{className:"edit-role-and-permission__notification",type:w.type,variant:"secondary",heading:w.text,"data-testid":"editRoleInLineAlert"}),z("form",{className:"edit-role-and-permission-form",onSubmit:D,children:[z("div",{className:"edit-role-and-permission__section",children:[e(de,{level:3,size:"medium",title:d.roleInformation||"Role Information",divider:!1,className:"edit-role-and-permission__section-title"}),e(Ie,{label:d.roleName||"Role Name",required:!0,error:S.name&&j.name?j.name:void 0,children:e(Fe,{type:"text",name:"roleName",value:p.name,onChange:W,onBlur:s,disabled:n||v,"data-testid":"roleNameInput",placeholder:d.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),l&&e("div",{className:"edit-role-and-permission__validation-spinner",children:e(_e,{size:"medium"})})]}),z("div",{className:"edit-role-and-permission__section",children:[e(de,{level:3,size:"medium",title:d.rolePermissions,divider:!1,className:"edit-role-and-permission__section-title"}),e(ue,{type:"info",variant:"secondary",heading:d.permissionsDescription,className:"edit-role-and-permission__permissions-description"}),z("div",{className:"edit-role-and-permission__tree-controls",children:[e(X,{type:"button",variant:"tertiary",onClick:t,disabled:n||v,children:d.expandAll}),e(X,{type:"button",variant:"tertiary",onClick:E,disabled:n||v,children:d.collapseAll})]}),e("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":d.rolePermissions,children:$.length>0?e(Ye,{items:$,expandedIds:x,onExpandedChange:C,checkedIds:A,onCheckedChange:L,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:o,expanded:a,hasChildren:f,toggle:K,checkbox:se})=>z("div",{className:"edit-role-and-permission__tree-node",children:[f&&e("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:K,"aria-label":a?`Collapse ${o.label}`:`Expand ${o.label}`,children:a?"âˆ’":"+"}),se&&se(),e("span",{className:"edit-role-and-permission__tree-label",children:o.label})]})}):e("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),z("div",{className:"edit-role-and-permission__actions",children:[e(X,{type:"button",variant:"secondary",onClick:k,disabled:n||v,children:d.cancel}),e(X,{type:"submit",variant:"primary",disabled:n||v,children:n||v?d.saving:d.saveRole})]})]}),(n||v)&&z("div",{className:"edit-role-and-permission__loading-overlay",children:[e(_e,{size:"large"}),e("div",{className:"edit-role-and-permission__loading-text",children:d.saving})]})]})},Ze=m=>{const c=[],i=(n,h)=>{c.push({id:n.id,parentId:h||null,label:n.text}),n.children&&[...n.children].sort((w,N)=>w.sortOrder-N.sortOrder).forEach(w=>{i(w,n.id)})};return[...m].sort((n,h)=>n.sortOrder-h.sortOrder).forEach(n=>i(n)),c},Je=({isOpen:m,hasUsers:c=!1,onConfirm:i,onCancel:u})=>{const n=ie({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!m)return null;const h=c?n.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":n.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return z(Me,{open:!0,onClose:u,title:e(ge,{children:c?n.cannotDeleteModalTitle||"Cannot Delete Role":n.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[e("div",{className:"delete-role-modal__content",children:e("p",{children:h})}),e("div",{className:"delete-role-modal__actions",children:c?e(X,{variant:"primary",onClick:i,className:"delete-role-modal__ok-btn",children:n.cannotDeleteModalOk||"OK"}):z(ge,{children:[e(X,{variant:"secondary",onClick:u,className:"delete-role-modal__cancel-btn",children:n.deleteModalCancel||"Cancel"}),e(X,{variant:"primary",onClick:i,className:"delete-role-modal__confirm-btn",children:n.deleteModalConfirm||"Delete"})]})})]})},Qe=()=>{const[m,c]=_(null),[i,u]=_(!0),[n,h]=_(null),k=re(!1),w=re(!1),N=P(async()=>{var y,d;if(!k.current){k.current=!0,u(!0),h(null);try{const{roleResponse:p}=await $e(),U=(d=(y=p==null?void 0:p.data)==null?void 0:y.customer)==null?void 0:d.role,j=Oe(U);c(j)}catch(p){console.error("Failed to fetch user permissions:",p),h(p)}finally{u(!1),k.current=!1}}},[]);return ee(()=>{w.current||(w.current=!0,N())},[N]),be(N,{eager:!0}),{permissions:m,loading:i,error:n,refetch:N}},ys=({className:m,withHeader:c=!1})=>{const i=ie({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:u,handleSetInLineAlert:n}=Ve(),{permissions:h,loading:k,error:w}=Qe(),N=(h==null?void 0:h.canViewRoles)??!1,y=(h==null?void 0:h.canManageRoles)??!1,d=N||y,{roles:p,aclResources:U,isLoading:j,isCreating:H,isUpdating:S,error:I,createRole:l,updateRole:b,deleteRole:v,clearError:G,refresh:$}=je(oe,d,!0),[F,x]=_(!1),[C,A]=_(!1),[L,M]=_(null),[V,r]=_(1),[B,T]=_(oe),[q,J]=_(null),[W,s]=_(null);ee(()=>()=>{I&&G(),s(null)},[I,G]);const[t,E]=_(0);be(()=>{r(1),C&&(A(!1),M(null)),J(null),G(),E(R=>R+1)},{eager:!0}),ee(()=>{F&&!k&&!y&&(x(!1),s(null))},[F,k,y]),ee(()=>{t!==0&&(k||d&&$())},[t,d,$,k]);const D=p.length,g=(V-1)*B,o=g+B,a=p.slice(g,o);if(k&&!F&&!C)return e("div",{className:"roles-and-permissions-container","data-testid":"rolesAndPermissionsLoader",children:e("div",{children:"Loading..."})});if(w&&!F&&!C)return e("div",{className:"roles-and-permissions-container",children:e(ye,{variant:"secondary",className:"roles-and-permissions-error",children:e("div",{className:"roles-and-permissions-error__wrapper",children:e("div",{className:"roles-and-permissions-error__content",children:e(Ne,{heading:i.errorTitle||"Error Loading Permissions",message:e("p",{children:i.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})})});if(!d&&!F&&!C)return e("div",{className:"roles-and-permissions-container",children:e(ye,{variant:"secondary",className:"roles-and-permissions-no-access",children:e("div",{className:"roles-and-permissions-no-access__wrapper",children:e("div",{className:"roles-and-permissions-no-access__content",children:e(Ne,{heading:i.noAccessTitle||"Access Restricted",message:e("p",{children:i.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})})});const f=R=>{r(R)},K=R=>{T(R),r(1)},se=()=>{s(null),x(!0)},ne=()=>{s(null),x(!1)},le=R=>{M(R),A(!0)},ae=()=>{A(!1),M(null)},ce=R=>{const Z=p.find(te=>te.id===R);Z&&(s({name:`${Z.name} - Duplicated`,permissions:Z.permissions||[]}),x(!0))},pe=async R=>{try{if(await l({name:R.name,permissions:R.permissions})){const te=i.createSuccess?i.createSuccess.replace("{roleName}",R.name):`Role "${R.name}" created successfully!`;n({type:"success",text:te}),ne()}else n({type:"error",text:i.createError||"Failed to create role. Please try again."})}catch{n({type:"error",text:i.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},O=async R=>{if(L)try{if(await b({id:L,name:R.name,permissions:R.permissions})){const te=i.updateSuccess?i.updateSuccess.replace("{roleName}",R.name):`Role "${R.name}" updated successfully!`;n({type:"success",text:te}),ae()}else n({type:"error",text:i.updateError||"Failed to update role. Please try again."})}catch{n({type:"error",text:i.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},Y=R=>{const Z=p.find(Te=>Te.id===R);if(!Z)return;const te=Z.usersCount>0;J({id:R,name:Z.name,hasUsers:te})},Q=async()=>{if(q){if(q.hasUsers){J(null);return}try{if(await v(q.id)){const Z=i.deleteRoleSuccess?i.deleteRoleSuccess.replace("{roleName}",q.name||"Unknown Role"):`You have deleted role "${q.name||"Unknown Role"}".`;n({type:"success",text:Z})}else n({type:"error",text:i.deleteError||"Failed to delete role. Please try again."})}catch{n({type:"error",text:i.deleteError||"Failed to delete role. Please try again."})}finally{J(null)}}},Pe=()=>J(null);return e("div",{className:"roles-and-permissions-container",children:z("div",{className:me(["roles-and-permissions",m]),children:[c?e(de,{title:i.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,I&&e(ue,{type:"error",heading:i.errorTitle||"Error",description:i.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:G}),u&&u.text&&e(ue,{type:u.type||"success",heading:u.text,icon:u.icon}),F?e(Ae,{mode:"create",aclResources:U,existingRoleNames:p.map(R=>R.name),loading:H,onSubmit:pe,onCancel:()=>{s(null),ne()},inLineAlertProps:I?{type:"error",text:I}:void 0,prefillName:W==null?void 0:W.name,prefillPermissions:W==null?void 0:W.permissions},"create-role-form"):C&&L?e(Ae,{mode:"edit",role:p.find(R=>R.id===L),aclResources:U,existingRoleNames:p.map(R=>R.name),loading:S,onSubmit:O,onCancel:ae,inLineAlertProps:I?{type:"error",text:I}:void 0},`edit-role-form-${L}`):e(Ke,{roles:a,isLoading:j,canManageRoles:y,onShowCreateForm:se,onShowEditForm:le,onDuplicateRole:ce,onDeleteRole:Y,totalCount:D,currentPage:V,pageSize:B,onPageChange:f,onPageSizeChange:K}),e(Je,{isOpen:!!q,hasUsers:q==null?void 0:q.hasUsers,onConfirm:Q,onCancel:Pe})]})})};export{ys as RolesAndPermissions,ys as default};
//# sourceMappingURL=RolesAndPermissions.js.map
