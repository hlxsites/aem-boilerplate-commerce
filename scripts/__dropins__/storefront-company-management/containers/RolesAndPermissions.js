/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as b,Fragment as ce}from"@dropins/tools/preact-jsx-runtime.js";import{useCallback as L,useMemo as Te,useState as y,useRef as Z,useEffect as X}from"@dropins/tools/preact-hooks.js";import{classes as he}from"@dropins/tools/lib.js";import{Button as E,Picker as _e,Card as ae,Header as ee,InLineAlert as se,Field as Ee,Input as Pe,ProgressSpinner as de,Modal as we,IllustratedMessage as me}from"@dropins/tools/components.js";import{D as ne,u as xe}from"../chunks/useCompanyRoles.js";import{f as ue,b as Se}from"../chunks/company-permissions.js";import{u as fe}from"../chunks/useCompanyContextListener.js";import{f as Ie}from"../chunks/fetchUserPermissions.js";import{u as ke}from"../chunks/useInLineAlert.js";import{T as Me}from"../chunks/Tree.js";import{i as De}from"../chunks/isCompanyRoleNameAvailable.js";import{useText as re}from"@dropins/tools/i18n.js";import{T as Fe}from"../chunks/Table.js";import"@dropins/tools/event-bus.js";import"../chunks/fetch-error.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/preact-compat.js";import"@dropins/tools/preact.js";const Le=c=>{try{if(/^\d+$/.test(c))return c;const r=atob(c).match(/(\d+)$/);return r?r[1]:c}catch(t){return console.warn("Failed to decode role ID:",c,t),c}},Oe=({className:c,roles:t,isLoading:r,canManageRoles:m=!1,onShowCreateForm:n,onShowEditForm:f,onDuplicateRole:C,onDeleteRole:R,totalCount:N=t.length,currentPage:u=1,pageSize:i=ne,onPageChange:d,onPageSizeChange:S,children:M,...O})=>{const A=re({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage"}),I=[{key:"id",label:A.columnId||"ID"},{key:"name",label:A.columnRole||"Role"},{key:"usersCount",label:A.columnUsers||"Users"},{key:"actions",label:A.columnActions||"Actions"}],Y=L(s=>m&&s.id!=="0",[m]),q=L(s=>m&&s.id!=="0",[m]),P=L(s=>m&&s.id!=="0"&&N>1,[m,N]),D=L(s=>{const g=[];return Y(s)&&g.push(e(E,{variant:"tertiary",size:"medium",onClick:()=>f(s.id),className:"role-action-button",children:A.editButton||"Edit"},"edit")),q(s)&&C&&g.push(e(E,{variant:"tertiary",size:"medium",onClick:()=>C(s.id),className:"role-action-button",children:A.duplicateButton||"Duplicate"},"duplicate")),P(s)&&R&&g.push(e(E,{variant:"tertiary",size:"medium",onClick:()=>R(s.id),className:"role-action-button",children:A.deleteButton||"Delete"},"delete")),g.length===0?m?e("span",{className:"no-actions",children:A.systemRoleLabel||"System Role"}):null:e("div",{className:"role-actions-container",children:g.map((p,_)=>b("span",{className:"role-action-wrapper",children:[_>0&&e("span",{className:"separator",children:"|"}),p]},_))})},[Y,q,P,f,C,R,A,m]),U=Te(()=>t.map(s=>({id:Le(s.id),name:s.name,usersCount:s.usersCount,actions:e("div",{className:"roles-actions",children:D(s)})})),[t,D]),F=[ne,30,50,100,200].map(s=>({value:s.toString(),label:s.toString(),text:s.toString()})),v=Math.ceil(N/i),k=u<v,B=u>1,w=(u-1)*i,T=w+i,H=L(()=>{const s=[];if(v<=7)for(let p=1;p<=v;p++)s.push(p);else if(s.push(1),u<=3){for(let p=2;p<=5;p++)s.push(p);s.push("ellipsis-end"),s.push(v)}else if(u>=v-2){s.push("ellipsis-start");for(let p=v-4;p<=v;p++)s.push(p)}else{s.push("ellipsis-start");for(let p=u-1;p<=u+1;p++)s.push(p);s.push("ellipsis-end"),s.push(v)}return s},[u,v]);return b("div",{...O,className:he(["company-management-role-and-permission-table",c]),"data-testid":"role-and-permission-table",children:[e("div",{className:"roles-table-container",children:e(Fe,{columns:I,rowData:U,mobileLayout:"stacked",loading:r,skeletonRowCount:10})}),b("div",{className:"table-footer",children:[e("div",{className:"table-footer-left",children:b("span",{className:"item-count",children:["Items ",w+1," to ",Math.min(T,N)," of ",N," total"]})}),v>1&&e("div",{className:"table-footer-center",children:b("div",{className:"page-navigation",children:[e(E,{variant:"tertiary",size:"medium",onClick:()=>d==null?void 0:d(u-1),disabled:!B,className:"page-nav-button",children:"<"}),H().map(s=>typeof s=="string"?e("span",{className:"page-ellipsis",children:"..."},s):e(E,{variant:"tertiary",size:"medium",onClick:()=>d==null?void 0:d(s),disabled:s===u,className:s===u?"page-num-button active":"page-num-button",children:s},s)),e(E,{variant:"tertiary",size:"medium",onClick:()=>d==null?void 0:d(u+1),disabled:!k,className:"page-nav-button",children:">"})]})}),e("div",{className:"table-footer-right",children:b("div",{className:"pagination-controls",children:[e("span",{className:"pagination-label",children:A.show||"Show"}),e(_e,{value:i.toString(),onChange:s=>{const g=s.target;S==null||S(parseInt(g.value,10))},options:F,className:"page-size-picker"}),e("span",{className:"pagination-label",children:A.perPage||"per page"})]})})]}),m&&e("div",{className:"add-role-section",children:e(E,{variant:"primary",onClick:n,children:A.addNewRole||"Add New Role"})}),M]})},Ue={MAX_LENGTH:40},oe=c=>(typeof c=="string"?c:String(c||"")).trim().slice(0,Ue.MAX_LENGTH),pe=({mode:c,role:t,aclResources:r,existingRoleNames:m=[],loading:n=!1,onSubmit:f,onCancel:C,inLineAlertProps:R,prefillName:N,prefillPermissions:u})=>{const i=re({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[d,S]=y({name:(t==null?void 0:t.name)||""}),[M,O]=y({}),[A,I]=y({}),[Y,q]=y(!1),[P,D]=y(!1),[U,F]=y([]),[v,k]=y(new Set),[B,w]=y(new Set),T=Z(null),H=Z(""),s=Z(!1);X(()=>{if(!s.current){if(s.current=!0,c==="edit"&&t){if(S({name:t.name}),t.permissions&&t.permissions.length>0){const o=ue(t.permissions);w(new Set(o))}}else if(c==="create")if(S({name:N??""}),u&&u.length>0){const a=ue(u);w(new Set(a))}else w(new Set)}},[c,t,N,u]),X(()=>{if(r.length>0){const o=Be(r);F(o);const a=o.filter(h=>!h.parentId).map(h=>h.id);k(new Set(a))}},[r]),X(()=>()=>{T.current&&clearTimeout(T.current)},[]);const g=L(o=>{const a=oe(o);return a?(c==="edit"&&t?m.filter($=>$!==t.name):m).includes(a)?i.roleNameExists:null:i.roleNameRequired||"This is a required field."},[c,t,m,i.roleNameRequired,i.roleNameExists]),p=L(async o=>{const a=oe(o),h=g(a);if(h)return h;if(c==="edit"&&t&&a===t.name)return null;try{return q(!0),await De({name:a})?null:i.roleNameExists}catch($){return console.error("Role name validation failed:",$),null}finally{q(!1)}},[c,t,i.roleNameExists,g]),_=L(o=>{T.current!==null&&clearTimeout(T.current),o!==H.current&&(T.current=window.setTimeout(async()=>{const a=await p(o);O(a?h=>({...h,name:a}):h=>({...h,name:""})),H.current=o},500))},[p]),G=()=>{const o={};let a=!0;const h=g(d.name);return h&&(o.name=h,a=!1),O(o),a},V=o=>{const a=typeof o=="string"?o:o.target.value;S(h=>({...h,name:a})),M.name&&O(h=>({...h,name:""})),_(a)},z=()=>{I(o=>({...o,name:!0})),T.current&&(clearTimeout(T.current),T.current=null)},J=()=>{const o=new Set(U.map(a=>a.id));k(o)},te=()=>{k(new Set)},ie=async o=>{if(o.preventDefault(),!P&&(I({name:!0}),!!G()&&!M.name)){D(!0);try{const a={name:oe(d.name),permissions:Array.from(B)};f&&await f(a)}catch(a){console.error("Form submission failed:",a)}finally{D(!1)}}},Q=c==="create"?i.createTitle:i.editTitle;return b(ae,{variant:"secondary",className:"edit-role-and-permission",children:[e(ee,{level:2,size:"large",title:Q,divider:!1,className:"edit-role-and-permission__title"}),(R==null?void 0:R.text)&&e(se,{className:"edit-role-and-permission__notification",type:R.type,variant:"secondary",heading:R.text,"data-testid":"editRoleInLineAlert"}),b("form",{className:"edit-role-and-permission-form",onSubmit:ie,children:[b("div",{className:"edit-role-and-permission__section",children:[e(ee,{level:3,size:"medium",title:i.roleInformation||"Role Information",divider:!1,className:"edit-role-and-permission__section-title"}),e(Ee,{label:i.roleName||"Role Name",required:!0,error:A.name&&M.name?M.name:void 0,children:e(Pe,{type:"text",name:"roleName",value:d.name,onChange:V,onBlur:z,disabled:n||P,"data-testid":"roleNameInput",placeholder:i.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),Y&&e("div",{className:"edit-role-and-permission__validation-spinner",children:e(de,{size:"medium"})})]}),b("div",{className:"edit-role-and-permission__section",children:[e(ee,{level:3,size:"medium",title:i.rolePermissions,divider:!1,className:"edit-role-and-permission__section-title"}),e(se,{type:"info",variant:"secondary",heading:i.permissionsDescription,className:"edit-role-and-permission__permissions-description"}),b("div",{className:"edit-role-and-permission__tree-controls",children:[e(E,{type:"button",variant:"tertiary",onClick:J,disabled:n||P,children:i.expandAll}),e(E,{type:"button",variant:"tertiary",onClick:te,disabled:n||P,children:i.collapseAll})]}),e("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":i.rolePermissions,children:U.length>0?e(Me,{items:U,expandedIds:v,onExpandedChange:k,checkedIds:B,onCheckedChange:w,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:o,expanded:a,hasChildren:h,toggle:$,checkbox:W})=>b("div",{className:"edit-role-and-permission__tree-node",children:[h?e("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:K=>{K.preventDefault(),K.stopPropagation(),$()},"aria-label":a?`Collapse ${o.label}`:`Expand ${o.label}`,children:a?"−":"+"}):e("span",{className:"edit-role-and-permission__tree-spacer"}),W&&W(),e("span",{className:"edit-role-and-permission__tree-label",children:o.label})]})}):e("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),b("div",{className:"edit-role-and-permission__actions",children:[e(E,{type:"button",variant:"secondary",onClick:C,disabled:n||P,children:i.cancel}),e(E,{type:"submit",variant:"primary",disabled:n||P,children:n||P?i.saving:i.saveRole})]})]}),(n||P)&&b("div",{className:"edit-role-and-permission__loading-overlay",children:[e(de,{size:"large"}),e("div",{className:"edit-role-and-permission__loading-text",children:i.saving})]})]})},Be=c=>{const t=[],r=(n,f)=>{t.push({id:n.id,parentId:f||null,label:n.text}),n.children&&[...n.children].sort((R,N)=>R.sortOrder-N.sortOrder).forEach(R=>{r(R,n.id)})};return[...c].sort((n,f)=>n.sortOrder-f.sortOrder).forEach(n=>r(n)),t},Ve=({isOpen:c,hasUsers:t=!1,onConfirm:r,onCancel:m})=>{const n=re({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!c)return null;const f=t?n.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":n.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return b(we,{open:!0,onClose:m,title:e(ce,{children:t?n.cannotDeleteModalTitle||"Cannot Delete Role":n.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[e("div",{className:"delete-role-modal__content",children:e("p",{children:f})}),e("div",{className:"delete-role-modal__actions",children:t?e(E,{variant:"primary",onClick:r,className:"delete-role-modal__ok-btn",children:n.cannotDeleteModalOk||"OK"}):b(ce,{children:[e(E,{variant:"secondary",onClick:m,className:"delete-role-modal__cancel-btn",children:n.deleteModalCancel||"Cancel"}),e(E,{variant:"primary",onClick:r,className:"delete-role-modal__confirm-btn",children:n.deleteModalConfirm||"Delete"})]})})]})},ze=()=>{const[c,t]=y(null),[r,m]=y(!0),[n,f]=y(null),C=Z(!1),R=Z(!1),N=L(async()=>{var u,i;if(!C.current){C.current=!0,m(!0),f(null);try{const{roleResponse:d}=await Ie(),S=(i=(u=d==null?void 0:d.data)==null?void 0:u.customer)==null?void 0:i.role,M=Se(S);t(M)}catch(d){console.error("Failed to fetch user permissions:",d),f(d)}finally{m(!1),C.current=!1}}},[]);return X(()=>{R.current||(R.current=!0,N())},[N]),fe(N,{eager:!0}),{permissions:c,loading:r,error:n,refetch:N}},as=({className:c,withHeader:t=!1})=>{const r=re({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:m,handleSetInLineAlert:n}=ke(),{permissions:f,loading:C,error:R}=ze(),N=(f==null?void 0:f.canViewRoles)??!1,u=(f==null?void 0:f.canManageRoles)??!1,i=N||u,{roles:d,aclResources:S,isLoading:M,isCreating:O,isUpdating:A,error:I,createRole:Y,updateRole:q,deleteRole:P,clearError:D,refresh:U}=xe(ne,i,!0),[F,v]=y(!1),[k,B]=y(!1),[w,T]=y(null),[H,s]=y(1),[g,p]=y(ne),[_,G]=y(null),[V,z]=y(null);X(()=>()=>{I&&D(),z(null)},[I,D]);const[J,te]=y(0);fe(()=>{s(1),k&&(B(!1),T(null)),G(null),D(),te(l=>l+1)},{eager:!0}),X(()=>{F&&!C&&!u&&(v(!1),z(null))},[F,C,u]),X(()=>{J!==0&&(C||i&&U())},[J,i,U,C]);const ie=d.length,Q=(H-1)*g,o=Q+g,a=d.slice(Q,o);if(C&&!F&&!k)return e("div",{className:"roles-and-permissions-container","data-testid":"rolesAndPermissionsLoader",children:e("div",{children:"Loading..."})});if(R&&!F&&!k)return e("div",{className:"roles-and-permissions-container",children:e(ae,{variant:"secondary",className:"roles-and-permissions-error",children:e("div",{className:"roles-and-permissions-error__wrapper",children:e("div",{className:"roles-and-permissions-error__content",children:e(me,{heading:r.errorTitle||"Error Loading Permissions",message:e("p",{children:r.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})})});if(!i&&!F&&!k)return e("div",{className:"roles-and-permissions-container",children:e(ae,{variant:"secondary",className:"roles-and-permissions-no-access",children:e("div",{className:"roles-and-permissions-no-access__wrapper",children:e("div",{className:"roles-and-permissions-no-access__content",children:e(me,{heading:r.noAccessTitle||"Access Restricted",message:e("p",{children:r.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})})});const h=l=>{s(l)},$=l=>{p(l),s(1)},W=()=>{z(null),v(!0)},K=()=>{z(null),v(!1)},ye=l=>{T(l),B(!0)},le=()=>{B(!1),T(null)},Re=l=>{const x=d.find(j=>j.id===l);x&&(z({name:`${x.name} - Duplicated`,permissions:x.permissions||[]}),v(!0))},Ne=async l=>{try{if(await Y({name:l.name,permissions:l.permissions})){const j=r.createSuccess?r.createSuccess.replace("{roleName}",l.name):`Role "${l.name}" created successfully!`;n({type:"success",text:j}),K()}else n({type:"error",text:r.createError||"Failed to create role. Please try again."})}catch{n({type:"error",text:r.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},ve=async l=>{if(w)try{if(await q({id:w,name:l.name,permissions:l.permissions})){const j=r.updateSuccess?r.updateSuccess.replace("{roleName}",l.name):`Role "${l.name}" updated successfully!`;n({type:"success",text:j}),le()}else n({type:"error",text:r.updateError||"Failed to update role. Please try again."})}catch{n({type:"error",text:r.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},be=l=>{const x=d.find(ge=>ge.id===l);if(!x)return;const j=x.usersCount>0;G({id:l,name:x.name,hasUsers:j})},Ce=async()=>{if(_){if(_.hasUsers){G(null);return}try{if(await P(_.id)){const x=r.deleteRoleSuccess?r.deleteRoleSuccess.replace("{roleName}",_.name||"Unknown Role"):`You have deleted role "${_.name||"Unknown Role"}".`;n({type:"success",text:x})}else n({type:"error",text:r.deleteError||"Failed to delete role. Please try again."})}catch{n({type:"error",text:r.deleteError||"Failed to delete role. Please try again."})}finally{G(null)}}},Ae=()=>G(null);return e("div",{className:"roles-and-permissions-container",children:b("div",{className:he(["roles-and-permissions",c]),children:[t?e(ee,{title:r.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,I&&e(se,{type:"error",heading:r.errorTitle||"Error",description:r.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:D}),m&&m.text&&e(se,{type:m.type||"success",heading:m.text,icon:m.icon}),F?e(pe,{mode:"create",aclResources:S,existingRoleNames:d.map(l=>l.name),loading:O,onSubmit:Ne,onCancel:()=>{z(null),K()},inLineAlertProps:I?{type:"error",text:I}:void 0,prefillName:V==null?void 0:V.name,prefillPermissions:V==null?void 0:V.permissions},"create-role-form"):k&&w?e(pe,{mode:"edit",role:d.find(l=>l.id===w),aclResources:S,existingRoleNames:d.map(l=>l.name),loading:A,onSubmit:ve,onCancel:le,inLineAlertProps:I?{type:"error",text:I}:void 0},`edit-role-form-${w}`):e(Oe,{roles:a,isLoading:M,canManageRoles:u,onShowCreateForm:W,onShowEditForm:ye,onDuplicateRole:Re,onDeleteRole:be,totalCount:ie,currentPage:H,pageSize:g,onPageChange:h,onPageSizeChange:$}),e(Ve,{isOpen:!!_,hasUsers:_==null?void 0:_.hasUsers,onConfirm:Ce,onCancel:Ae})]})})};export{as as RolesAndPermissions,as as default};
//# sourceMappingURL=RolesAndPermissions.js.map
