/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as y,Fragment as oe}from"@dropins/tools/preact-jsx-runtime.js";import{useCallback as z,useMemo as ve,useState as C,useRef as ae,useEffect as X}from"@dropins/tools/preact-hooks.js";import{classes as me}from"@dropins/tools/lib.js";import{Button as E,Picker as Ae,Card as ne,Header as ue,InLineAlert as te,Field as be,Input as ge,ProgressSpinner as ie,Modal as Pe,IllustratedMessage as le}from"@dropins/tools/components.js";import{D as Y,u as Te}from"../chunks/useCompanyRoles.js";import{T as Ee,u as _e}from"../chunks/useUserPermissions.js";import{u as we}from"../chunks/useInLineAlert.js";import{u as Se}from"../chunks/useCompanyContextListener.js";import{T as xe}from"../chunks/Tree.js";import{a as de}from"../chunks/company-permissions.js";import{i as Ie}from"../chunks/isCompanyRoleNameAvailable.js";import{useText as K}from"@dropins/tools/i18n.js";import"@dropins/tools/preact.js";import"../chunks/fetchUserPermissions.js";import"../chunks/fetch-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/preact-compat.js";const Me=l=>{try{if(/^\d+$/.test(l))return l;const t=atob(l).match(/(\d+)$/);return t?t[1]:l}catch(r){return console.warn("Failed to decode role ID:",l,r),l}},ke=({className:l,roles:r,isLoading:t,canManageRoles:m=!1,onShowCreateForm:s,onShowEditForm:u,onDuplicateRole:F,onDeleteRole:N,totalCount:p=r.length,currentPage:v=1,pageSize:d=Y,onPageChange:b,onPageSizeChange:M,children:g,..._})=>{const f=K({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage"}),H=[{key:"id",label:f.columnId||"ID"},{key:"name",label:f.columnRole||"Role"},{key:"usersCount",label:f.columnUsers||"Users"},{key:"actions",label:f.columnActions||"Actions"}],x=z(n=>m&&n.id!=="0",[m]),$=z(n=>m&&n.id!=="0",[m]),A=z(n=>m&&n.id!=="0"&&p>1,[m,p]),L=z(n=>{const h=[];return x(n)&&h.push(e(E,{variant:"tertiary",size:"medium",onClick:()=>u(n.id),className:"role-action-button",children:f.editButton||"Edit"},"edit")),$(n)&&F&&h.push(e(E,{variant:"tertiary",size:"medium",onClick:()=>F(n.id),className:"role-action-button",children:f.duplicateButton||"Duplicate"},"duplicate")),A(n)&&N&&h.push(e(E,{variant:"tertiary",size:"medium",onClick:()=>N(n.id),className:"role-action-button",children:f.deleteButton||"Delete"},"delete")),h.length===0?m?e("span",{className:"no-actions",children:f.systemRoleLabel||"System Role"}):null:e("div",{className:"role-actions-container",children:h.map((P,I)=>y("span",{className:"role-action-wrapper",children:[I>0&&e("span",{className:"separator",children:"|"}),P]},I))})},[x,$,A,u,F,N,f,m]),k=ve(()=>r.map(n=>({id:Me(n.id),name:n.name,usersCount:n.usersCount,actions:e("div",{className:"roles-actions",children:L(n)})})),[r,L]),O=[Y,30,50,100,200].map(n=>({value:n.toString(),label:n.toString(),text:n.toString()})),U=Math.ceil(p/d),D=v<U,B=v>1,w=(v-1)*d,S=w+d;return y("div",{..._,className:me(["company-management-role-and-permission-table",l]),"data-testid":"role-and-permission-table",children:[e("div",{className:"roles-table-container",children:e(Ee,{columns:H,rowData:k,mobileLayout:"none",loading:t,skeletonRowCount:10})}),y("div",{className:"table-footer",children:[e("div",{className:"table-footer-left",children:y("span",{className:"item-count",children:["Items ",w+1," to ",Math.min(S,p)," of ",p," total"]})}),U>1&&e("div",{className:"table-footer-center",children:y("div",{className:"page-navigation",children:[e(E,{variant:"tertiary",size:"medium",onClick:()=>b==null?void 0:b(v-1),disabled:!B,className:"page-nav-button",children:"<"}),e("span",{className:"page-info",children:v}),e(E,{variant:"tertiary",size:"medium",onClick:()=>b==null?void 0:b(v+1),disabled:!D,className:"page-nav-button",children:">"})]})}),e("div",{className:"table-footer-right",children:y("div",{className:"pagination-controls",children:[e("span",{className:"pagination-label",children:f.show||"Show"}),e(Ae,{value:d.toString(),onChange:n=>{const h=n.target;M==null||M(parseInt(h.value,10))},options:O,className:"page-size-picker",placeholder:"Select page size"}),e("span",{className:"pagination-label",children:f.perPage||"per page"})]})})]}),m&&e("div",{className:"add-role-section",children:e(E,{variant:"primary",onClick:s,children:f.addNewRole||"Add New Role"})}),g]})},De={MAX_LENGTH:40},se=l=>(typeof l=="string"?l:String(l||"")).trim().slice(0,De.MAX_LENGTH),ce=({mode:l,role:r,aclResources:t,existingRoleNames:m=[],loading:s=!1,onSubmit:u,onCancel:F,inLineAlertProps:N,prefillName:p,prefillPermissions:v})=>{const d=K({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[b,M]=C({name:(r==null?void 0:r.name)||""}),[g,_]=C({}),[f,H]=C({}),[x,$]=C(!1),[A,L]=C(!1),[k,O]=C([]),[U,D]=C(new Set),[B,w]=C(new Set),S=ae(null),n=ae("");X(()=>{if(l==="edit"&&r){if(M({name:r.name}),r.permissions&&r.permissions.length>0){const o=de(r.permissions);w(new Set(o))}}else if(l==="create")if(M({name:p??""}),v&&v.length>0){const a=de(v);w(new Set(a))}else w(new Set)},[l,r,p,v]),X(()=>{if(t.length>0){const o=Fe(t);O(o);const a=o.filter(c=>!c.parentId).map(c=>c.id);D(new Set(a))}},[t]),X(()=>()=>{S.current&&clearTimeout(S.current)},[]);const h=z(o=>{const a=se(o);return a?(l==="edit"&&r?m.filter(R=>R!==r.name):m).includes(a)?d.roleNameExists:null:d.roleNameRequired||"This is a required field."},[l,r,m,d.roleNameRequired,d.roleNameExists]),P=z(async o=>{const a=se(o),c=h(a);if(c)return c;if(l==="edit"&&r&&a===r.name)return null;try{return $(!0),await Ie({name:a})?null:d.roleNameExists}catch(R){return console.error("Role name validation failed:",R),null}finally{$(!1)}},[l,r,d.roleNameExists,h]),I=z(o=>{S.current&&clearTimeout(S.current),o!==n.current&&(S.current=setTimeout(async()=>{const a=await P(o);_(a?c=>({...c,name:a}):c=>({...c,name:""})),n.current=o},500))},[P]),Z=()=>{const o={};let a=!0;const c=h(b.name);return c&&(o.name=c,a=!1),_(o),a},G=o=>{const a=typeof o=="string"?o:o.target.value;M(c=>({...c,name:a})),g.name&&_(c=>({...c,name:""})),I(a)},J=o=>{const c=o.target.value;H(R=>({...R,name:!0})),S.current&&clearTimeout(S.current),P(c).then(R=>{_(R?V=>({...V,name:R}):V=>({...V,name:""})),n.current=c})},Q=()=>{const o=new Set(k.map(a=>a.id));D(o)},j=()=>{D(new Set)},W=async o=>{o.preventDefault(),H({name:!0}),L(!0);try{const a=await P(b.name);if(a){_(R=>({...R,name:a}));return}if(!Z())return;const c={name:se(b.name),permissions:Array.from(B)};u&&await u(c)}catch(a){console.error("Form submission failed:",a)}finally{L(!1)}},ee=l==="create"?d.createTitle:d.editTitle;return y(ne,{variant:"secondary",className:"edit-role-and-permission",children:[e(ue,{title:ee,divider:!1,className:"edit-role-and-permission__title"}),(N==null?void 0:N.text)&&e(te,{className:"edit-role-and-permission__notification",type:N.type,variant:"secondary",heading:N.text,"data-testid":"editRoleInLineAlert"}),y("form",{className:"edit-role-and-permission-form",onSubmit:W,children:[y("div",{className:"edit-role-and-permission__section",children:[e("h3",{className:"edit-role-and-permission__section-title",children:d.roleInformation||"Role Information"}),e(be,{label:d.roleName||"Role Name",required:!0,error:f.name&&g.name?g.name:void 0,children:e(ge,{type:"text",name:"roleName",value:b.name,onChange:G,onBlur:J,disabled:s||A,"data-testid":"roleNameInput",placeholder:d.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),x&&e("div",{className:"edit-role-and-permission__validation-spinner",children:e(ie,{size:"medium"})})]}),y("div",{className:"edit-role-and-permission__section",children:[e("h3",{className:"edit-role-and-permission__section-title",children:d.rolePermissions}),e("p",{className:"edit-role-and-permission__permissions-description",children:d.permissionsDescription}),y("div",{className:"edit-role-and-permission__tree-controls",children:[e(E,{type:"button",variant:"tertiary",onClick:Q,disabled:s||A,children:d.expandAll}),e(E,{type:"button",variant:"tertiary",onClick:j,disabled:s||A,children:d.collapseAll})]}),e("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":d.rolePermissions,children:k.length>0?e(xe,{items:k,expandedIds:U,onExpandedChange:D,checkedIds:B,onCheckedChange:w,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:o,expanded:a,hasChildren:c,toggle:R,checkbox:V})=>y("div",{className:"edit-role-and-permission__tree-node",children:[c&&e("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:R,"aria-label":a?`Collapse ${o.label}`:`Expand ${o.label}`,children:a?"âˆ’":"+"}),V&&V(),e("span",{className:"edit-role-and-permission__tree-label",children:o.label})]})}):e("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),y("div",{className:"edit-role-and-permission__actions",children:[e(E,{type:"button",variant:"secondary",onClick:F,disabled:s||A,children:d.cancel}),e(E,{type:"submit",variant:"primary",disabled:s||A||x,children:s||A?d.saving:d.saveRole})]})]}),(s||A)&&y("div",{className:"edit-role-and-permission__loading-overlay",children:[e(ie,{size:"large"}),e("div",{className:"edit-role-and-permission__loading-text",children:d.saving})]})]})},Fe=l=>{const r=[],t=(s,u)=>{r.push({id:s.id,parentId:u||null,label:s.text}),s.children&&[...s.children].sort((N,p)=>N.sortOrder-p.sortOrder).forEach(N=>{t(N,s.id)})};return[...l].sort((s,u)=>s.sortOrder-u.sortOrder).forEach(s=>t(s)),r},Le=({isOpen:l,hasUsers:r=!1,onConfirm:t,onCancel:m})=>{const s=K({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!l)return null;const u=r?s.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":s.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return y(Pe,{open:!0,onClose:m,title:e(oe,{children:r?s.cannotDeleteModalTitle||"Cannot Delete Role":s.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[e("div",{className:"delete-role-modal__content",children:e("p",{children:u})}),e("div",{className:"delete-role-modal__actions",children:r?e(E,{variant:"primary",onClick:t,className:"delete-role-modal__ok-btn",children:s.cannotDeleteModalOk||"OK"}):y(oe,{children:[e(E,{variant:"secondary",onClick:m,className:"delete-role-modal__cancel-btn",children:s.deleteModalCancel||"Cancel"}),e(E,{variant:"primary",onClick:t,className:"delete-role-modal__confirm-btn",children:s.deleteModalConfirm||"Delete"})]})})]})},ss=({className:l,withHeader:r=!1})=>{const t=K({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:m,handleSetInLineAlert:s}=we(),{permissions:u,loading:F,error:N}=_e(),{roles:p,aclResources:v,isLoading:d,isCreating:b,isUpdating:M,error:g,createRole:_,updateRole:f,deleteRole:H,clearError:x}=Te(Y,!0,!0),[$,A]=C(!1),[L,k]=C(!1),[O,U]=C(null),[D,B]=C(1),[w,S]=C(Y),[n,h]=C(null),[P,I]=C(null);X(()=>()=>{g&&x(),I(null)},[g,x]),Se(()=>{B(1),L&&(k(!1),U(null)),h(null),x()},{eager:!0});const Z=(u==null?void 0:u.canViewRoles)??!1,G=(u==null?void 0:u.canManageRoles)??!1,J=Z||G;if(F)return e("div",{"data-testid":"rolesAndPermissionsLoader",children:e("div",{children:"Loading..."})});if(N)return e(ne,{variant:"secondary",className:"roles-and-permissions-error",children:e("div",{className:"roles-and-permissions-error__wrapper",children:e("div",{className:"roles-and-permissions-error__content",children:e(le,{heading:t.errorTitle||"Error Loading Permissions",message:e("p",{children:t.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})});if(!J)return e(ne,{variant:"secondary",className:"roles-and-permissions-no-access",children:e("div",{className:"roles-and-permissions-no-access__wrapper",children:e("div",{className:"roles-and-permissions-no-access__content",children:e(le,{heading:t.noAccessTitle||"Access Restricted",message:e("p",{children:t.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})});const Q=p.length,j=(D-1)*w,W=j+w,ee=p.slice(j,W),o=i=>{B(i)},a=i=>{S(i),B(1)},c=()=>{I(null),A(!0)},R=()=>{I(null),A(!1)},V=i=>{U(i),k(!0)},re=()=>{k(!1),U(null)},pe=i=>{const T=p.find(q=>q.id===i);T&&(I({name:`${T.name} - Duplicated`,permissions:T.permissions||[]}),A(!0))},he=async i=>{try{if(await _({name:i.name,permissions:i.permissions})){const q=t.createSuccess?t.createSuccess.replace("{roleName}",i.name):`Role "${i.name}" created successfully!`;s({type:"success",text:q}),R()}else s({type:"error",text:t.createError||"Failed to create role. Please try again."})}catch{s({type:"error",text:t.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},ye=async i=>{if(O)try{if(await f({id:O,name:i.name,permissions:i.permissions})){const q=t.updateSuccess?t.updateSuccess.replace("{roleName}",i.name):`Role "${i.name}" updated successfully!`;s({type:"success",text:q}),re()}else s({type:"error",text:t.updateError||"Failed to update role. Please try again."})}catch{s({type:"error",text:t.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},fe=i=>{const T=p.find(Ce=>Ce.id===i);if(!T)return;const q=T.usersCount>0;h({id:i,name:T.name,hasUsers:q})},Re=async()=>{if(n){if(n.hasUsers){h(null);return}try{if(await H(n.id)){const T=t.deleteRoleSuccess?t.deleteRoleSuccess.replace("{roleName}",n.name||"Unknown Role"):`You have deleted role "${n.name||"Unknown Role"}".`;s({type:"success",text:T})}else s({type:"error",text:t.deleteError||"Failed to delete role. Please try again."})}catch{s({type:"error",text:t.deleteError||"Failed to delete role. Please try again."})}finally{h(null)}}},Ne=()=>h(null);return y("div",{className:me(["roles-and-permissions",l]),children:[r?e(ue,{title:t.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,g&&e(te,{type:"error",heading:t.errorTitle||"Error",description:t.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:x}),m&&m.text&&e(te,{type:m.type||"success",heading:m.text,icon:m.icon}),$?e(ce,{mode:"create",aclResources:v,existingRoleNames:p.map(i=>i.name),loading:b,onSubmit:he,onCancel:()=>{I(null),R()},inLineAlertProps:g?{type:"error",text:g}:void 0,prefillName:P==null?void 0:P.name,prefillPermissions:P==null?void 0:P.permissions}):L&&O?e(ce,{mode:"edit",role:p.find(i=>i.id===O),aclResources:v,existingRoleNames:p.map(i=>i.name),loading:M,onSubmit:ye,onCancel:re,inLineAlertProps:g?{type:"error",text:g}:void 0}):e(ke,{roles:ee,isLoading:d,canManageRoles:G,onShowCreateForm:c,onShowEditForm:V,onDuplicateRole:pe,onDeleteRole:fe,totalCount:Q,currentPage:D,pageSize:w,onPageChange:o,onPageSizeChange:a}),e(Le,{isOpen:!!n,hasUsers:n==null?void 0:n.hasUsers,onConfirm:Re,onCancel:Ne})]})};export{ss as RolesAndPermissions,ss as default};
//# sourceMappingURL=RolesAndPermissions.js.map
