/*! Copyright 2025 Adobe
All Rights Reserved. */
import{h as ae,s as ce}from"../chunks/fetch-graphql.js";import{classes as V,VComponent as se,deepmerge as ie,Slot as H}from"@dropins/tools/lib.js";import{events as B}from"@dropins/tools/event-bus.js";import{v as me}from"../chunks/validation.js";import{s as q}from"../chunks/setPaymentMethod.js";import{jsxs as U,jsx as a}from"@dropins/tools/preact-jsx-runtime.js";import{useState as w,useMemo as $,useCallback as P,useEffect as j}from"@dropins/tools/preact-hooks.js";import"../chunks/TermsAndConditions.js";import{Skeleton as de,SkeletonRow as N,IllustratedMessage as ue,Icon as J,InLineAlert as le,ToggleButton as he,RadioButton as pe}from"@dropins/tools/components.js";/* empty css                             */import*as T from"@dropins/tools/preact-compat.js";import{useRef as fe,useEffect as ye}from"@dropins/tools/preact-compat.js";/* empty css                        *//* empty css                  *//* empty css                       *//* empty css                        */import{P as ke}from"../chunks/PurchaseOrder.js";import{P as ge}from"../chunks/PaymentOnAccount2.js";import{r as Me}from"../chunks/render.js";import{i as Se}from"../chunks/events.js";import{h as Ce,a as Pe}from"../chunks/events2.js";import{g as b,n as F}from"../chunks/values.js";import{W as ve}from"../chunks/ConditionalWrapper.js";import{s as Ee}from"../chunks/dom.js";import{useText as K}from"@dropins/tools/i18n.js";import"@dropins/tools/signals.js";import"@dropins/tools/fetch-graphql.js";import"../fragments.js";import"../chunks/guards.js";import"../chunks/synchronizeCheckout.js";import"../chunks/transform-shipping-methods.js";import"../chunks/classifiers.js";import"../chunks/getCompanyCredit.js";const _e=e=>T.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},T.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M17.93 14.8V18.75H5.97C4.75 18.75 3.75 17.97 3.75 17V6.5M3.75 6.5C3.75 5.53 4.74 4.75 5.97 4.75H15.94V8.25H5.97C4.75 8.25 3.75 7.47 3.75 6.5Z",stroke:"currentColor",strokeWidth:1,strokeLinecap:"round",strokeLinejoin:"round"}),T.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M19.35 11.64H14.04V14.81H19.35V11.64Z",stroke:"currentColor",strokeWidth:1,strokeLinecap:"round",strokeLinejoin:"round"}),T.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M17.9304 11.64V8.25H15.1504",stroke:"currentColor",strokeWidth:1,strokeLinecap:"round",strokeLinejoin:"round"})),we=()=>U(de,{"data-testid":"payment-methods-skeleton",children:[a(N,{size:"medium",variant:"heading"}),a(N,{size:"medium",variant:"empty"}),a(N,{fullWidth:!0,size:"xlarge"}),a(N,{fullWidth:!0,size:"xlarge"})]}),Ne=({UIComponentType:e="ToggleButton",busy:r,code:o,icon:m,onSelectionChange:n,selected:c,title:u})=>{const l={busy:r,className:"checkout-payment-methods__method",label:u,name:"payment-method",onChange:()=>n({code:o,title:u}),value:o};return e==="ToggleButton"?a(he,{...l,icon:m?a(J,{source:m}):void 0,selected:c}):a(pe,{...l,checked:c,icon:m??void 0})},Te=({className:e,error:r=null,busy:o=!1,onDismissError:m,onSelectionChange:n=()=>{},options:c,paymentMethodContent:u,selection:l,title:y,UIComponentType:C})=>{const M=K({EmptyState:"Checkout.PaymentMethods.emptyState"}),d=r!==null,S=fe(null);return ye(()=>{d&&S.current&&Ee(S.current)},[d]),U("div",{className:V(["checkout-payment-methods",e]),"data-testid":"checkout-payment-methods",children:[y&&a(se,{className:"checkout-payment-methods__title",node:y}),!o&&c.length===0&&a(ue,{"data-testid":"checkout-payment-methods-empty",icon:a(J,{source:_e}),message:a("p",{children:M.EmptyState})}),U("div",{className:V(["checkout-payment-methods__wrapper",["checkout-payment-methods__wrapper--busy",o]]),"data-testid":"checkout-payment-methods-wrapper",children:[a("div",{className:V(["checkout-payment-methods__methods",["checkout-payment-methods--full-width",c.length%2!==0]]),children:c==null?void 0:c.map(k=>a(Ne,{UIComponentType:C,busy:o,code:k.code,icon:k.icon,selected:(l==null?void 0:l.code)===k.code,title:k.displayLabel??!0?k.title:"",onSelectionChange:n},k.code))}),u&&a("div",{className:"checkout-payment-methods__content",children:u})]}),d&&a("div",{ref:S,className:"checkout-payment-methods__error","data-testid":"checkout-payment-methods-alert",children:a(le,{heading:r,type:"error",variant:"primary",onDismiss:m})})]})},be=ve(Te,we),Ie=(e,r)=>{let o;return function(...m){clearTimeout(o),o=setTimeout(()=>e.apply(this,m),r)}};var Oe=(e=>(e.PaymentOnAccount="companycredit",e.PurchaseOrder="purchaseorder",e))(Oe||{});const Z={companycredit:{Container:ge,autoSync:!0,formName:"payment-on-account",validateRefNumber:!1},purchaseorder:{Container:ke,autoSync:!1,formName:"purchase-order",validateRefNumber:!0}},I=new Map,Le=(e,r)=>{const o=`${e}-${r}`;if(!I.has(o)){const m=Ie(async n=>{if(!r||me(n))try{await q({code:e,purchase_order_number:n})}catch(c){console.error(`Failed to set payment method for ${e}:`,c)}},1e3);I.set(o,m)}return I.get(o)},_={},pt=()=>{Object.keys(_).forEach(e=>{delete _[e]}),I.clear()},G=e=>{if(!(e in Z))throw new Error(`Invalid handler code: ${e}`);if(_[e])return _[e];const r=Z[e],{autoSync:o,Container:m,formName:n,validateRefNumber:c}=r,u={enabled:!0,autoSync:o,render:l=>{var M;const y=String(((M=l.additionalData)==null?void 0:M.purchase_order_number)??""),C=document.createElement("div");Me.render(m,{name:n,initialReferenceNumber:y,onReferenceNumberChange:Le(e,c)})(C),l.replaceHTML(C)}};return _[e]=u,u},Ve={companycredit:G("companycredit"),purchaseorder:G("purchaseorder")};function R(e,r){return e?r.some(o=>o.code===e.code):!1}function Re(e,r){return!e||!r?!1:e.code===r.code}function Ue(e){return e?!!e.code&&!!e.title:!1}const ft=({UIComponentType:e="ToggleButton",active:r=!0,autoSync:o=!0,displayTitle:m=!0,slots:n,onCartSyncError:c,onSelectionChange:u})=>{const[l,y]=w(null),[C,M]=w(!1),[d,S]=w(null),[k,A]=w([]),Q=ae.value,h=$(()=>{const t=(n==null?void 0:n.Methods)??{};return ie(Ve,t)},[n==null?void 0:n.Methods]),X=k.filter(t=>{var s;return((s=h==null?void 0:h[t.code])==null?void 0:s.enabled)!==!1}).map(t=>{const s=(h==null?void 0:h[t.code])||{};return{...t,...s}}),{cartSyncError:W,defaultTitle:x}=K({cartSyncError:"Checkout.PaymentMethods.cartSyncError",defaultTitle:"Checkout.PaymentMethods.title"}),Y=P(t=>{S(i=>i&&{...i,additionalData:t});const s=b("selectedPaymentMethod");s&&F({selectedPaymentMethod:{...s,additionalData:t}})},[]),ee=P(()=>{y(null)},[]),f=P(t=>{y(null),S(t),F({selectedPaymentMethod:t})},[]),v=P(async(t,s)=>{if(!(Se()||Ce()))return;const p=h==null?void 0:h[t.code];((p==null?void 0:p.autoSync)??o)&&q({code:t.code}).catch(g=>{f(s??null),c==null||c({method:t,error:g}),c||y(W)})},[h,o,f,c,W]),te=P(async t=>{const s=b("selectedPaymentMethod");f(t),u==null||u(t),await v(t,s)},[u,f,v]),E=P(t=>{if(!t||t.isEmpty){f(null),A([]);return}const i=t.availablePaymentMethods??[];if(A(i),i.length===0){f(null);return}const p=t.selectedPaymentMethod??null,O=Ue(p),g=b("selectedPaymentMethod"),L=R(g,i),oe=Re(g,p);if(g&&L&&!oe){v(g,p);return}if((!g||!L)&&O&&R(p,i)){f(p);return}if((!g||!L)&&(!O||!R(p,i))){const D=i[0];f(D),v(D)}},[f,v]);j(()=>{if(!r)return;const t=Pe();if(t){M(!0);const i=b("selectedPaymentMethod");i&&S(i),E(t);return}const s=B.on("checkout/initialized",i=>{M(!0),E(i)},{eager:!0});return()=>{s==null||s.off()}},[r,E]),j(()=>{if(!r)return;const t=B.on("checkout/updated",E,{eager:!1});return()=>{t==null||t.off()}},[r,E]);const z=h[(d==null?void 0:d.code)||""],re=z?a(H,{context:{additionalData:d==null?void 0:d.additionalData,cartId:ce.cartId??"",replaceHTML(t){this.replaceWith(t)},setAdditionalData:Y},name:"PaymentMethodContent",slot:z.render},d==null?void 0:d.code):void 0,ne=$(()=>{if(m)return a(H,{name:"checkout-payment-methods-title",slot:n==null?void 0:n.Title,children:a("h2",{children:x})})},[m,n==null?void 0:n.Title,x]);return a(be,{UIComponentType:e,busy:Q,error:l,initialized:C,options:X,paymentMethodContent:re,selection:d,title:ne,visible:r,onDismissError:ee,onSelectionChange:te})};export{Oe as HandlerCode,ft as PaymentMethods,G as createHandler,ft as default,Ve as defaultHandlers,Le as handleRefNumberChange,pt as resetHandlersCache};
//# sourceMappingURL=PaymentMethods.js.map
