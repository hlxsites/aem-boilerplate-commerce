name: Sync with Upstream

on:
  schedule:
    - cron: '0 0 * * 1' # Every Monday at midnight
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: 'Upstream repository (owner/repo)'
        required: false
      upstream_branch:
        description: 'Upstream branch to sync from'
        required: false
      target_branch:
        description: 'Target branch to sync to'
        required: false

env:
  UPSTREAM_REPO: ${{ inputs.upstream_repo || 'hlxsites/aem-boilerplate-commerce' }}
  UPSTREAM_BRANCH: ${{ inputs.upstream_branch || 'main' }}
  TARGET_BRANCH: ${{ inputs.target_branch || 'main' }}

permissions:
  contents: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.TARGET_BRANCH }}

      - name: Sync with upstream
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add upstream remote
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

          # Check if there are new changes
          DIFF=$(git rev-list HEAD..upstream/${{ env.UPSTREAM_BRANCH }} --count)
          if [ "$DIFF" -eq 0 ]; then
            echo "Already up to date with upstream."
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
            exit 0
          fi

          echo "Found $DIFF new commit(s) from upstream."
          echo "HAS_CHANGES=true" >> $GITHUB_ENV

          # Create sync branch
          SYNC_BRANCH="sync/upstream-$(date +%Y%m%d%H%M%S)"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV

          git checkout -b "$SYNC_BRANCH"
          git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit || true

          # Check for merge conflicts
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "::warning::Merge conflicts detected. Please resolve them manually."
            git merge --abort
            git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit --strategy-option theirs
          fi

      - name: Push sync branch
        if: env.HAS_CHANGES == 'true'
        run: git push origin "${{ env.SYNC_BRANCH }}"

      - name: Output PR link
        if: env.HAS_CHANGES == 'true'
        run: |
          REPO="${{ github.repository }}"
          ENCODED_TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('Sync with upstream (${{ env.UPSTREAM_REPO }})'))")
          ENCODED_BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('This PR syncs the latest changes from [${{ env.UPSTREAM_REPO }}](https://github.com/${{ env.UPSTREAM_REPO }}) (${{ env.UPSTREAM_BRANCH }}) into \`${{ env.TARGET_BRANCH }}\`.'))")

          PR_URL="https://github.com/${REPO}/compare/${{ env.TARGET_BRANCH }}...${{ env.SYNC_BRANCH }}?expand=1&title=${ENCODED_TITLE}&body=${ENCODED_BODY}"

          echo ""
          echo "=============================================="
          echo "âœ… Sync branch pushed: ${{ env.SYNC_BRANCH }}"
          echo ""
          echo "ðŸ“ Create a Pull Request:"
          echo "$PR_URL"
          echo "=============================================="

          echo "### ðŸ”„ Upstream Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Sync branch \`${{ env.SYNC_BRANCH }}\` has been pushed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[ðŸ‘‰ Click here to create the Pull Request](${PR_URL})" >> $GITHUB_STEP_SUMMARY
