name: Sync with Upstream

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: 'Upstream repository (owner/repo)'
        required: false
        default: 'adobe/aem-boilerplate'
        type: string
      upstream_branch:
        description: 'Upstream branch to sync from'
        required: false
        default: 'main'
        type: string
      target_branch:
        description: 'Target branch to sync to'
        required: false
        default: 'main'
        type: string

env:
  UPSTREAM_REPO: ${{ github.event.inputs.upstream_repo || 'adobe/aem-boilerplate' }}
  UPSTREAM_BRANCH: ${{ github.event.inputs.upstream_branch || 'main' }}
  TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'main' }}

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    if: github.repository == 'hlxsites/aem-boilerplate-commerce'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ env.TARGET_BRANCH }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git remote -v
      
      - name: Fetch upstream changes
        run: git fetch upstream ${{ env.UPSTREAM_BRANCH }}
      
      - name: Checkout or create sync branch
        run: |
          git checkout sync/upstream 2>/dev/null || git checkout -b sync/upstream
      
      - name: Merge upstream changes
        id: merge
        continue-on-error: true
        run: |
          # Attempt to merge upstream branch
          if git merge upstream/${{ env.UPSTREAM_BRANCH }} --no-edit; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            
            # Get merge details
            COMMITS_AHEAD=$(git rev-list --count origin/${{ env.TARGET_BRANCH }}..HEAD 2>/dev/null || echo "0")
            echo "commits_ahead=$COMMITS_AHEAD" >> $GITHUB_OUTPUT
            
            # Get list of changed files
            CHANGED_FILES=$(git diff --name-only origin/${{ env.TARGET_BRANCH }}..HEAD | head -20)
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Get commit messages
            COMMIT_MESSAGES=$(git log origin/${{ env.TARGET_BRANCH }}..HEAD --oneline --no-decorate | head -10)
            echo "commit_messages<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMIT_MESSAGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            
            # Get conflicting files
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
            echo "conflict_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFLICT_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Abort the merge
            git merge --abort
          fi
      
      - name: Push changes and create PR
        id: create_pr
        if: steps.merge.outputs.merge_status == 'success'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: sync/upstream
          base: ${{ env.TARGET_BRANCH }}
          title: "ðŸ”„ Sync with upstream (${{ env.UPSTREAM_REPO }})"
          body: |
            ## Automated Upstream Sync
            
            This PR synchronizes our fork with the latest changes from [${{ env.UPSTREAM_REPO }}](https://github.com/${{ env.UPSTREAM_REPO }}).
            
            ### ðŸ“Š Summary
            - **Upstream**: `${{ env.UPSTREAM_REPO }}@${{ env.UPSTREAM_BRANCH }}`
            - **Target branch**: `${{ env.TARGET_BRANCH }}`
            - **Commits ahead**: ${{ steps.merge.outputs.commits_ahead }}
            - **Files changed**: See below
            
            ### ðŸ“ Recent Commits
            ```
            ${{ steps.merge.outputs.commit_messages }}
            ```
            
            ### ðŸ“ Changed Files
            ```
            ${{ steps.merge.outputs.changed_files }}
            ```
            
            ### âš ï¸ Review Guidelines
            - Review all changes carefully for compatibility
            - Pay special attention to changes in core files (`scripts/aem.js`, `scripts/scripts.js`)
            - Run tests locally if needed
            - Check for any breaking changes in the commit messages
            
            ---
            *This PR was automatically created by the upstream sync workflow.*
          commit-message: "chore: sync with upstream ${{ env.UPSTREAM_REPO }}"
          delete-branch: false
      
      - name: Generate Summary - Success
        if: steps.merge.outputs.merge_status == 'success' && steps.create_pr.outputs.pull-request-number
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âœ… Upstream Sync Successful
          
          A new pull request has been created to sync with upstream **${{ env.UPSTREAM_REPO }}**.
          
          ## ðŸ“Š Summary
          
          | Metric | Value |
          |--------|-------|
          | **PR Number** | [#${{ steps.create_pr.outputs.pull-request-number }}](${{ steps.create_pr.outputs.pull-request-url }}) |
          | **Upstream** | `${{ env.UPSTREAM_REPO }}@${{ env.UPSTREAM_BRANCH }}` |
          | **Target Branch** | `${{ env.TARGET_BRANCH }}` |
          | **New Commits** | ${{ steps.merge.outputs.commits_ahead }} |
          | **Sync Branch** | `sync/upstream` |
          | **Triggered by** | ${{ github.event_name }} |
          
          ## ðŸ“ Recent Commits
          
          ```
          ${{ steps.merge.outputs.commit_messages }}
          ```
          
          ## ðŸ“ Changed Files
          
          <details>
          <summary>View changed files (${{ steps.merge.outputs.commits_ahead }} commits)</summary>
          
          ```
          ${{ steps.merge.outputs.changed_files }}
          ```
          
          </details>
          
          ## ðŸ”— Actions
          
          - **[Review Pull Request â†’](${{ steps.create_pr.outputs.pull-request-url }})**
          - [View Upstream Repository](https://github.com/${{ env.UPSTREAM_REPO }})
          
          ## âš ï¸ Review Guidelines
          
          - Review all changes carefully for compatibility
          - Pay special attention to changes in core files (`scripts/aem.js`, `scripts/scripts.js`)
          - Run tests locally if needed
          - Check for any breaking changes in the commit messages
          
          ---
          
          ðŸ’¡ **Tip**: Subscribe to this workflow in the GitHub mobile app to receive notifications when syncs complete.
          EOF
      
      - name: Generate Summary - Merge Conflicts
        if: steps.merge.outputs.merge_status == 'conflict'
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # âš ï¸ Upstream Sync - Merge Conflicts Detected
          
          The automated sync with **${{ env.UPSTREAM_REPO }}** detected merge conflicts that require manual resolution.
          
          ## ðŸš¨ Conflicting Files
          
          ```
          ${{ steps.merge.outputs.conflict_files }}
          ```
          
          ## ðŸ”§ Manual Resolution Required
          
          Follow these steps to resolve the conflicts:
          
          ### 1. Checkout the sync branch
          
          ```bash
          git fetch origin
          git checkout sync/upstream
          ```
          
          ### 2. Fetch and merge upstream
          
          ```bash
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream
          git merge upstream/${{ env.UPSTREAM_BRANCH }}
          ```
          
          ### 3. Resolve conflicts
          
          - Open the conflicting files in your editor
          - Resolve the merge conflicts
          - Test your changes locally
          
          ### 4. Commit and push
          
          ```bash
          git add .
          git commit -m "chore: resolve merge conflicts with upstream"
          git push origin sync/upstream
          ```
          
          ### 5. Create a Pull Request
          
          Create a PR from `sync/upstream` to `${{ env.TARGET_BRANCH }}` on GitHub.
          
          ## ðŸ”— Helpful Links
          
          - [View Upstream Repository](https://github.com/${{ env.UPSTREAM_REPO }})
          - [GitHub Conflict Resolution Guide](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/addressing-merge-conflicts/resolving-a-merge-conflict-using-the-command-line)
          
          ---
          
          ðŸ’¡ **Tip**: Check the upstream repository for recent major changes that might explain the conflicts.
          EOF
          
          # Create an error annotation for visibility
          echo "::error title=Merge Conflicts Detected::Upstream sync failed due to merge conflicts in ${{ steps.merge.outputs.conflict_files }}. Manual resolution required."
      
      - name: Generate Summary - No Changes
        if: steps.merge.outputs.merge_status == 'success' && !steps.create_pr.outputs.pull-request-number
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # â„¹ï¸ Upstream Sync - No Changes
          
          Repository is already up to date with **${{ env.UPSTREAM_REPO }}@${{ env.UPSTREAM_BRANCH }}**.
          
          ## Status
          
          âœ… No new changes detected from upstream.
          
          The `sync/upstream` branch is in sync with `upstream/${{ env.UPSTREAM_BRANCH }}`.
          
          ---
          
          Next sync scheduled for next Monday at 9:00 AM UTC.
          EOF
